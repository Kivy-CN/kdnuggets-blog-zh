# 机器学习模型开发和模型操作：原则与实践

> 原文：[https://www.kdnuggets.com/2021/10/machine-learning-model-development-operations-principles-practice.html](https://www.kdnuggets.com/2021/10/machine-learning-model-development-operations-principles-practice.html)

[评论](#comments)

**作者：[Suresh Yaram](https://www.linkedin.com/in/sureshyaram/)，首席解决方案架构师，DXC技术公司**

### 1\. 介绍

* * *

## 我们的前三大课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [谷歌网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速进入网络安全职业生涯。

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [谷歌数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升你的数据分析技能

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [谷歌IT支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持你的组织进行IT工作

* * *

在企业数据分析场景中，机器学习（ML）的使用大幅增加，以从业务数据中提取有价值的见解。因此，拥有一个生态系统来构建、测试、部署和维护企业级机器学习模型在生产环境中至关重要。机器学习模型开发涉及从多个受信任的来源获取数据、处理数据以便于构建模型、选择算法来构建模型、构建模型、计算性能指标并选择表现最佳的模型。模型维护在模型部署到生产环境后扮演着关键角色。机器学习模型的维护包括保持模型的最新和相关，以便与源数据变化保持一致，因为模型有可能随着时间的推移变得过时。此外，随着模型数量的增加，机器学习模型的配置管理在模型管理中也发挥着重要作用。本文着重于原则和行业标准实践，包括用于企业环境中机器学习模型开发、部署和维护的工具和技术。

### 2\. 模型开发

**机器学习（ML）模型生命周期**指的是从源数据识别到模型开发、模型部署和模型维护的整个过程。总体而言，所有活动都属于两个广泛的类别：ML模型开发和ML模型操作。

**机器学习（ML）模型开发**包括一系列步骤，如图1所示。

![图示](../Images/65ad4640976073749d0b838990e29200.png)

**图1：** 机器学习（ML）模型开发生命周期

机器学习模型开发生命周期步骤可以大致分为数据探索、模型构建、模型超参数调优和具有最佳性能的模型选择。

**探索性数据分析**是一个重要的步骤，一旦商业假设准备好后就开始进行。这个步骤占据了总项目时间的40-50%，因为模型结果依赖于输入数据的质量。探索性数据分析包括数据属性识别、数据预处理和特征工程。属性识别涉及识别预测变量/特征变量（输入）和目标/分类变量（输出），以及它们的数据类型（字符串、数值或日期时间），并将特征分类为类别变量和连续变量，这有助于在构建模型时算法对变量施加适当的处理。数据预处理涉及识别缺失值和异常值，通过计算定量属性的均值或中位数以及定性属性的众数来填补这些空白，以提高模型的预测能力。异常值会导致均值和标准差的增加，可以通过取自然对数来消除，这样可以减少极端值引起的变化。

**特征工程**是探索性数据分析中的下一步最重要的环节，在这一环节中，原始数据集会被处理，以将字符串、日期时间或数字类型的数据转换为机器学习算法可以理解的数字向量，从而构建高效的预测模型。此外，标记的分类数据（例如，颜色：红色、绿色、蓝色；表现：差、一般、好、非常好、优秀；风险：低、中、高；状态：开始、进行中、暂停、关闭；性别：男/女；是否批准贷款/是否欺诈索赔：是/否）在机器学习算法中无法以其真实背景被理解，因此需要将其转换为数字数据。特征编码是将分类数据转换为连续（数值）值的广泛使用的技术，例如，将颜色编码为1、2、3；表现编码为1、2、3、4、5；风险编码为1、2、3；状态编码为1、2、3、4；性别/是否批准贷款/是否欺诈索赔编码为0/1等。建议在分类变量没有顺序关系（例如颜色和状态）时使用标签编码，在分类变量有顺序关系（例如表现、风险）时使用顺序编码，以及在分类变量数据是二元性质（例如性别、是否批准贷款、是否欺诈索赔）时使用独热编码。R或Python中提供了一些库来实现这些编码方法。在某些情况下，会创建一组虚拟变量或派生变量，特别是在处理“日期”数据类型时。一旦分类文本数据转换为数字数据，这些数据就可以输入到模型中；最后一步是选择适当的特征，以帮助提高模型的准确性，方法包括单变量选择（统计测量）、特征重要性（模型属性）和相关矩阵（识别哪些特征与目标变量最相关）。这些方法检测变量之间的共线性，即它们高度相关并包含关于给定数据集中的方差的相似信息。可以使用方差膨胀因子（VIF）来检测多重共线性，即在模型中包含三个或更多高度相关的变量。图 2 展示了探索性数据分析中的关键点。

![图像](../Images/d185e9dfbfb0d279fbe7c621987ac415.png)

**图 2:** 探索性数据分析

**构建机器学习模型**需要将数据分成两个集合，例如以 80:20 或 70:30 的比例划分的“训练集”和“测试集”；根据输入数据的性质和预测的业务结果，可以选择一系列监督（针对有标签数据）和无监督（针对无标签数据）算法。如果数据是有标签的，推荐选择逻辑回归算法（当预测结果为二分类（0/1）时）；如果预测结果为多分类（1/2/3/...），可以选择决策树分类器、随机森林® 分类器或 KNN；如果预测结果是连续的，可以选择线性回归算法（例如，决策树回归器、随机森林回归器）。无监督的聚类算法（例如，k-means 聚类）适合分析无标签/非结构化（文本）数据。人工神经网络（ANN）算法建议用于分析其他非结构化（图像/语音）数据类型，例如用于图像识别的卷积神经网络（CNN）和用于语音识别及自然语言处理（NLP）的递归神经网络（RNN）。模型使用训练数据集构建，并使用测试数据集进行预测。深度学习（神经网络）模型通常优于回归模型（机器学习模型），因为这些模型通过引入激活函数（AF）增加了额外的非线性层，从而提供了更好的性能。各种场景下的算法选择已在下图 Fig.3 中表示。

![Figure](../Images/fcbcb5d5eb3c35362f7a46ed449200f8.png)

**图 3:** 选择正确的算法

**模型性能的计算**是选择正确模型的下一个逻辑步骤。模型性能指标将决定最终的模型选择，这包括计算准确率、精确度、召回率、F1 分数（精确度和召回率的加权平均），以及分类模型的混淆矩阵和回归模型的决定系数。对于使用不平衡/偏斜数据集训练的分类模型，不建议使用准确率作为性能衡量标准，而推荐计算精确度和召回率来选择合适的分类模型。

**模型超参数调优** 是过程中的重要步骤，建议继续调优直到模型性能达到约80%-85%。例如，随机森林算法采用最大深度、最大特征数、树的数量等超参数，这些超参数可以直观地调整以提高模型准确性。同样，神经网络算法包括层数、批量大小、训练轮数、样本数量等。建议使用网格搜索方法来找到模型的最佳超参数，从而获得最‘准确’的预测。此外，还推荐进行交叉验证，因为有时模型准确性的提升可能是由于过拟合（过于敏感的模型，无法泛化）或欠拟合（过于泛化的模型），可以使用k折交叉验证技术来验证。为避免过拟合，增加训练数据样本量以引入更多模式，或者减少特征数以避免复杂性，或使用岭回归和套索回归方法进行数据正则化以减少错误/惩罚。同样，为避免欠拟合，增加模型复杂性，如从线性模型转换为非线性模型，或在神经网络中增加更多隐藏层（轮次），或添加更多特征以引入隐藏模式。然而，增加更多数据量并不能解决欠拟合问题，反而会影响模型性能。

最终，选择性能最佳的模型。

**机器学习模型开发最佳实践：** 推荐的机器学习模型开发最佳实践包括（1）在属性识别之前，对识别出的业务问题进行明确的假设；（2）首先使用基本算法，如逻辑回归或决策树来构建模型，并编译性能指标，这样可以在使用更复杂的算法（如神经网络）之前，对数据的相关性有足够的信心；（3）在构建模型时保持中间检查点，以跟踪模型超参数及其相关性能指标，这样可以逐步训练模型，并在性能与训练时间方面做出合理判断；（4）使用真实的生产数据来训练模型，以提高预测的准确性。

### 模型操作

**机器学习（ML）模型操作** 指的是在生产环境中维护 ML 模型的过程实施。常见的挑战是在典型企业场景中，实验室环境中运行的 ML 模型在许多情况下会停留在概念验证阶段。如果将模型推向生产，它会因频繁的数据源变化而变得过时，需重建模型。由于模型需要多次重新训练，需要跟踪模型性能以及用于重新训练的相应特征和超参数。为执行所有这些操作，必须有一个定义明确、可重复的过程来实现端到端的机器学习操作（MLOps），以保持模型在生产环境中的当前性和准确性。ML 模型操作生命周期过程如图 4 所示，涵盖了从模型开发到模型部署再到模型性能监控的整个过程。

![图示](../Images/bb4e45bca87cc0ad729aafbd8984fa5e.png)

**图 4:** 机器学习（ML）模型操作生命周期

模型重新训练在定期时间间隔内非常重要，例如每两周、每月、每季度或按需进行，因为在实际场景中，基础数据可能会随时间变化。定时任务被安排在预定义的时间间隔内重新训练模型，或在数据源变化时，或在模型性能下降时进行重新训练。模型代码可能因超参数调整而发生变化，因此需要通过自动化模型管道来实现这些模型操作。

企业生产环境中的典型自动化模型管道包括三种类型的存储，如**特征存储**、**元数据存储和模型注册表**。**特征存储**包含从各种源系统中提取的数据，并转换为模型所需的特征。机器学习管道从特征存储中批量获取数据以训练模型。**元数据存储**是一个集中式的模型跟踪（记账）系统，企业级维护，包含管道每个阶段的模型元数据。模型元数据存储促进模型阶段的过渡，例如从暂存到生产再到归档。模型训练在一个环境中进行，部署在其他环境中进行，模型推理只需指定远程模型文件路径。模型元数据存储用于模型实验跟踪，并根据性能比较模型实验。模型元数据包括训练数据集版本、训练运行和实验的链接。**模型注册表**包含所有训练模型的数据，如训练模型版本、模型训练日期、模型训练指标、用于训练模型的超参数、预测结果和诊断图表（混淆矩阵、ROC曲线）。根据目标用户的需求，从模型注册表中选择适当的模型。模型元数据存储和模型注册表可以使用轻量级数据库（如SQLite）和一组python函数来实现（定制），也可以使用一套开源/专有产品（如MLflow社区版/Databricks的托管服务）。该工具提供了通过GUI或一组API来管理模型的功能。

**模型部署：** 模型可以在生产环境中进行预测，既可以以批量推理模式也可以以在线推理模式。批量推理可以通过安排作业在特定时间间隔运行，并将结果通过电子邮件发送给指定用户来实现。在线推理可以通过使用python flask库或streamlit库等框架将模型公开为网络服务，开发交互式网页应用，并通过HTTP端点调用模型来实现。

**模型打包/分发：** 训练好的机器学习模型会被序列化成各种格式，以便将模型分发到TEST/PROD环境中。最常见的格式有pickle（用于用python开发的机器学习或深度学习模型）、ONNX（开放神经网络交换格式，用于深度学习模型）和PMML（预测模型标记语言XML格式，专门用于使用逻辑回归和神经网络开发的模型）。模型可以打包成`.jar`文件或docker容器镜像，并作为预测服务部署到生产环境中。

**模型容器化**可以通过构建一个包含训练和推理代码的 docker 镜像来实现，同时还需捆绑必要的训练和测试数据以及未来预测所需的模型文件。一旦创建了捆绑有必要机器学习模型的 docker 文件，就可以使用像 Jenkins 这样的工具构建 CI/CD 管道。这个 docker 容器镜像可以暴露为 REST API，这样任何外部利益相关者都可以使用这个机器学习模型，无论是在本地还是在公共云上（如果构建深度学习模型需要高计算要求）。在打包和管理多个 docker 容器的情况下，可以使用**Kubeflow**，这是 Kubernetes 的机器学习工具包。

**模型性能监控**是一项重要的活动，其中预测结果（例如，某项商品的预测销售价格）与实际值（实际销售价格）会持续进行监控。建议了解最终预测对终端用户的反应。在一些情况下，建议让旧模型和新模型并行运行，以了解两个模型之间的性能变化（模型验证）。必须解决由于“数据漂移”（底层源数据模式由于季节性和趋势的变化，例如年终销售数据（或）新增类别（或）某个特定属性未由上游系统生成）和“模型漂移”（目标变量的统计属性变化，例如，欺诈交易的定义本身发生变化）引起的性能退化。测量模型漂移的最准确方法是通过测量 F1 分数，该分数通过取分类器的精确度和召回率的调和平均值来结合这两个指标。当模型漂移（F1 分数）降到某个阈值以下时，或者在定期间隔（批处理模式）或数据一旦可用时（在线训练），将重新训练模型。使用像 elasticstack 和 fluentd 这样的流行日志工具收集模型日志和预测日志是非常重要的。

**模型版本管理**是机器学习模型管理中一个必要的活动，因为模型会因为底层源数据的变化或审计和合规要求而定期重新训练。源数据、模型训练脚本、模型实验和训练后的模型会一起在代码库中进行版本控制。市面上有开源工具，例如 Data Version Control (DVC) 或 AWS CodeCommit，这些工具使用 Git 作为底层代码库来进行模型版本管理。

**机器学习项目开发角色：** 在实施机器学习模型开发和运营中涉及多种角色。数据工程师分析来自各种来源的业务数据，并确保以具有成本效益的方式提供所需粒度和质量的最新数据。数据科学家查看数据，执行数据预处理和特征工程，构建模型并选择最适合业务预测/建议需求的模型。通常，数据科学家采用基于假设的方法来选择符合要求的模型。机器学习工程师确保构建的模型提供可靠的结果，并通过监控其结果来评估是否需要重新训练模型。Web 应用开发人员构建所需的展示层组件，以调用并向相关利益相关者展示结果。机器学习项目还需要 DevOps 工程师来实现持续交付和数据可视化专家来制作精美的仪表板。

**机器学习模型部署最佳实践：** 推荐的模型部署最佳实践包括 (1) 利用 DevOps 工具自动化机器学习模型开发和部署所需的步骤，为模型重新训练腾出一些额外时间； (2) 在模型生产部署后进行持续的模型测试、性能监控和重新训练，以保持模型的相关性/当前状态，以应对源数据的变化，预测所需的结果； (3) 在将机器学习模型暴露为 API 时实施日志记录，包括捕获输入特征/模型输出（以跟踪模型漂移）、应用上下文（用于调试生产错误）、模型版本（如果部署了多个重新训练的模型）； (4) 在一个存储库中管理所有模型元数据。

**简介：[Suresh Yaram](https://www.linkedin.com/in/sureshyaram/)** 在 IT 公司 ([DXC Technology](https://dxc.com/us/en), 曾用名 CSC India Limited) 担任首席解决方案架构师。Suresh 拥有 20 多年的 IT 经验，专注于数据架构、大数据分析、人工智能和机器学习。他参与了为客户建立数据和分析解决方案，涉及银行、金融和保险等各个领域，包括保险行业的 AI/ML 应用，并在 DXC 的多个技术论坛上进行过展示。Suresh 还在印度举办的 IEEE 数据科学会议上发表过一篇 [论文](https://ieeexplore.ieee.org/document/7823950)。

**相关内容：**

+   [不同方法在生产环境中部署机器学习模型的概述](/2019/06/approaches-deploying-machine-learning-production.html)

+   [MLOps 概述](/2021/03/overview-mlops.html)

+   [MLOps 是一种工程学科：初学者概述](/2021/07/mlops-engineering-discipline.html)

### 更多相关内容

+   [成为出色数据科学家所需的 5 项关键技能](https://www.kdnuggets.com/2021/12/5-key-skills-needed-become-great-data-scientist.html)

+   [每个初学者数据科学家应该掌握的6种预测模型](https://www.kdnuggets.com/2021/12/6-predictive-models-every-beginner-data-scientist-master.html)

+   [2021年最佳ETL工具](https://www.kdnuggets.com/2021/12/mozart-best-etl-tools-2021.html)

+   [停止学习数据科学以寻找目标，并寻找目标…](https://www.kdnuggets.com/2021/12/stop-learning-data-science-find-purpose.html)

+   [学习数据科学统计的顶级资源](https://www.kdnuggets.com/2021/12/springboard-top-resources-learn-data-science-statistics.html)

+   [成功数据科学家的5个特征](https://www.kdnuggets.com/2021/12/5-characteristics-successful-data-scientist.html)
