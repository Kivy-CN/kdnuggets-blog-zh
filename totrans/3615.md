# 使用 PyCaret + MLflow 进行轻松的 MLOps

> 原文：[https://www.kdnuggets.com/2021/05/easy-mlops-pycaret-mlflow.html](https://www.kdnuggets.com/2021/05/easy-mlops-pycaret-mlflow.html)

[评论](#comments)

**由 [Moez Ali](https://www.linkedin.com/in/profile-moez/), PyCaret 的创始人和作者**

### PyCaret

PyCaret 是一个开源的、低代码的机器学习库和端到端模型管理工具，基于 Python，用于自动化机器学习工作流程。它以易用性、简洁性以及快速高效地构建和部署端到端 ML 原型而闻名。

PyCaret 是一个替代的低代码库，可以用少量代码替代数百行代码。这使得实验周期变得极其快速和高效。

![](../Images/48d26d1892bf6f19a4e20b29cf8128a7.png)

PyCaret — 一个开源的、低代码的 Python 机器学习库

要了解更多关于 PyCaret 的信息，你可以查看他们的 [GitHub](https://www.github.com/pycaret/pycaret)。

### MLflow

MLflow 是一个开源平台，用于管理 ML 生命周期，包括实验、可重复性、部署和中央模型注册。MLflow 目前提供四个组件：

![](../Images/5a119b2d388f3596808e1616d53c3332.png)

MLflow 是一个开源平台，用于管理 ML 生命周期

要了解更多关于 MLflow 的信息，你可以查看 [GitHub](https://github.com/mlflow/mlflow)。

### 安装 PyCaret

安装 PyCaret 非常简单，仅需几分钟。我们强烈建议使用虚拟环境，以避免与其他库发生潜在冲突。

PyCaret 的默认安装是一个精简版，只安装了硬依赖 [列在这里](https://github.com/pycaret/pycaret/blob/master/requirements.txt)。

```py
**# install slim version (default)** pip install pycaret**# install the full version**
pip install pycaret[full]
```

当你安装 PyCaret 的完整版时，也会安装所有可选的依赖项，如 [列在这里](https://github.com/pycaret/pycaret/blob/master/requirements-optional.txt)。MLflow 是 PyCaret 的依赖项，因此无需单独安装。

### ???? 让我们开始吧

在谈论 MLOps 之前，让我们先从高层次上谈谈机器学习生命周期：

![](../Images/574b97366435d88f6dca131eb00130bc.png)

机器学习生命周期 — 作者提供的图像（从左到右阅读）

+   **业务问题 —** 这是机器学习工作流程的第一步。根据用例和问题的复杂性，这一步可能需要几天到几周的时间。在这个阶段，数据科学家会与主题专家（SME）会面，以了解问题、访谈关键利益相关者、收集信息，并设定项目的整体期望。

+   **数据来源与 ETL —** 一旦理解了问题，就需要利用访谈中获得的信息从企业数据库中获取数据。

+   **探索性数据分析（EDA） —** 模型尚未开始。EDA是你分析原始数据的阶段。你的目标是探索数据并评估数据的质量、缺失值、特征分布、相关性等。

+   **数据准备 —** 现在是准备数据以进行模型训练的时候了。这包括将数据分为训练集和测试集、填补缺失值、进行独热编码、目标编码、特征工程、特征选择等。

+   **模型训练与选择 —** 这是让每个人都感到兴奋的步骤。这涉及到训练一组模型、调整超参数、模型集成、评估性能指标、模型分析（如AUC、混淆矩阵、残差等），最终选择一个最佳模型以部署到生产环境中用于业务应用。

+   **部署与监控 —** 这是最后一步，主要涉及MLOps。这包括将最终模型打包、创建docker镜像、编写评分脚本，然后使其协同工作，最后将其发布为API，以便对通过管道传入的新数据进行预测。

旧的方法非常繁琐且耗时，需要大量的技术知识，我可能无法在一个教程中涵盖所有内容。然而，在本教程中，我将使用PyCaret演示数据科学家如何变得非常高效地完成这些任务。在我们进入实际操作之前，让我们多谈谈一下MLOps。

### ???? **什么是MLOps？**

MLOps是一种工程学科，旨在结合机器学习开发，即实验（模型训练、超参数调整、模型集成、模型选择等），通常由数据科学家执行，并与机器学习工程和操作相结合，以标准化和简化机器学习模型在生产中的持续交付。

如果你是一个完全的初学者，你可能对我所说的内容一无所知。别担心。让我给你一个简单的非技术性定义：

> *MLOps是一系列技术工程和操作任务，使你的机器学习模型可以被组织内的其他用户和应用程序使用。基本上，它是一种将你的工作，即*机器学习模型*，在线发布的方式，以便其他人可以使用它们并实现一些业务目标。*

这是对MLOps的一个非常简化的定义。实际上，它涉及的工作和好处比这多一点，但如果你对这些还不熟悉，这已经是一个很好的开始了。

现在，让我们按照上图所示的相同工作流程进行实际演示，确保你已经安装了pycaret。

### ???? 业务问题

在本教程中，我将使用由达顿商学院提供的一个非常受欢迎的案例研究，该案例研究发表在[哈佛商业评论](https://hbsp.harvard.edu/product/UV0869-PDF-ENG)上。案例讲述了两个将来要结婚的人。名叫*Greg*的男孩想买一枚戒指向名叫*Sarah*的女孩求婚。问题是要找到Sarah会喜欢的戒指，但在他的密友建议下，Greg决定购买一颗钻石，以便Sarah可以自己选择。Greg随后收集了6000颗钻石的数据，包括价格和切工、颜色、形状等属性。

### ???? 数据

在本教程中，我将使用达顿商学院提供的一个非常受欢迎的案例研究的数据集，该案例研究发表在[哈佛商业评论](https://hbsp.harvard.edu/product/UV0869-PDF-ENG)上。本教程的目标是根据钻石的属性，如克拉重量、切工、颜色等，预测钻石的价格。你可以从[PyCaret的仓库](https://github.com/pycaret/pycaret/tree/master/datasets)下载数据集。

```py
**# load the dataset from pycaret** from pycaret.datasets import get_data
data = get_data('diamond')
```

![](../Images/1bbc59a2d6702dd81534c9c427e52c4d.png)

数据中的示例行

### ???? 探索性数据分析

让我们做一些快速的可视化，评估独立特征（如重量、切工、颜色、清晰度等）与目标变量即`Price`之间的关系

```py
**# plot scatter carat_weight and Price**
import plotly.express as px
fig = px.scatter(x=data['Carat Weight'], y=data['Price'], 
                 facet_col = data['Cut'], opacity = 0.25, template = 'plotly_dark', trendline='ols',
                 trendline_color_override = 'red', title = 'SARAH GETS A DIAMOND - A CASE STUDY')
fig.show()
```

![](../Images/0486a3f02669c1a23e0d30691c1233da.png)

Sarah获得的钻石案例研究

让我们检查一下目标变量的分布情况。

```py
**# plot histogram**
fig = px.histogram(data, x=["Price"], template = 'plotly_dark', title = 'Histogram of Price')
fig.show()
```

![](../Images/a3d15e5315a513dc501fd5ab2f0aa2f7.png)

请注意，`Price`的分布是右偏的，我们可以快速检查一下对数变换是否能使`Price`接近正态分布，从而为假设正态分布的算法提供公平的机会。

```py
import numpy as np**# create a copy of data**
data_copy = data.copy()**# create a new feature Log_Price**
data_copy['Log_Price'] = np.log(data['Price'])**# plot histogram**
fig = px.histogram(data_copy, x=["Log_Price"], title = 'Histgram of Log Price', template = 'plotly_dark')
fig.show()
```

![](../Images/299bdf04ca0020b55f4120689c1d1b9d.png)

这确认了我们的假设。这种变换将帮助我们去除偏斜，使目标变量接近正态分布。基于此，我们将在训练模型之前对`Price`变量进行变换。

### ???? 数据准备

在PyCaret的所有模块中，`setup`是任何使用PyCaret的机器学习实验中第一个也是唯一的必需步骤。这个函数负责训练模型之前所需的所有数据准备工作。除了执行一些基本的默认处理任务外，PyCaret还提供了广泛的预处理功能。要了解更多关于PyCaret中所有预处理功能的信息，你可以查看这个[链接](https://pycaret.org/preprocessing/)。

```py
**# initialize setup**
from pycaret.regression import *
s = setup(data, target = 'Price', transform_target = True, log_experiment = True, experiment_name = 'diamond')
```

![](../Images/c4b6ef208abe74f5d368e297b87a1caa.png)

在pycaret.regression模块中设置函数

当你在PyCaret中初始化`setup`函数时，它会对数据集进行分析，并推断所有输入特征的数据类型。如果所有数据类型都正确推断，你可以按回车键继续。

请注意：

+   我传递了`log_experiment = True`和`experiment_name = 'diamond'`，这将告诉PyCaret在你进行建模阶段时自动记录所有指标、超参数和模型工件。这得益于与[MLflow](https://www.mlflow.org/)的集成。

+   另外，我在`setup`中使用了`transform_target = True`。PyCaret会在幕后使用box-cox变换来转换`Price`变量。这在数据分布上类似于对数变换（*技术上不同*）。如果你想了解更多关于box-cox变换的信息，可以参考这个[链接](https://onlinestatbook.com/2/transformations/box-cox.html)。

![](../Images/f6aa688f11e00b54c059f25ab6843484.png)

设置输出 — 为显示而截断

### ???? 模型训练与选择

现在数据已经准备好进行建模，让我们使用`compare_models`函数开始训练过程。它将训练模型库中所有可用的算法，并使用k折交叉验证评估多个性能指标。

```py
**# compare all models**
best = compare_models()
```

![](../Images/41baf2d435d40f90de71f5b91cd2bfde.png)

compare_models的输出

```py
**# check the residuals of trained model**
plot_model(best, plot = 'residuals_interactive')
```

![](../Images/c49ca96d21bd91b035cedc2744d024ba.png)

最佳模型的残差和QQ图

```py
**# check feature importance**
plot_model(best, plot = 'feature')
```

![](../Images/8c94f981a80372937c05792703bb4e8c.png)

### 完成和保存Pipeline

现在让我们确定最佳模型，即在包括测试集的整个数据集上训练最佳模型，然后将Pipeline保存为pickle文件。

```py
**# finalize the model**
final_best = finalize_model(best)**# save model to disk** save_model(final_best, 'diamond-pipeline')
```

`save_model`函数将把整个Pipeline（包括模型）作为pickle文件保存在你的本地磁盘上。默认情况下，它会将文件保存在与你的Notebook或脚本相同的文件夹中，但如果你愿意，也可以传递完整路径：

```py
save_model(final_best, 'c:/users/moez/models/diamond-pipeline'
```

### ???? 部署

记住我们在设置函数中传递了`log_experiment = True`和`experiment_name = 'diamond'`。让我们看看PyCaret在幕后借助MLflow所做的魔法。要看到这些魔法，让我们启动MLflow服务器：

```py
**# within notebook (notice ! sign infront)** !mlflow ui**# on command line in the same folder** mlflow ui
```

现在打开你的浏览器并输入“localhost:5000”。它将打开一个类似这样的UI：

![](../Images/1e2e7957f01c5bbd2c9740e76846633f.png)

https://localhost:5000

上表中的每一项代表一次训练运行，生成了一个经过训练的Pipeline和一堆元数据，如运行的日期时间、性能指标、模型超参数、标签等。让我们点击其中一个模型：

![](../Images/e040d08c4a600f7e57204c385dfbd2f1.png)

第一部分 — CatBoost Regressor

![](../Images/e8add025c91932275b9b8cc072c9c54c.png)

第二部分 — CatBoost Regressor（续）

![](../Images/4187074323f4bacb809ba5e2800c3cf9.png)

第二部分 — CatBoost Regressor（续）

注意你有一个`logged_model`的地址路径。这是一个使用Catboost Regressor训练的Pipeline。你可以使用`load_model`函数读取这个Pipeline。

```py
**# load model**
from pycaret.regression import load_model
pipeline = load_model('C:/Users/moezs/mlruns/1/b8c10d259b294b28a3e233a9d2c209c0/artifacts/model/model')**# print pipeline** print(pipeline)
```

![](../Images/6eab8c9fade1aba3516d78e43d2b540b.png)

print(pipeline)的输出

现在让我们使用这个Pipeline在新数据上生成预测

```py
**# create a copy of data and drop Price** data2 = data.copy()
data2.drop('Price', axis=1, inplace=True)**# generate predictions** from pycaret.regression import predict_model
predictions = predict_model(pipeline, data=data2)
predictions.head()
```

![](../Images/d379a560bd8216bfdfa7c0ec0cc9a2be.png)

从管道生成的预测

哇哦！我们现在可以从训练好的管道中进行推断了。恭喜你，如果这是你的第一个。注意到所有的转换，如目标转换、独热编码、缺失值填补等，都是在后台自动完成的。你会得到一个包含实际尺度预测的数据框，而这正是你关心的。

### 敬请期待！

今天我展示的是利用 MLflow 将 PyCaret 训练的管道在生产环境中服务的众多方法之一。在下一个教程中，我计划展示如何使用 MLflow 的原生服务功能来注册你的模型、为其版本化并将其作为 API 提供服务。

使用这个轻量级的 Python 工作流自动化库，你可以实现无限的可能性。如果你觉得这很有用，请不要忘记在我们的 GitHub 仓库上给我们 ⭐️。

要了解更多关于 PyCaret 的信息，请关注我们的 [LinkedIn](https://www.linkedin.com/company/pycaret/) 和 [Youtube](https://www.youtube.com/channel/UCxA1YTYJ9BEeo50lxyI_B3g)。

加入我们的 Slack 频道。邀请链接 [这里](https://join.slack.com/t/pycaret/shared_invite/zt-p7aaexnl-EqdTfZ9U~mF0CwNcltffHg)。

### 你可能也会感兴趣：

[在 Power BI 中使用 PyCaret 2.0 构建你自己的 AutoML](https://towardsdatascience.com/build-your-own-automl-in-power-bi-using-pycaret-8291b64181d)

[使用 Docker 在 Azure 上部署机器学习管道](https://towardsdatascience.com/deploy-machine-learning-pipeline-on-cloud-using-docker-container-bec64458dc01)

[在 Google Kubernetes Engine 上部署机器学习管道](https://towardsdatascience.com/deploy-machine-learning-model-on-google-kubernetes-engine-94daac85108b)

[在 AWS Fargate 上部署机器学习管道](https://towardsdatascience.com/deploy-machine-learning-pipeline-on-aws-fargate-eb6e1c50507)

[构建并部署你的第一个机器学习 Web 应用](https://towardsdatascience.com/build-and-deploy-your-first-machine-learning-web-app-e020db344a99)

[使用 AWS Fargate 无服务器架构部署 PyCaret 和 Streamlit 应用](https://towardsdatascience.com/deploy-pycaret-and-streamlit-app-using-aws-fargate-serverless-infrastructure-8b7d7c0584c2)

[使用 PyCaret 和 Streamlit 构建并部署机器学习 Web 应用](https://towardsdatascience.com/build-and-deploy-machine-learning-web-app-using-pycaret-and-streamlit-28883a569104)

[在 GKE 上部署使用 Streamlit 和 PyCaret 构建的机器学习应用](https://towardsdatascience.com/deploy-machine-learning-app-built-using-streamlit-and-pycaret-on-google-kubernetes-engine-fd7e393d99cb)

### 重要链接

[文档](https://pycaret.readthedocs.io/en/latest/installation.html)

[博客](https://medium.com/@moez_62905)

[GitHub](https://www.github.com/pycaret/pycaret)

[StackOverflow](https://stackoverflow.com/questions/tagged/pycaret)

[安装 PyCaret](https://pycaret.readthedocs.io/en/latest/installation.html) [Notebook 教程](https://pycaret.readthedocs.io/en/latest/tutorials.html) [在 PyCaret 中贡献](https://pycaret.readthedocs.io/en/latest/contribute.html)

### 想了解特定的模块吗？

点击下面的链接查看文档和实际示例。

[分类](https://pycaret.readthedocs.io/en/latest/api/classification.html) [回归](https://pycaret.readthedocs.io/en/latest/api/regression.html)

[聚类](https://pycaret.readthedocs.io/en/latest/api/clustering.html)

[异常检测](https://pycaret.readthedocs.io/en/latest/api/anomaly.html)

[自然语言处理](https://pycaret.readthedocs.io/en/latest/api/nlp.html) [关联规则挖掘](https://pycaret.readthedocs.io/en/latest/api/arules.html)

**个人简介: [Moez Ali](https://www.linkedin.com/in/profile-moez/)** 是一名数据科学家，并且是 PyCaret 的创始人及作者。

[原文](https://towardsdatascience.com/easy-mlops-with-pycaret-mlflow-7fbcbf1e38c6)。经许可转载。

**相关内容:**

+   [使用 PyCaret 进行多时间序列预测](/2021/04/multiple-time-series-forecasting-pycaret.html)

+   [将机器学习管道部署到云端，使用 Docker 容器](/2020/06/deploy-machine-learning-pipeline-cloud-docker.html)

+   [GitHub 是你所需要的最佳 AutoML 工具](/2020/08/github-best-automl-ever-need.html)

* * *

## 我们的三大课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [Google 网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速进入网络安全职业的快车道

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [Google 数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升您的数据分析技能

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [Google IT 支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持您的组织的 IT 工作

* * *

### 更多相关话题

+   [如何使用 MLFlow 打包和分发机器学习模型](https://www.kdnuggets.com/2022/08/package-distribute-machine-learning-models-mlflow.html)

+   [使用 PyCaret 进行二分类介绍](https://www.kdnuggets.com/2021/12/introduction-binary-classification-pycaret.html)

+   [使用 PyCaret 进行 Python 中的聚类介绍](https://www.kdnuggets.com/2021/12/introduction-clustering-python-pycaret.html)

+   [宣布 PyCaret 3.0：开源、低代码的 Python 机器学习](https://www.kdnuggets.com/2023/03/announcing-pycaret-30-opensource-lowcode-machine-learning-python.html)

+   [开始使用 PyCaret](https://www.kdnuggets.com/2022/11/getting-started-pycaret.html)

+   [TensorFlow 用于计算机视觉 - 转移学习变得简单](https://www.kdnuggets.com/2022/01/tensorflow-computer-vision-transfer-learning-made-easy.html)
