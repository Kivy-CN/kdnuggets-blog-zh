# 如何编写更好的 SQL 查询：权威指南 – 第 1 部分

> 原文：[https://www.kdnuggets.com/2017/08/write-better-sql-queries-definitive-guide-part-1.html](https://www.kdnuggets.com/2017/08/write-better-sql-queries-definitive-guide-part-1.html)

**作者：Karlijn Willems，数据科学记者及 [DataCamp](https://www.datacamp.com/) 贡献者**

结构化查询语言（SQL）在数据科学行业中是不可或缺的技能，一般来说，学习这项技能相对简单。然而，大多数人忽略了 SQL 不仅仅是编写查询，这只是起步的第一步。确保查询的性能或它们是否适合你所在的工作环境则是完全不同的事情。

* * *

## 我们的三大课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [谷歌网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 加速你的网络安全职业生涯

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [谷歌数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升你的数据分析技能

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [谷歌 IT 支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持组织的信息技术

* * *

这就是为什么本 SQL 教程将为你提供一个小小的了解，展示你可以通过的一些步骤来评估你的查询：

+   首先，你将从一个简短的概述开始，[学习 SQL 对数据科学工作的的重要性](https://www.datacamp.com/community/tutorials/sql-tutorial-query#importance)；

+   接下来，你将首先了解更多关于[SQL 查询处理和执行](https://www.datacamp.com/community/tutorials/sql-tutorial-query#execution)的内容，以便你可以正确理解编写高质量查询的重要性：更具体地说，你会看到查询是如何被解析、重写、优化并最终评估的；

+   考虑到这一点，你不仅会了解一些初学者在编写查询时常见的[反模式](https://www.datacamp.com/community/tutorials/sql-tutorial-query#antipattern)，还会学习到这些可能错误的替代方案和解决方法；你还将了解[基于集合的方法与过程方法](https://www.datacamp.com/community/tutorials/sql-tutorial-query#setbased)的不同。

+   你还会看到这些反模式源于性能问题，此外，除了改善 SQL 查询的“手动”方法，你还可以通过使用其他工具来更结构化、更深入地[分析你的查询](https://www.datacamp.com/community/tutorials/sql-tutorial-query#queryplan)，这些工具帮助你查看查询计划；并且，

+   你还将简要了解[时间复杂度和大 O 符号](https://www.datacamp.com/community/tutorials/sql-tutorial-query#bigo)，以了解在执行查询之前执行计划的时间复杂度；最后，

+   你将简要获得一些关于如何[进一步优化你的查询](https://www.datacamp.com/community/tutorials/sql-tutorial-query#tune)的建议。

![](../Images/3fec2cbe3c0764a970df9ee5b3657839.png)

你对SQL课程感兴趣吗？来参加DataCamp的[数据科学入门SQL课程](https://www.datacamp.com/courses/intro-to-sql-for-data-science)吧！

### 我为什么要学习SQL以用于数据科学？

SQL远未过时：它是数据科学行业中职位描述中最受欢迎的技能之一，无论你是申请数据分析师、数据工程师、数据科学家还是[其他角色](https://www.datacamp.com/community/tutorials/data-science-industry-infographic)。这一点得到了2016年O'Reilly数据科学薪资调查的70%受访者的确认，他们表示在职业背景中使用SQL。而且，在这项调查中，SQL明显优于R（57%）和Python（54%）编程语言。

你明白了：在你为进入数据科学行业而努力时，SQL是一个必须具备的技能。

对于一个在1970年代初开发的语言来说，这还不错吧？

但究竟为什么SQL如此频繁地使用？即使它存在了这么长时间，为什么它还没有过时？

有几个原因：其中一个主要原因是公司通常将数据存储在关系型数据库管理系统（RDBMS）或关系型数据流管理系统（RDSMS）中，你需要SQL来访问这些数据。SQL是数据的通用语言：它让你能够与几乎任何数据库互动，甚至在本地构建自己的数据库！

如果这还不够，请记住，不同供应商之间有不少SQL实现是不兼容的，并且不一定遵循标准。因此，了解标准SQL是你在（数据科学）行业中找到自己的方向的必要条件。

此外，可以肯定地说，SQL也被新技术所接受，比如Hive，它是一个类似SQL的查询语言接口，用于查询和管理大型数据集，或Spark SQL，你可以用它来执行SQL查询。再一次，你在这些技术中遇到的SQL将与你可能学到的标准有所不同，但学习曲线将会容易得多。

如果你想做个比较，可以把它看作是学习线性代数：通过在这个科目上投入所有的努力，你知道你将能够用它来掌握机器学习！

简而言之，这就是为什么你应该学习这个查询语言的原因：

+   它相当容易学习，即使是完全的新手也是如此。学习曲线相当平缓，你很快就能编写查询了。

+   它遵循“学一次，随处使用”的原则，所以这是对你时间的一个绝佳投资！

+   这是对编程语言的一个很好的补充；在某些情况下，写查询甚至比编写代码更受欢迎，因为它的性能更好！

+   …

你还在等什么？ :)

### SQL 处理与查询执行

要提高 SQL 查询的性能，你首先需要了解当你按下快捷键运行查询时内部发生了什么。

首先，查询被解析为一个“解析树”；查询被分析以查看它是否满足语法和语义要求。解析器创建输入查询的内部表示。这个输出然后被传递给重写引擎。

然后由优化器来找到给定查询的最佳执行或查询计划。执行计划精确定义了每个操作使用的算法，以及如何协调这些操作的执行。

为了找到最优的执行计划，优化器会枚举所有可能的执行计划，确定每个计划的质量或成本，获取当前数据库状态的信息，然后选择最佳的作为最终执行计划。由于查询优化器可能并不完美，数据库用户和管理员有时需要手动检查和调整优化器生成的计划，以获得更好的性能。

现在你可能会想什么是被认为“好的查询计划”。

正如你已经阅读的，计划的成本质量扮演了重要角色。更具体地说，评估计划所需的磁盘 I/O 数量、计划的 CPU 成本、数据库客户端观察到的整体响应时间以及总执行时间都是至关重要的。这就是时间复杂度概念会出现的地方。你稍后会阅读到更多关于这方面的内容。

接下来，选择的查询计划被执行，由系统的执行引擎评估，查询的结果被返回。

![](../Images/1d9ed9522e2baf1b62b9ec5d87a3dbf0.png)

### 编写 SQL 查询

从前面的部分可能没有明确的是，垃圾进垃圾出（GIGO）原则在查询处理和执行中自然显现：制定查询的人也掌握了 SQL 查询性能的关键。如果优化器得到一个格式不正确的查询，它将只能做到有限的工作……

这意味着在编写查询时，有一些事情是*你*可以做的。正如你在介绍中看到的，责任是双重的：不仅仅是编写符合某种标准的查询，还要对查询中可能潜藏的性能问题有一定的了解。

理想的起点是思考查询中可能出现问题的“点”。一般来说，有四个子句和关键字，新手可以预期在这些地方发生性能问题：

+   `WHERE`子句；

+   任何`INNER JOIN`或`LEFT JOIN`关键字；并且，

+   `HAVING`子句；

当然，这种方法简单而天真，但作为初学者，这些子句和语句是很好的指引，可以安全地说，当你刚刚开始时，这些地方是容易出错的，具有讽刺意味的是，这些地方也很难发现错误。

然而，你也应该意识到性能需要在特定上下文中才能变得有意义：仅仅说这些子句和关键字是坏的并不是你考虑SQL性能时的正确方式。你的查询中有`WHERE`或`HAVING`子句并不一定意味着它是一个糟糕的查询……

看一下以下部分，了解更多关于反模式和替代方法来构建你的查询。这些提示和技巧旨在作为指导。你是否真正需要重写你的查询，取决于数据量、数据库以及你需要执行查询的次数等因素。这完全取决于你的查询目标，并且对你要查询的数据库有一些先前的知识是至关重要的！

### 1\. 只检索你需要的数据

“数据越多越好”的心态在你编写SQL查询时并不一定适用：不仅仅是你可能会因为获取了超出实际需要的数据而使你的见解变得模糊，而且你的性能也可能因为你的查询提取了过多的数据而受到影响。

这就是为什么一般来说要留意`SELECT`语句、`DISTINCT`子句和`LIKE`操作符。

**`SELECT` 语句**

你可以在编写查询时首先检查的一个方面是`SELECT`语句是否尽可能简洁。你的目标应该是从`SELECT`中删除不必要的列。这样你就迫使自己只提取对查询目标有用的数据。

如果你有包含`EXISTS`的相关子查询，你应该尝试在该子查询的`SELECT`语句中使用常量，而不是选择实际列的值。这在你仅检查存在性时特别有用。

**记住**，相关子查询是使用外部查询值的子查询。请注意，尽管`NULL`在这个上下文中可以作为“常量”使用，但这非常混乱！

考虑以下示例来理解使用常量的意义：

```py
SELECT driverslicensenr, name 
FROM Drivers 
WHERE EXISTS (SELECT '1' FROM Fines 
              WHERE fines.driverslicensenr = drivers.driverslicensenr);
```

**提示**：知道相关子查询并不总是一个好主意是很方便的。你可以考虑通过例如用`INNER JOIN`重写来去除这些子查询：

```py
SELECT driverslicensenr, name 
FROM drivers 
INNER JOIN fines ON fines.driverslicensenr = drivers.driverslicensenr;
```

**`DISTINCT` 子句**

`SELECT DISTINCT` 语句用于返回仅有的不同（不同）值。如果可能的话，你应该尽量避免使用`DISTINCT`子句；正如你在其他示例中看到的那样，如果你在查询中添加了这个子句，执行时间只会增加。因此，总是一个好主意来考虑是否真的需要这个`DISTINCT`操作才能获得你想要的结果。

**`LIKE` 运算符**

当你在查询中使用 `LIKE` 运算符时，如果模式以 `%` 或 `_` 开始，则不会使用索引。这会阻止数据库使用索引（如果存在）。当然，从另一个角度看，你也可以认为这种查询可能会打开检索过多不一定符合查询目标的记录的大门。

再次提醒，你对存储在数据库中的数据的了解可以帮助你制定一个模式，以正确筛选所有数据，只找到对你的查询真正重要的行。

### 2\. 限制你的结果

当你无法避免在 `SELECT` 语句中进行筛选时，你可以考虑以其他方式限制结果。这就是 `LIMIT` 子句和数据类型转换派上用场的地方。

**`TOP`、`LIMIT` 和 `ROWNUM` 子句**

你可以在查询中添加 `LIMIT` 或 `TOP` 子句，以设置结果集的最大行数。以下是一些示例：

```py
SELECT TOP 3 * 
FROM Drivers;
```

**注意**，例如，如果你通过 `SELECT TOP 50 PERCENT *` 更改查询的第一行，你可以进一步指定 `PERCENT`。

```py
SELECT driverslicensenr, name 
FROM Drivers 
LIMIT 2;
```

另外，你也可以添加 `ROWNUM` 子句，相当于在查询中使用 `LIMIT`：

```py
SELECT * 
FROM Drivers 
WHERE driverslicensenr = 123456 AND ROWNUM <= 3;
```

### 数据类型转换

你应该始终使用最有效的数据类型，即最小的数据类型。提供一个巨大的数据类型而小的数据类型足够时，总是存在风险。

然而，当你在查询中添加数据类型转换时，只会增加执行时间。

一种替代方案是尽可能避免数据类型转换。请注意，这里并不总是可能去除或省略数据类型转换，但你绝对应该在包含它们时小心，并且在运行查询之前测试添加的效果。

### 更多相关话题

+   [将职业转向数据科学的终极指南](https://www.kdnuggets.com/2022/05/definitive-guide-switching-career-data-science.html)

+   [Python 函数参数：终极指南](https://www.kdnuggets.com/2023/02/python-function-arguments-definitive-guide.html)

+   [解决 MySQL 中幽灵读取的终极指南](https://www.kdnuggets.com/2022/06/definitive-guide-solving-phantom-read-mysql.html)

+   [逐步阅读和理解 SQL 查询的指南](https://www.kdnuggets.com/a-step-by-step-guide-to-reading-and-understanding-sql-queries)

+   [如何在原生 Python 中编写 SQL](https://www.kdnuggets.com/2022/02/easy-sql-native-python.html)

+   [KDnuggets 新闻，12月7日：破解前10大数据科学误区 • 4…](https://www.kdnuggets.com/2022/n47.html)
