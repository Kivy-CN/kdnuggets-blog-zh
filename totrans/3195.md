# 如何对机器学习代码进行单元测试

> 原文：[https://www.kdnuggets.com/2017/11/unit-test-machine-learning-code.html](https://www.kdnuggets.com/2017/11/unit-test-machine-learning-code.html)

![c](../Images/3d9c022da2d331bb56691a9617b91b90.png) [comments](#comments)

**作者：Chase Roberts，机器学习工程师**

![AI](../Images/7c1f9253aaea96785bcd1cea1033e67f.png)

参考: [provalisresearch.com/blog/machine-learning](https://provalisresearch.com/blog/machine-learning/)

在过去的一年里，我把大部分工作时间都花在了深度学习研究和实习上。而且那一年中很多时间都在犯非常大的错误，这些错误帮助我不仅了解了机器学习，还了解了如何正确而健全地设计这些系统。在我在 Google Brain 工作期间，我学到的主要原则之一是，单元测试可以决定你的算法成败，并且可以节省你几周的调试和训练时间。

然而，似乎网上没有一个完善的教程来 *编写* 神经网络代码的单元测试。即使是像 OpenAI 这样的地方也只是通过 [盯着每一行代码并尝试思考为什么它会导致错误](https://blog.openai.com/openai-baselines-dqn/) 来发现错误。显然，我们大多数人没有那种时间或自我厌恶，因此希望这个教程可以帮助你理智地开始测试你的系统！

让我们从一个简单的例子开始。试着找出这段代码中的错误。

你看到了吗？网络实际上并没有堆叠。当我写这段代码时，我复制并粘贴了 slim.conv2d(…) 行，只修改了内核大小，而从未修改实际输入。

我很尴尬地说，这实际上发生在我大约一周前……但这是一个重要的教训！这些错误很难发现，原因有几个。

1.  这段代码从未崩溃、报错，甚至变慢。

1.  这个网络仍然可以训练，损失值仍然会下降。

1.  数值在几小时后收敛，但结果非常差，让你挠头不知道需要修复什么。

当你唯一的反馈是最终验证错误时，你唯一需要搜索的就是你的整个网络架构。不用说，你需要一个更好的系统。

那么我们如何在进行完整的多天训练之前 *发现* 这个问题呢？实际上最容易注意到的一点是，层的值从未实际到达函数外的任何其他张量。所以假设我们有某种损失函数和优化器，这些张量永远不会被优化，因此它们将始终保持默认值。

我们可以通过简单地进行一次训练步骤，并比较其前后的值来检测这个问题。

啪。不到 15 行代码，我们现在验证了至少我们创建的所有变量都得到了训练。

这个测试非常简单而且非常有用。假设我们解决了之前的问题，现在我们想开始添加一些批量归一化。看看你能否发现错误。

你看到了吗？这个 bug 非常微妙。你看，tensorflow 中的 batch_norm 实际上将 is_training 默认设置为*False*，因此添加这一行代码在训练期间实际上不会对输入进行归一化！幸运的是，我们写的最后一个单元测试会立即捕捉到这个问题！（我知道，因为这发生在我三天前。）

让我们再做一个例子。这实际上来自于我一天看到的一个[reddit帖子](https://www.reddit.com/r/MachineLearning/comments/6qyvvg/p_tensorflow_response_is_making_no_sense/)。我不会深入细节，但基本上这个人想创建一个输出范围在(0, 1)的分类器。看看你能否找到其中的 bug。

发现 bug 了吗？这个 bug 很难事先发现，并且会导致非常混淆的结果。基本上这里发生的情况是预测只有一个输出，当你应用[softmax 交叉熵](https://en.wikipedia.org/wiki/Softmax_function)时，会导致损失总是 0。

一种简单的方法是…确保损失从未为 0。

另一个好的测试类似于我们的第一个测试，但方向相反。你可以确保只有你想训练的变量真正被训练。例如，一个 GAN。一个常见的 bug 是在优化过程中不小心忘记设置哪些变量需要训练。这样的代码时常出现。

最大的问题在于优化器有一个默认设置来优化所有变量。在像 GANs 这样的先进架构中，这会使你所有的训练时间都付之东流。然而，你可以通过编写这样的测试来轻松检测这些错误：

对于鉴别器，可以编写一个非常类似的测试。这个相同的测试也可以用于许多强化学习算法。许多 actor-critic 模型有不同的网络需要通过不同的损失进行优化。

这是一些我建议你在测试中遵循的模式。

1.  保持测试结果的确定性。如果测试以奇怪的方式失败，然后永远无法重现，那真的很糟糕。如果你*真的*想要随机输入，确保为随机数设置种子，以便你可以轻松重新运行测试。

1.  保持测试简短。不要有一个单元测试训练到收敛并对验证集进行检查。如果你这样做，你是在浪费自己的时间。

1.  确保在每次测试之间重置图形。

总之，这些黑箱算法仍然有很多测试的方法！花一个小时编写测试可以节省你几天重新运行训练会话的时间，并可以大大改善你的研究。如果我们的实现有 bug，不得不丢弃完全正确的想法，不是很糟糕吗？

这个列表显然不是全面的，但这是一个很好的开始！如果你有额外的建议或特定的测试发现有用，请在[twitter](https://twitter.com/TheNerdStation)上给我发消息！我很乐意制作这部分内容的第二部分。

本文中的所有观点都是基于我的个人经验，并未得到谷歌的赞助或支持。

**简介: [Chase Roberts](http://thenerdstation.github.io/)** 曾是谷歌脑团队的研究实习生。曾在机器学习机器人团队工作。专注于渐进神经网络在迁移学习中的实现和深入分析。同时也帮助实现了强化学习架构。

[原文](https://medium.com/@keeper6928/how-to-unit-test-machine-learning-code-57cf6fd81765)。经许可转载。

**相关：**

+   [TensorFlow: 应优化哪些参数？](/2017/11/tensorflow-parameters-optimize.html)

+   [软件工程与机器学习概念的比较](/2017/03/software-engineering-vs-machine-learning-concepts.html)

+   [使用 TensorFlow 进行线性回归的预测分析](/2017/11/tensorflow-predictive-analytics-linear-regression.html)

* * *

## 我们的三大课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [谷歌网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速通道进入网络安全职业。

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [谷歌数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升您的数据分析技能

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [谷歌 IT 支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持您组织的 IT

* * *

### 更多相关话题

+   [如何在 Python 中进行单元测试？](https://www.kdnuggets.com/2023/01/perform-unit-testing-python.html)

+   [如何通过使用自动 EDA 工具在数据科学评估测试中取得好成绩](https://www.kdnuggets.com/2022/04/ace-data-science-assessment-test-automatic-eda-tools.html)

+   [在 Python 中执行 T 检验](https://www.kdnuggets.com/2023/01/performing-ttest-python.html)

+   [超越准确性：使用 NLP 测试库评估和改进模型](https://www.kdnuggets.com/2023/04/john-snow-beyond-accuracy-nlp-test-library.html)

+   [宣布 PyCaret 3.0：Python 中的开源低代码机器学习](https://www.kdnuggets.com/2023/03/announcing-pycaret-30-opensource-lowcode-machine-learning-python.html)

+   [KDnuggets 新闻，4月27日：带代码的论文简要介绍；…](https://www.kdnuggets.com/2022/n17.html)
