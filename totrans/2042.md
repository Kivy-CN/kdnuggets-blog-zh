# 数据可观察性：使用 SQL 构建数据质量监控器

> 原文：[https://www.kdnuggets.com/2021/02/data-observability-building-data-quality-monitors-using-sql.html](https://www.kdnuggets.com/2021/02/data-observability-building-data-quality-monitors-using-sql.html)

[评论](#comments)

**作者：[Ryan Kearns](https://www.linkedin.com/in/ryanothnielkearns/)，斯坦福大学 & [Barr Moses](https://www.linkedin.com/in/barrmoses/)，Monte Carlo 的首席执行官兼联合创始人**

![图示](../Images/7a97509a8e11f2e885c0d1f8ee9db2a3.png)

图片由 [faaiq ackmerd](https://www.pexels.com/@faaiq-ackmerd-383634) 提供，来源于 [Pexels](http://www.pexels.com/)。

* * *

## 我们的前三大课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [Google 网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速进入网络安全职业道路。

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [Google 数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升你的数据分析技能

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [Google IT 支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持你所在组织的 IT 部门

* * *

*在这一系列文章中，我们将讲解如何从零开始创建自己的数据可观察性监控器，并映射到*[*数据健康的五大关键支柱*](https://towardsdatascience.com/introducing-the-five-pillars-of-data-observability-e73734b263d5)*。本系列的第 1 部分改编自 Barr Moses 和 Ryan Kearns 的 O’Reilly 培训，*[***管理数据停机：将可观察性应用于数据管道***](https://www.oreilly.com/live-training/courses/managing-data-downtime/0636920508717/)*，这是业界首个关于数据可观察性的课程。相关的练习可以在*[*这里*](https://github.com/monte-carlo-data/data-downtime-challenge)*找到，本文章中展示的改编代码可以在*[*这里*](https://github.com/monte-carlo-data/data-observability-in-practice)*获取。*

从空值和重复行到建模错误和架构变化，数据可能因多种原因而中断。[数据测试](https://towardsdatascience.com/why-testing-your-data-is-insufficient-6914275a9762)通常是对抗不良数据的第一道防线，但如果数据在其生命周期中出现问题，会发生什么？

我们称这种现象为数据停机，它指的是数据缺失、错误或其他不准确的时间段。[数据停机](https://towardsdatascience.com/the-rise-of-data-downtime-841650cedfd5)促使我们提出以下问题：

+   数据是否最新？

+   数据是否完整？

+   字段是否在预期范围内？

+   空值率是否高于或低于预期？

+   架构是否发生了变化？

为了在数据出现问题时触发警报并防止数据停机，数据团队可以借鉴软件工程领域朋友们的一项成熟策略：[**监控和可观察性**](https://observability.workshop.aws/en/anomalydetection.html)。

我们将[**数据可观察性**](https://towardsdatascience.com/what-is-data-observability-40b337971e3e)定义为一个组织回答这些问题并评估其数据生态系统健康状况的能力。数据健康的关键变量体现在数据可观察性的五大支柱中：

+   **新鲜度**：我的数据是否是最新的？是否存在数据未更新的时间间隔？

+   **分布**：我的数据在字段级别的健康状况如何？我的数据是否在预期范围内？

+   **数据量**：我的数据摄取是否达到了预期的阈值？

+   **结构**：我的数据管理系统的正式结构是否发生了变化？

+   **数据追踪**：如果我的一些数据出现故障，上游和下游会受到什么影响？我的数据源如何相互依赖？

> 以这种概念化的方式谈论数据可观察性是一回事，但完整的处理应该揭示幕后——**数据可观察性在实际代码中是什么样的？**

完全回答这个问题是困难的，因为细节将取决于选择的数据仓库、数据湖、BI 工具、首选语言和框架等等。即便如此，使用 SQLite 和 Jupyter 这样的轻量级工具来解决这些问题可能会有用。

在这篇文章中，我们将通过一个示例数据生态系统来创建我们自己的数据质量监控器，并探索数据可观察性在实际中的表现。

让我们来看看。

### 数据可观察性的实际应用

*本教程基于*[*练习 1*](https://github.com/monte-carlo-data/data-downtime-challenge/blob/master/exercise_text/ex1.md)* 我们的 O'Reilly 课程*[*管理数据停机*](https://www.oreilly.com/live-training/courses/managing-data-downtime/0636920508717/)*。你可以使用 Jupyter Notebook 和 SQL 自行尝试这些练习。我们将在未来的文章中详细讲解，包括练习*[*2*](https://github.com/monte-carlo-data/data-downtime-challenge/blob/master/exercise_text/ex2.md)*、*[*3*](https://github.com/monte-carlo-data/data-downtime-challenge/blob/master/exercise_text/ex3.md)*和*[*4*](https://github.com/monte-carlo-data/data-downtime-challenge/blob/master/exercise_text/ex4.md)*。

我们的示例数据生态系统使用关于宜居系外行星的[mock astronomical data](https://github.com/monte-carlo-data/data-observability-in-practice/blob/main/EXOPLANETS.db)。为了这个练习，我用Python生成了数据集，模拟了我在生产环境中遇到的真实异常。这个数据集完全免费使用，并且[utils folder](https://github.com/monte-carlo-data/data-downtime-challenge/tree/master/data/utils)包含了生成数据的代码，如果你感兴趣的话。

我使用的是**SQLite 3.32.3**，这应该使得数据库可以通过命令提示符或SQL文件以最小的设置访问。概念可以扩展到任何查询语言，[这些实现](https://github.com/monte-carlo-data/data-observability-in-practice/tree/main/queries)可以通过最小的修改扩展到MySQL、Snowflake和其他数据库环境。

```py
$ sqlite3 EXOPLANETS.db
sqlite> PRAGMA TABLE_INFO(EXOPLANETS);
0 | _id            | TEXT | 0 | | 0
1 | distance       | REAL | 0 | | 0
2 | g              | REAL | 0 | | 0
3 | orbital_period | REAL | 0 | | 0
4 | avg_temp       | REAL | 0 | | 0
5 | date_added     | TEXT | 0 | | 0
```

`EXOPLANETS`中的一个数据库条目包含以下信息：

0. `_id`: 对应行星的UUID。

1. `distance`: 与地球的距离（以光年为单位）。

2. `g`: 作为*g*的倍数的表面重力，*g*是重力常数。

3. `orbital_period`: 单个轨道周期的长度（以天为单位）。

4. `avg_temp`: 平均表面温度（以开尔文度为单位）。

5. `date_added`: 我们的系统发现行星并自动将其添加到数据库中的日期。

注意，对于某些行星，`distance`、`g`、`orbital_period`和`avg_temp`中的一个或多个可能是`NULL`，这是由于缺失或错误的数据造成的。

```py
sqlite> SELECT * FROM EXOPLANETS LIMIT 5;
```

注意，这个练习是回顾性的——我们在查看历史数据。在生产数据环境中，数据可观察性是实时的，并应用于数据生命周期的每个阶段，因此实现会与这里的有所不同。

为了这个练习，我们将构建新鲜度和分布的数据可观察性算法，但在未来的文章中，我们会讨论其余的五个支柱——以及更多内容。

### 新鲜度

数据可观察性的第一个支柱是新鲜度，它可以给我们一个强有力的指标，显示关键数据资产最后一次更新的时间。如果一个每小时定期更新的报告突然看起来非常过时，这种异常应该能强烈提示我们有问题。

首先，注意`DATE_ADDED`列。SQL不存储单个记录何时添加的元数据。因此，为了在这种回顾性设置中可视化新鲜度，我们需要自己跟踪这些信息。

按照`DATE_ADDED`列进行分组可以让我们了解`EXOPLANETS`如何每天更新。例如，我们可以查询每天添加的新ID数量：

你可以通过在[仓库](https://github.com/monte-carlo-data/data-observability-in-practice)中运行`$ sqlite3 EXOPLANETS.db < queries/freshness/rows-added.sql`来自己运行这个查询。我们得到以下数据：

根据我们数据集的图形表示，`EXOPLANETS` 看起来每天稳定更新大约 100 条新记录，尽管也有数据缺失的间隔。

记住，对于新鲜度，我们要问“我的数据是否最新？”— 因此，了解表格更新中的这些空缺对于理解数据的可靠性至关重要。

![图示](../Images/4708360fcf924837114dfffe3c26ee0a.png)

新鲜度异常！

这个查询通过引入 `DAYS_SINCE_LAST_UPDATE` 的指标来实现新鲜度监测。（注意：由于本教程使用 SQLite3，计算时间差的 SQL 语法在 MySQL、Snowflake 和其他环境中会有所不同）。

结果表格显示“在日期 *X*，`EXOPLANETS` 中最新的数据是 *Y* 天前的。” 这是从表格中的 `DATE_ADDED` 列中未明确获得的信息—但应用数据可观察性为我们提供了发现这些信息的工具。

![帖子图片](../Images/87c04146ac53b77a2213732668d24b30.png)

现在，我们拥有检测新鲜度异常所需的数据。剩下的就是为 Y 设置一个**阈值** **参数**— *多少天是过多的*？一个参数将查询转变为检测器，因为它决定什么算作异常（即：值得警报）和什么不算。（有关设置阈值参数的更多信息，请参见后续文章！）

新鲜度异常！

返回给我们的数据表示了发生新鲜度事件的日期。

在 2020-05-14，表格中最新的数据已经有 8 天了！这样的故障可能代表数据管道的中断，如果我们将这些数据用于任何有价值的用途（并且如果我们在生产环境中使用这些数据，可能性很大），这将是值得了解的。

![帖子图片](../Images/ba65f82e8223e5de336a45d737b2fd1c.png)

特别注意查询的最后一行：`DAYS_SINCE_LAST_UPDATE > 1;`。

在这里，1 是一个[**模型参数**](https://en.wikipedia.org/wiki/Parameter)— 这个数字本身没有“正确”与否，但改变它会影响我们认为哪些日期是事件。数字越小，我们捕捉到的真正异常就越多（高[召回率](https://en.wikipedia.org/wiki/Precision_and_recall)），但也有可能一些“异常”并不反映实际的故障。数字越大，我们捕捉到的异常更有可能反映真实的异常（高[精确度](https://en.wikipedia.org/wiki/Precision_and_recall)），但也有可能我们会漏掉一些。

以这个示例为目的，我们可以将 1 改为 7，从而只捕捉到 2020-02-08 和 2020-05-14 的两个最严重的故障。这里的任何选择都会反映特定的使用案例和目标，这是在将数据可观察性应用于生产环境时不断需要权衡的重要因素。

在下面，我们利用相同的鲜度检测器，但以`DAYS_SINCE_LAST_UPDATE > 3;`作为阈值。两个较小的中断现在没有被检测到。

![Image for post](../Images/bbffaed6ea2b218bd21959a885620c44.png)

注意两个未检测到的中断——这些必须少于 3 天的间隔。

现在我们可视化相同的鲜度检测器，但以`DAYS_SINCE_LAST_UPDATE > 7;`作为阈值。除了两个最大的中断外，其余的现在都没有被检测到。

![Image for post](../Images/463b75b09950ab92ac408c823deb5688.png)

[就像行星](https://www.nasa.gov/vision/earth/livingthings/microbes_goldilocks.html)一样，最佳模型参数位于“金发姑娘区”或“甜点区”，即在被认为过低和过高的值之间。这些数据可观察性概念（以及更多内容！）将在后续文章中讨论。

### 分布

接下来，我们想评估数据的字段级分布健康。分布告诉我们数据的所有预期值，以及每个值出现的频率。一个最简单的问题是，“我的数据有多频繁`NULL`”？在许多情况下，一定程度的不完整数据是可以接受的——但如果 10% 的空值率变成 90%，我们就需要知道。

这个查询返回了大量数据！发生了什么？

通用公式`CAST(SUM(CASE WHEN SOME_METRIC IS NULL THEN 1 ELSE 0 END) AS FLOAT) / COUNT(*)`在按`DATE_ADDED`列分组时，告诉我们`SOME_METRIC`在`EXOPLANETS`的新数据日批中的`NULL`值率。通过查看原始输出很难了解情况，但可视化可以帮助揭示这个异常：

![Image for post](../Images/2a5d024d4be467300eabda1a7df0ebc5.png)

![Image for post](../Images/b1fbde7bfae7897f7e892d6c29a69b08.png)

![Image for post](../Images/7edb30280c659015cb209783842ced16.png)

![Image for post](../Images/6100e3e6762b701e5c5aa079a1840d2f.png)

可视化使得明显，我们应该检测到空值率的“尖峰”事件。现在让我们专注于最后一个指标`AVG_TEMP`。我们可以最基本地通过[简单阈值](https://datacadamia.com/data_mining/threshold)来检测空值尖峰：

我们的第一个分布异常。

就检测算法而言，这种方法有点像钝器。有时，我们的数据模式足够简单，像这样的阈值就能解决问题。然而，在其他情况下，数据可能会噪声很大或有其他复杂情况，比如[季节性](https://en.wikipedia.org/wiki/Seasonality)，这就需要我们调整方法。

![Image for post](../Images/abcdc70ca369cc2164d31321b1dea6fd.png)

例如，检测 2020–06–02、2020–06–03 和 2020–06–04 似乎是多余的。我们可以过滤掉那些紧接其他警报后的日期：

注意在这两个查询中，关键参数是`0.9`。我们实际上是在说：“任何空值率高于 90% 都是一个问题，我需要知道。”

![Image for post](../Images/c40400c69b37aa433d473f1e94531745.png)

在这种情况下，我们可以（也应该）通过使用带有更智能参数的 [滚动平均](https://en.wikipedia.org/wiki/Moving_average) 的概念来变得更聪明：

一点说明：请注意，在第28行，我们通过数量 `AVG_TEMP_NULL_RATE — TWO_WEEK_ROLLING_AVG`进行过滤。在其他情况下，我们可能会想对这个误差数量取 `ABS()`，但在这里不需要——原因是`NULL` 率的“峰值”如果代表从上一个平均值的增加则更令人担忧。监控`NULL`的频率突然减少可能不值得，而检测`NULL`率的增加是明确的。

![Image for post](../Images/e3e97337d5d99d587bfba608c9610154.png)

当然，还有越来越复杂的异常检测指标，如[**Z分数**](https://en.wikipedia.org/wiki/Standard_score)和[**自回归建模**](https://en.wikipedia.org/wiki/Autoregressive_model)，这些超出了本教程的范围。本教程仅提供了SQL领域健康监控的基本框架；希望它能给你带来对自己数据的灵感！

### 下一步是什么？

本简要教程旨在展示“数据可观察性”并不像名称所暗示的那样神秘，通过全面了解您的数据健康状况，您可以在数据管道的每个阶段确保高数据信任度和可靠性。

实际上，数据可观察性的核心原则是可以通过普通的SQL“检测器”实现的，只要保留一些关键信息，如记录时间戳和历史表元数据。还值得注意的是，对于与生产环境共同发展的端到端数据可观察性系统，关键的机器学习参数调优是强制性的。

> 请继续关注本系列未来的文章，这些文章将聚焦于分布和模式中的异常监控、数据可观察性中血缘和元数据的作用，以及如何在大规模监控这些支柱以实现更可靠的数据。

在此之前——祝您没有数据停机时间！

***想了解更多关于如何在大规模应用数据可观察性的信息吗？请联系***[***Ryan***](https://www.linkedin.com/in/ryan-kearns-203686a9)***、***[***Barr***](https://www.linkedin.com/in/barrmoses/)*** 和其余的 ***[***Monte Carlo团队***](https://www.montecarlodata.com/)***。***

**[Ryan Kearns](https://www.linkedin.com/in/ryanothnielkearns/)** 是斯坦福大学的高级学生，双学位计算机科学和哲学。他目前是Monte Carlo的机器学习工程实习生。

**[Barr Moses](https://www.linkedin.com/in/barrmoses/)** 是Monte Carlo的首席执行官兼联合创始人，该公司专注于数据可观察性。在此之前，她曾担任Gainsight的运营副总裁。

[原文](https://towardsdatascience.com/data-observability-in-practice-using-sql-755dc6421f59)。经许可转载。

**相关：**

+   [SQL中的数据清理和整理](/2021/01/data-cleaning-wrangling-sql.html)

+   [实用统计推理的10条原则](/2020/11/10-principles-practical-statistical-reasoning.html)

+   [数据科学与商业智能的比较，详解](/2021/02/data-science-vs-business-intelligence-explained.html)

### 相关话题

+   [数据质量维度：通过大期望确保数据质量](https://www.kdnuggets.com/2023/03/data-quality-dimensions-assuring-data-quality-great-expectations.html)

+   [数据治理与可观察性，详解](https://www.kdnuggets.com/2022/08/data-governance-observability-explained.html)

+   [IMPACT 2022：数据可观察性峰会，10月25-26日](https://www.kdnuggets.com/2022/09/monte-carlo-impact-2022-data-observability-summit.html)

+   [IMPACT: 数据可观察性峰会将于11月8日回归](https://www.kdnuggets.com/2023/10/monte-carlo-impact-the-data-observability-summit-is-back)

+   [使用Eurybia检测数据漂移以确保生产机器学习模型质量](https://www.kdnuggets.com/2022/07/detecting-data-drift-ensuring-production-ml-model-quality-eurybia.html)

+   [免费4周数据科学课程：AI质量管理](https://www.kdnuggets.com/2022/02/truera-free-4-week-data-science-course-ai-quality-management.html)
