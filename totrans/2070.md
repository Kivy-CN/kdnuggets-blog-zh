# 数据工程入门指南 – 第二部分

> 原文：[https://www.kdnuggets.com/2018/03/beginners-guide-data-engineering-part-2.html/2](https://www.kdnuggets.com/2018/03/beginners-guide-data-engineering-part-2.html/2)

![c](../Images/3d9c022da2d331bb56691a9617b91b90.png) [评论](/2018/03/beginners-guide-data-engineering-part-2.html?page=2#comments)

### Airflow 管道的结构

![](../Images/b3883f7be24a82be7a7c39fb4e3216e7.png)

现在我们已经了解了事实表、维度表、日期分区的概念以及数据回填的含义，让我们将这些概念具体化，并应用于实际的 Airflow ETL 作业中。

* * *

## 我们的前三个课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [谷歌网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速开启网络安全职业生涯。

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [谷歌数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升您的数据分析技能

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [谷歌 IT 支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持您组织中的 IT

* * *

**定义有向无环图（DAG）**

正如我们在[早期帖子](https://medium.com/@rchang/a-beginners-guide-to-data-engineering-part-i-4227c5c457d7)中提到的，任何 ETL 作业，其核心都基于三个构建块：**E**xtract（提取）、**T**ransform（转换）和**L**oad（加载）。尽管从概念上讲，这听起来很简单，但实际生活中的 ETL 作业通常很复杂，由许多 E、T 和 L 任务的组合组成。因此，使用图形来可视化复杂的数据流是非常有用的。从视觉上看，图中的一个*节点*代表一个任务，一个*箭头*代表一个任务对另一个任务的依赖关系。由于数据只需在给定任务上计算一次，然后将计算结果传递下去，因此图是*有向的*和*无环的*。这就是为什么 Airflow 作业通常被称为“DAGs”（**D**irected **A**cyclic **G**raphs）。

![](../Images/9c6359d1c3dedca683467b64d23bcb98.png)

[来源](https://medium.com/airbnb-engineering/https-medium-com-jonathan-parks-scaling-erf-23fd17c91166)：Airbnb 实验报告框架 DAG 的截图

Airflow UI 的一个巧妙设计是它允许任何用户通过[图形视图](https://airflow.apache.org/ui.html#graph-view)可视化 DAG，使用代码作为配置。数据管道的作者必须定义任务之间的依赖关系结构以进行可视化。这一规范通常写在一个称为*DAG 定义文件*的文件中，阐明了 Airflow 作业的结构。

**操作符：传感器、操作符和转移**

虽然 DAGs 描述了*如何*运行数据管道，但操作符描述了*在*数据管道中*做什么*。通常，操作符分为三个广泛的类别：

+   **传感器：**等待某个时间、外部文件或上游数据源

+   **操作符：**触发某个动作（例如，运行一个 bash 命令、执行一个 python 函数或执行一个 Hive 查询等）

+   **数据转移：**将数据从一个位置移动到另一个位置

精明的读者可能会看到这些操作符如何对应于 **E**xtract，

**T**ransform 和 **L**oad 步骤我们之前讨论过的。

**传感器** 在一定时间过去或当上游数据源的数据变得可用时解锁数据流。在 Airbnb，由于我们的大多数 ETL 作业涉及 Hive 查询，我们经常使用 `[NamedHivePartitionSensors](https://github.com/apache/incubator-airflow/blob/master/airflow/sensors/named_hive_partition_sensor.py)` 来检查 Hive 表的最新分区是否可用于下游处理。

**操作符** 触发数据转换，这对应于 **T**ransform 步骤。由于 Airflow 是开源的，贡献者可以通过 [扩展](https://github.com/apache/incubator-airflow/tree/master/airflow/operators) `BaseOperator` 类来创建自定义操作符。 在 Airbnb，我们最常使用的操作符是 `[HiveOperator](https://github.com/apache/incubator-airflow/blob/master/airflow/operators/hive_operator.py#L22)`（用于执行 Hive 查询），但我们也经常使用 `[PythonOperator](https://github.com/apache/incubator-airflow/blob/master/airflow/operators/python_operator.py)`（例如，运行 Python 脚本）和 `[BashOperator](https://github.com/apache/incubator-airflow/blob/master/airflow/operators/bash_operator.py)`（例如，运行 bash 脚本，甚至是复杂的 Spark 作业）。这里的可能性是无限的！

最后，我们还有特殊的操作符用于 **数据转移**，这通常映射到 ETL 的 **L**oad 步骤。在 Airbnb，我们经常使用 `[MySqlToHiveTransfer](https://github.com/apache/incubator-airflow/blob/master/airflow/operators/mysql_to_hive.py)` 或 `[S3ToHiveTransfer](https://github.com/apache/incubator-airflow/blob/master/airflow/operators/s3_to_hive_operator.py)`，但这在很大程度上取决于数据基础设施和数据仓库的位置。

**一个简单的示例**

以下是一个简单的示例，演示如何定义 DAG 定义文件、实例化一个 Airflow DAG，并使用我们上述描述的各种操作符定义相应的 DAG 结构。

当 DAG 渲染时，我们可以看到以下图形视图：

![](../Images/8c6afb760a294b42682b86dae4f3237f.png)

玩具示例 DAG 的图形视图

### ETL 最佳实践

![](../Images/2027a30a151a5a2c88b0ff1cdd567049.png)

[图片来源](http://www.omen-azen.com/eat-together-1/): 构建你的工艺需要练习，因此遵循最佳实践是明智的

像任何工艺一样，编写简洁、可读且可扩展的 Airflow 任务需要实践。在我的第一个工作中，ETL 对我来说只是一系列机械的任务，我需要完成。我没有把它看作是一门工艺，也不知道最佳实践。在 Airbnb，我学到了很多最佳实践，并开始欣赏好的 ETL 及其美丽之处。下面，我列出了一些好的 ETL 管道应该遵循的非详尽原则：

+   **分区数据表：**正如我们之前提到的，数据分区在处理具有长历史的大型表时特别有用。当数据通过日期戳进行分区时，我们可以利用动态分区来并行回填。

+   **增量加载数据：**这一原则使得你的 ETL 更具模块化和可管理性，尤其是在从事实表构建维度表时。在每次运行中，我们只需将新事务附加到前一日期分区的维度表，而不是扫描整个事实历史。

+   **强制幂等性：**许多数据科学家依赖于时间点快照来进行历史分析。这意味着基础源表在时间推移中不应被修改，否则我们会得到不同的答案。管道应构建为当相同的查询在相同的业务逻辑和时间范围内运行时，返回相同的结果。这种属性有一个 fancy 名称，叫做幂等性。

+   **参数化工作流：**就像模板大大简化了 HTML 页面的组织一样，Jinja 可以与 SQL 配合使用。正如我们之前提到的，Jinja 模板的一个常见用法是将回填逻辑整合到典型的 Hive 查询中。[Stitch Fix](https://www.google.com/search?q=stitchfix+jinja&oq=stitchfix+jinja&aqs=chrome..69i57j69i59.3030j0j1&sourceid=chrome&ie=UTF-8) 有一篇很好的文章总结了他们如何将这种技术用于他们的 ETL。

+   **尽早并频繁地添加数据检查：**在处理数据时，将数据写入暂存表、检查数据质量，然后再将暂存表与最终生产表交换是很有用的。在 Airbnb，我们称之为*stage-check-exchange*范式。这个 3 步范式中的检查是重要的防御机制——它们可以是简单的检查，比如记录总数是否大于 0，或者是复杂的异常检测系统，检查是否有未见的类别或异常值。

stage-check-exchange 操作的框架（即数据管道的“单元测试”）

+   **构建有用的警报和监控系统：**由于 ETL 作业通常需要很长时间才能运行，添加警报和监控是有用的，这样我们就不必一直关注 DAG 的进展。不同公司以多种创新方式监控 DAG——在 Airbnb，我们定期使用 EmailOperators 发送缺失 SLA 的作业警报邮件。其他团队使用警报标记实验不平衡。还有一个 [有趣的例子](https://www.slideshare.net/cloudera/building-robust-pipelines-with-airflow-wrangle-conference-2017) 来自 Zymergen，他们通过 SlackOperator 报告模型性能指标，如 R 平方。

这些原则的灵感来源于与经验丰富的数据工程师的对话、我在构建 Airflow DAGs 过程中的经验，以及 Gerard Toonstra 的 [ETL Best Practices with Airflow](https://gtoonstra.github.io/etl-with-airflow/principles.html) 的阅读。对好奇的读者，我强烈推荐 Maxime 的以下讲座：

[来源](https://www.youtube.com/watch?v=dgaoqOZlvEA)：Airflow 的原始作者 Maxime 讲解 ETL 最佳实践

### 第二部分回顾

在本系列的第二篇文章中，我们深入探讨了星型架构和数据建模。我们学习了事实表和维度表之间的区别，并看到了使用时间戳作为分区键的优势，尤其是在回填时。此外，我们解剖了 Airflow 作业的构造，并明晰了 Airflow 中的不同操作符。我们还强调了构建 ETL 的最佳实践，并展示了 Airflow 作业与 Jinja 和 SlackOperators 结合使用时的灵活性。可能性是无限的！

在系列的最后一篇文章中，我将讨论一些高级数据工程模式——具体来说，从构建管道到构建框架的过程。我将再次使用我们在 Airbnb 使用的一些示例框架作为激励示例。

如果你觉得这篇文章有用，请访问 [**第一部分**](https://medium.com/@rchang/a-beginners-guide-to-data-engineering-part-i-4227c5c457d7)并关注 **第三部分**。

*我要感谢*[*Jason Goodman*](https://medium.com/@jasonkgoodman)* 和 Michael Musson 为我提供的宝贵反馈*

**简介：[Robert Chang](https://www.linkedin.com/in/robert-chang-877b1720/)** 是 Airbnb 的数据科学家，专注于机器学习、机器学习基础设施和主持人增长。在 Airbnb 之前，他曾是 Twitter 的数据科学家，拥有斯坦福大学统计学学位和加州大学伯克利分校运筹学学位。

[原文](https://towardsdatascience.com/a-beginners-guide-to-data-engineering-part-ii-47c4e7cbda71)。经许可转载。

**相关：**

+   [数据工程入门指南  –  第一部分](/2018/01/beginners-guide-data-engineering-1.html)

+   [新手和初级数据科学家的建议](/2017/11/chang-advice-new-junior-data-scientists.html)

+   [如何构建数据科学管道](/2017/07/build-data-science-pipeline.html)

### 更多相关主题

+   [初学者数据工程指南](https://www.kdnuggets.com/2023/07/beginner-guide-data-engineering.html)

+   [初学者数据科学异常检测技术指南](https://www.kdnuggets.com/2023/05/beginner-guide-anomaly-detection-techniques-data-science.html)

+   [数据科学介绍：初学者指南](https://www.kdnuggets.com/2023/07/introduction-data-science-beginner-guide.html)

+   [初学者 Pyjanitor 数据清洗指南](https://www.kdnuggets.com/beginners-guide-to-data-cleaning-with-pyjanitor)

+   [初学者端到端机器学习指南](https://www.kdnuggets.com/2021/12/beginner-guide-end-end-machine-learning.html)

+   [必备机器学习算法：初学者指南](https://www.kdnuggets.com/2021/05/essential-machine-learning-algorithms-beginners.html)
