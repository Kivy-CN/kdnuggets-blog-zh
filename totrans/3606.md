# 机器学习模型开发与模型操作：原则与实践

> 原文：[https://www.kdnuggets.com/2021/10/machine-learning-model-development-operations-principles-practice.html](https://www.kdnuggets.com/2021/10/machine-learning-model-development-operations-principles-practice.html)

[评论](#comments)

**由 [Suresh Yaram](https://www.linkedin.com/in/sureshyaram/), DXC Technology 首席解决方案架构师**

### 1\. 引言

* * *

## 我们的前三大课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [谷歌网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速进入网络安全职业生涯。

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [谷歌数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升您的数据分析能力

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [谷歌 IT 支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持您的组织进行 IT 工作

* * *

机器学习（ML）的使用在企业数据分析场景中显著增加，以从业务数据中提取有价值的洞见。因此，在生产环境中建立、测试、部署和维护企业级机器学习模型的生态系统非常重要。ML 模型开发涉及从多个可信来源获取数据、处理数据以适合构建模型、选择算法构建模型、建立模型、计算性能指标并选择最佳性能模型。一旦模型部署到生产中，模型维护扮演了关键角色。机器学习模型的维护包括使模型保持最新，并与源数据变化保持相关，因为模型有过时的风险。此外，随着模型数量的增加，ML 模型的配置管理在模型管理中也发挥着重要作用。本文重点介绍原则和行业标准实践，包括在企业环境中用于 ML 模型开发、部署和维护的工具和技术。

### 2\. 模型开发

**机器学习（ML）模型生命周期** 指的是从源数据识别到模型开发、模型部署和模型维护的整个过程。从高层次看，所有活动大致分为两个主要类别，如 ML 模型开发和 ML 模型操作。

**机器学习（ML）模型开发** 包括图 1 中提到的一系列步骤。

![图](../Images/65ad4640976073749d0b838990e29200.png)

**图 1:** 机器学习（ML）模型开发生命周期

ML 模型开发生命周期步骤大致可以分为：数据探索、模型构建、模型超参数调整和性能最优的模型选择。

**探索性数据分析**是一个重要的步骤，它在商业假设准备好后开始。这个步骤占据了整个项目时间的40-50%，因为模型的结果依赖于输入数据的质量。探索性数据分析涉及数据属性识别、数据预处理和特征工程。属性识别包括预测变量/特征变量（输入）和目标/分类变量（输出）的识别，以及其数据类型（字符串、数值或日期时间），并将特征分类为类别变量和连续变量，这有助于在构建模型时算法对变量进行适当的处理。数据预处理包括识别缺失值和异常值，并通过计算定量属性的均值或中位数以及定性属性的众数来填补这些空缺，以提高模型的预测能力。异常值会导致均值和标准差的增加，通过取自然对数值可以消除这些异常值，从而减少极端值引起的变异。

**特征工程**是探索性数据分析中的下一个重要步骤，在此过程中，原始数据集被处理以将字符串、日期时间或数值类型的数据转换为数值向量，以便机器学习算法理解并构建高效的预测模型。此外，带标签的类别数据（例如，颜色：红色、绿色、蓝色；表现：差、一般、好、非常好、优秀；风险：低、中、高；状态：已开始、进行中、暂停、已关闭；性别：男性/女性；是否批准贷款/是否欺诈索赔：是/否）在机器学习算法中不能被正确理解，因此需要转换为数值数据。特征编码是将类别数据转换为连续（数值）值的广泛使用的技术，例如，将颜色编码为1、2、3；表现编码为1、2、3、4、5；风险编码为1、2、3；状态编码为1、2、3、4；性别/是否批准贷款/是否欺诈索赔编码为0/1等。推荐在类别变量没有顺序关系的情况下使用标签编码（例如，颜色和状态），在类别变量有顺序关系的情况下使用有序编码（例如，表现、风险），在类别变量数据是二元性质的情况下使用独热编码（例如，性别、是否批准贷款、是否欺诈索赔）。在R或Python中有一系列库可用于实现这些编码方法。在某些情况下，尤其是在处理“日期”数据类型时，会创建一组虚拟变量或派生变量。一旦将类别文本数据转换为数值数据，数据就可以输入到模型中；最后一步是选择适当的特征，以帮助提高模型的准确性，使用的方法包括单变量选择（统计度量）、特征重要性（模型属性）和相关矩阵（识别哪些特征与目标变量最相关）。这些方法检测两个变量之间的共线性，即它们高度相关并包含关于给定数据集中的方差的相似信息。可以使用方差膨胀因子（VIF）来检测多重共线性，其中三个或更多高度相关的变量被纳入模型中。探索性数据分析中的关键点在下图（图 2）中表示。

![图示](../Images/d185e9dfbfb0d279fbe7c621987ac415.png)

**图 2：** 探索性数据分析

**构建机器学习模型** 需要将数据分为两组，例如按80:20或70:30的比例分为“训练集”和“测试集”；根据输入数据的性质和业务结果的预测，可以选择一组监督（用于有标签数据）和无监督（用于无标签数据）算法。如果是有标签数据，如果预测的结果是二元（0/1）性质，建议选择逻辑回归算法；如果预测的结果是多类（1/2/3/...）性质，则选择决策树分类器（或）随机森林®分类器（或）KNN；如果预测的结果是连续性数据，则选择线性回归算法（例如，决策树回归器、随机森林回归器）。对于无标签/非结构化（文本）数据，建议使用聚类（无监督）算法（例如，k-means聚类）。建议使用人工神经网络（ANN）算法来分析其他非结构化（图像/语音）数据类型，例如用于图像识别的卷积神经网络（CNN）和用于语音识别及自然语言处理（NLP）的递归神经网络（RNN）。模型使用训练数据集进行构建，并使用测试数据集进行预测。相比回归模型（机器学习模型），推荐使用深度学习（神经网络）模型来获得更好的性能，因为这些模型通过引入激活函数（AF）增加了额外的非线性层。不同场景下的算法选择在图3中表示，如下所示。

![图像](../Images/fcbcb5d5eb3c35362f7a46ed449200f8.png)

**图 3：** 选择正确的算法

**模型性能计算** 是选择正确模型的下一个逻辑步骤。模型性能指标将决定最终模型选择，包括计算准确性、精确度、召回率、F1分数（精确度和召回率的加权平均），以及分类模型的混淆矩阵和回归模型的决定系数。对于用不平衡/偏斜数据集训练的分类模型，不建议使用准确性作为衡量标准，而是建议计算精确度和召回率，以选择正确的分类模型。

**模型超参数调优** 是流程中非常推荐的步骤，持续进行直到模型性能达到大约80%-85%。例如，随机森林算法使用最大深度、最大特征数、树的数量等作为超参数，这些可以直观地调整以提高模型准确性。类似地，神经网络算法使用层数、批量大小、训练轮数、样本数量等。建议使用网格搜索方法来寻找模型的最佳超参数，以获得最‘准确’的预测。此外，还推荐进行交叉验证，因为模型准确性的提升有时可能由于过拟合（模型过于敏感，无法泛化）或欠拟合（模型过于泛化），使用k折交叉验证技术可以解决这一问题。为了避免过拟合，可以增加训练数据样本量以引入更多模式，或减少特征数量以避免复杂性，或使用岭回归和套索回归方法进行数据正则化以减少误差/惩罚。同样，为了避免欠拟合，可以增加模型复杂性，例如从线性模型转为非线性模型，或为神经网络添加更多隐藏层（训练轮次），或添加更多特征以引入隐藏模式。然而，增加数据量并不能解决欠拟合问题，反而会影响模型性能。

最后，选择性能最佳的模型。

**机器学习模型开发最佳实践：** 推荐的机器学习模型开发最佳实践包括：（1）在属性识别之前，针对已识别的业务问题制定明确的假设；（2）首先使用基础算法构建模型，例如逻辑回归或决策树，并编译性能指标，这可以在使用更复杂的算法（如神经网络）之前，提供足够的数据相关性信心；（3）在构建模型过程中保持中间检查点，以跟踪模型超参数及其相关性能指标，这可以使模型逐步训练，并在性能与训练时间之间做出良好判断；（4）使用真实生产数据进行模型训练，以提高预测的正确性。

### 模型操作

**机器学习 (ML) 模型操作** 指的是实施过程以维护生产环境中的 ML 模型。在典型企业场景中，常见的挑战是实验室环境中的 ML 模型在很多情况下停留在概念验证阶段。如果模型被推出到生产环境中，它会因为频繁的数据源变化变得过时，这需要重新构建模型。由于模型会被多次重新训练，需要跟踪模型性能及用于重新训练模型的相应特征和超参数。为了执行所有这些操作，应当有一个定义明确的可重复过程来实现端到端的机器学习操作 (MLOps)，以保持模型在生产环境中的最新和准确。ML 模型操作生命周期过程如图 4 所示，涵盖了从模型开发到模型部署，再到模型性能监控的整个过程，确保其无缝衔接。

![图示](../Images/bb4e45bca87cc0ad729aafbd8984fa5e.png)

**图 4：** 机器学习 (ML) 模型操作生命周期

定期重新训练模型非常重要，例如每两周、每月、每季度或按需进行，因为在实际场景中，底层数据源很可能会随着时间发生变化。可以通过定时任务在预定的间隔时间内重新训练模型，或者在数据源变化时，或在模型性能下降时重新训练模型。模型代码可能会因超参数调整而有所变化，因此需要通过自动化模型管道来自动化这些模型操作。

在企业生产环境中，典型的自动化模型管道包括 3 种类型的存储，例如**特征存储**、**元数据存储和模型注册中心**。**特征存储**包含从各种源系统提取的数据，并转换为模型所需的特征。机器学习管道从特征存储中批量获取数据以训练模型。**元数据存储**是一个集中式模型跟踪（记录）系统，在企业级维护，包含管道每个阶段的模型元数据。模型元数据存储促进模型阶段的过渡，例如从暂存到生产到归档。模型训练在一个环境中进行，而部署在另一个环境中进行，只需指定远程模型文件路径即可执行模型推断。模型元数据存储用于跟踪模型实验并根据其性能比较模型实验。模型元数据包括训练数据集版本、训练运行和实验的链接。**模型注册中心**包含所有训练模型的数据，如训练模型版本、模型训练日期、模型训练指标、用于训练模型的超参数、预测结果和诊断图表（混淆矩阵、ROC 曲线）。将根据目标用户的需求从模型注册中心中选择适当的模型。模型元数据存储和模型注册中心可以使用轻量级数据库（如 SQLite）和一组 python 函数，或一组开源/专有产品（如 MLflow（社区版/Databricks 提供的托管服务））来实现。该工具提供了通过 GUI 或一组 API 管理模型的功能。

**模型部署：** 模型可以在生产环境中进行部署，以执行批量推断模式或在线推断模式。批量推断可以通过安排任务在特定时间间隔运行，并通过电子邮件将结果发送给目标用户来实现。在线推断可以通过将模型公开为网络服务来实现，使用如 python flask 库或 streamlit 库来开发交互式 Web 应用程序，并通过 HTTP 端点调用模型。

**模型打包/分发：** 训练好的机器学习模型被序列化成各种格式，以便将模型分发到 TEST/PROD 环境中进行部署。最常见的格式有 pickle（用于在 python 中开发的机器学习或深度学习模型）、ONNX（开放神经网络交换格式，用于深度学习模型）和 PMML（预测模型标记语言基于 XML 的格式，专门用于使用逻辑回归和神经网络开发的模型）。模型可以打包为 .jar 文件或 docker 容器镜像，并作为预测服务部署到生产环境中。

**模型容器化**可以通过构建一个包含训练和推理代码的 Docker 镜像来实现，并且将必要的训练和测试数据以及模型文件一起打包以用于未来的预测。一旦创建了包含必要机器学习模型的 Docker 文件，就可以使用诸如 Jenkins 之类的工具构建 CI/CD 流水线。这个 Docker 容器镜像可以作为 REST API 进行暴露，以便任何外部利益相关者都可以从本地或公共云（在构建深度学习模型时计算需求较高的情况下）访问这个机器学习模型。在包装和管理多个 Docker 容器的情况下，可以使用 **Kubeflow**，这是一个适用于 Kubernetes 的机器学习工具包。

**模型性能监控**是一项重要活动，其中预测结果（例如，项目的预测销售价格）与实际值（实际销售价格）会持续进行监控。同时建议了解最终预测的最终用户反应。在某些场景下，建议保持旧模型和新模型并行运行，以了解两种模型的性能变化（模型验证）。必须解决由于“数据漂移”（由于季节性和趋势导致的底层源数据模式变化，例如年终销售数据（或）新增类别（或）某个属性未由上游系统生成）和“模型漂移”（目标变量的统计属性变化，例如欺诈交易的定义本身发生变化）而导致的性能下降。测量模型漂移的最准确方法是通过测量 F1 分数，该分数将分类器的精确度和召回率结合成一个单一指标，并取其调和均值。模型会在模型漂移（F1 分数）低于某个阈值时，或在定期间隔（批处理模式）时，或一旦数据可用时（在线训练）进行重新训练。使用流行的日志记录工具如 elasticstack 和 fluentd 来收集模型日志和预测日志是非常重要的。

**模型版本管理**是机器学习模型管理中的一项强制性活动，因为模型会由于底层源数据的变化或审计和合规要求定期进行重新训练。源数据、模型训练脚本、模型实验和训练好的模型都在代码仓库中进行版本管理。现在有一些开源工具可用，如数据版本控制（Data Version Control，DVC）或 AWS CodeCommit，它们使用 Git 作为底层代码仓库来进行模型版本管理。

**ML 项目开发角色：** 在实现 ML 模型开发和操作过程中涉及各种角色。数据工程师分析来自不同来源的业务数据，确保以成本有效的方式访问正确且最新的数据，且数据具有所需的粒度和质量。数据科学家查看数据，进行数据预处理和特征工程、模型构建，并选择最符合业务预测/处方要求的模型。通常，数据科学家采用基于假设的方法选择适合要求的模型。ML 工程师确保构建的模型可靠地提供结果，并通过监控结果来评估是否需要重新训练模型。Web 应用开发人员构建所需的展示层组件，以调用和向相关利益相关者展示结果。ML 项目还需要 DevOps 工程师以实现持续交付，并需要数据可视化专家以生成精美的仪表板。

**ML 模型部署最佳实践：** 推荐的模型部署最佳实践是 (1) 自动化 ML 模型开发和部署所需的步骤，通过利用 DevOps 工具为模型重新训练提供额外的时间；(2) 在生产部署后执行持续的模型测试、性能监控和重新训练，以保持模型的相关性/当前性，因为源数据的变化可能会影响预测结果；(3) 在将 ML 模型暴露为 API 时实现日志记录，包括捕获输入特征/模型输出（以跟踪模型漂移）、应用上下文（用于调试生产错误）、模型版本（如果生产中部署了多个重新训练的模型）；(4) 在单一存储库中管理所有模型元数据。

**简介: [苏雷什·亚拉姆](https://www.linkedin.com/in/sureshyaram/)** 在一家 IT 公司（[DXC Technology](https://dxc.com/us/en)，前身为 CSC India Limited）担任首席解决方案架构师。苏雷什拥有 20 多年的 IT 经验，专注于数据架构、大数据分析、人工智能和机器学习。他参与了为客户在银行、金融和保险等多个领域构建数据与分析解决方案，包括针对保险行业场景的 AI/ML，并在 DXC 的各种技术论坛上进行了展示。苏雷什还在印度举行的 IEEE 数据科学会议上发表了一篇 [论文](https://ieeexplore.ieee.org/document/7823950)。

**相关：**

+   [部署机器学习模型到生产环境的不同方法概述](/2019/06/approaches-deploying-machine-learning-production.html)

+   [MLOps 概述](/2021/03/overview-mlops.html)

+   [MLOps 是一门工程学科：初学者概述](/2021/07/mlops-engineering-discipline.html)

### 更多相关内容

+   [成为优秀数据科学家所需的 5 项关键技能](https://www.kdnuggets.com/2021/12/5-key-skills-needed-become-great-data-scientist.html)

+   [每位初学者数据科学家应该掌握的6种预测模型](https://www.kdnuggets.com/2021/12/6-predictive-models-every-beginner-data-scientist-master.html)

+   [2021年最佳ETL工具](https://www.kdnuggets.com/2021/12/mozart-best-etl-tools-2021.html)

+   [停止学习数据科学以寻找目的，然后寻找目的…](https://www.kdnuggets.com/2021/12/stop-learning-data-science-find-purpose.html)

+   [学习数据科学统计的顶级资源](https://www.kdnuggets.com/2021/12/springboard-top-resources-learn-data-science-statistics.html)

+   [成功数据科学家的5个特征](https://www.kdnuggets.com/2021/12/5-characteristics-successful-data-scientist.html)
