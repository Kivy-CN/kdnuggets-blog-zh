# 通过CI改进笔记本：自动测试图机器学习的文档

> 原文：[https://www.kdnuggets.com/2020/04/better-notebooks-through-ci-automatically-testing-documentation-graph-machine-learning.html](https://www.kdnuggets.com/2020/04/better-notebooks-through-ci-automatically-testing-documentation-graph-machine-learning.html)

[评论](#comments)

**作者：[Huon Wilson](https://www.linkedin.com/in/huon-wilson/)，CSIRO Data61**

![图片](../Images/fefd5799b6761494a8dc174865f849f7.png)

由[Martin Adams](https://unsplash.com/@martinadams?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)拍摄，来源于[Unsplash](https://unsplash.com/s/photos/kite?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)

构建数据科学库就像在两个世界之间行走：数据科学由Python笔记本主导，这是一种在浏览器中快速方便地实验和演示代码的方式，而软件工程则关注于使软件可靠和可重复。[StellarGraph](https://github.com/stellargraph/stellargraph)利用持续集成来保持两者的优势。

StellarGraph是一个开源、用户友好的Python库，用于[图机器学习](https://medium.com/stellargraph/knowing-your-neighbours-machine-learning-on-graphs-9b7c3d0d5896)，基于TensorFlow和Keras构建。它提供了[a lot of demonstrations](https://github.com/stellargraph/stellargraph/tree/develop/demos)其功能，以[Jupyter notebooks](https://jupyter.org/)的形式，帮助数据科学家和其他人解决实际问题。这些演示可以直接在GitHub上查看，甚至有链接可在[Binder](https://mybinder.org/)和[Google Colab](https://colab.research.google.com/)云服务中自动运行。

随着本月晚些时候发布StellarGraph 1.0版本，我们开发了自动化流程，以确保我们的演示——即使在对库进行重大改进时——也能正常运行。

在本文中，我们将详细讲解支持我们保持库演示最新和信息丰富的持续集成（CI）。

### 它是如何工作的

StellarGraph的笔记本CI主要有三种方式：

+   验证每个笔记本是否**保持最新并成功运行**，使用[papermill](https://papermill.readthedocs.io/en/latest/)来**保持CI快速**，以提供良好的开发者体验

+   提供链接到[nbviewer](https://nbviewer.jupyter.org/)以**便捷地查看失败**，在浏览器中以美观的方式呈现

+   检查我们是否提供**一致的体验**，通过确保每个笔记本都链接到云服务并具有相同的格式，通过[black](https://github.com/psf/black)和自定义代码。

让我们深入探讨这些细节。

### 高速；可靠；人力—选择两者之一

文档和示例在准确时最为有用。StellarGraph是一个活跃的项目，进行[持续改进和修复](https://github.com/stellargraph/stellargraph/pulse/monthly)；这些改进中的许多使我们能够改进笔记本，有些更改则需要调整一个或两个笔记本。所有这些必须做到*完美无缺*。

我们的目标是确保**每个演示都能每次都有效**，遵循[“非火箭科学”软件工程规则](https://graydon2.dreamwidth.org/1597.html)。在每次拉取请求的基础上保持笔记本的正常运行要容易得多。如果我们不保持更新，可能会花费很长时间才能意识到它们出现了问题，更不用说诊断原因和修复了。

我们很小心，并根据需要更新和重新运行笔记本，但人类很容易犯错。StellarGraph有40多个笔记本，每周合并大约25个拉取请求。这意味着即使是较低的错误率也会导致*大量*的笔记本出现问题。

![图示](../Images/22b9d8f2bf8e32b11c6ad188a095207f.png)

*软件腐蚀：每周25个拉取请求，即便每个拉取请求使笔记本出现问题的概率很低（1%），所有笔记本快速正常工作的概率仍然会迅速降到零。*

例如，假设每个拉取请求使一些笔记本停止工作的概率只有1%。即使是小概率，这意味着在一周后所有笔记本正常工作的概率只有78%，一个月后所有笔记本正常工作的概率不到40%。

我们试图通过手动代码审查来保持笔记本的正常工作，使用[ReviewNB](https://www.reviewnb.com/)应用程序。ReviewNB提供比原始JSON更有用的差异，使得讨论好的和不太好的更改变得容易。然而，人类容易犯错，可能会遗漏问题。此外，代码审查只会突出显示已编辑的笔记本；它不会突出显示*应该*进行编辑的笔记本！

### 自动运行的笔记本

为了帮助我们人类，我们还利用计算机检查笔记本：CI检查大多数笔记本在每个拉取请求和每次合并时是否正常运行，除了单元测试。然而，CI的效果最好是快速的，而我们的大多数笔记本展示了重量级的机器学习，*它的速度还不够快*。

减少CI时间的最简单方法是并行工作。几乎所有笔记本都仅依赖于StellarGraph库，因此它们可以独立执行。我们通过[并发](https://github.com/stellargraph/stellargraph/blob/59d269a10f207b6b5e5c2b891de8bd3d5408cb3b/.buildkite/pipeline.yml#L86)使用[并行作业](https://buildkite.com/docs/tutorials/parallel-builds#parallel-jobs)在[Buildkite CI](https://buildkite.com/)上运行它们，但这仍然不够：有些笔记本单独运行时耗时过长。

我们使用 [papermill](https://papermill.readthedocs.io/en/latest/) 来 [执行我们的笔记本](https://github.com/stellargraph/stellargraph/blob/59d269a10f207b6b5e5c2b891de8bd3d5408cb3b/.buildkite/steps/test-single-notebook.sh#L14)，因为它支持 [参数化](https://papermill.readthedocs.io/en/latest/usage-parameterize.html)：在 CI 环境中运行时，我们的笔记本会缩短模型训练时间，计算更短的随机游走，或进行其他优化。

Papermill 的参数化功能允许在不必为每个演示添加丑陋的“我们是否在 CI 环境”条件代码的情况下完成此操作。对于需要参数化的笔记本，我们只需稍作重构，使其包含一个包含需要调整的参数的单元格。然后，可以通过 [YAML 文件](https://github.com/stellargraph/stellargraph/blob/develop/.buildkite/notebook-parameters.yml) 和 parameters_file 选项来替换新值。

这些笔记本在 CI 环境中临时运行，因此模型的准确性并不是那么重要。主要需要的是执行每一条代码路径，以验证其全部功能。我们优化参数，使其尽可能小，同时仍然涵盖每个边界情况，例如，将训练轮次从一个减少到两个，以捕捉轮次之间出现的任何问题。

如果出现问题，例如函数参数更改或内存不足，笔记本将无法运行，我们的测试也会失败。这会立即告诉我们需要更多更改以保持一切正常。

### 使用 Buildkite 工件和注释来突出显示错误

CI 帮助我们看到何时出现问题，但知道确切的问题会更好。Papermill 通过记录笔记本的所有 stdout 和 stderr 输出提供了帮助；但是，挖掘冗长的 CI 日志是麻烦的。此外，这些日志通常缺乏足够的上下文来轻松理解问题，尤其是与笔记本的渲染视图相比，在那里错误会附加到单个单元格及其他相关单元格。

运行笔记本后，CI [将结果笔记本附加](https://github.com/stellargraph/stellargraph/blob/59d269a10f207b6b5e5c2b891de8bd3d5408cb3b/.buildkite/steps/test-single-notebook.sh#L18-L20) 作为 [“工件”](https://buildkite.com/docs/pipelines/artifacts) 到运行它的步骤，无论其是否通过。如果执行失败，此输出笔记本将包含其中的异常或其他错误。

我们使用 [Buildkite 上的公开管道](https://buildkite.com/stellar/stellargraph-public)，因此工件是公开可见的，这意味着拉取请求的作者或其他任何人都可以点击并下载它们以检查问题。

![图示](../Images/326ce690d7d67dab2ec57dffe229d878.png)

*当*[*笔记本在CI中失败*](https://github.com/stellargraph/stellargraph/pull/1215)*时，链接*[*查看失败的笔记本*](https://nbviewer.jupyter.org/urls/buildkite.com/organizations/stellar/pipelines/stellargraph-public/builds/2998/jobs/3203e1e3-77c6-45a5-a1b0-bb2fec15f795/artifacts/0d8d3f6e-f14e-4475-9d08-3921a3db1847)* *会自动*[*添加到构建中*](https://buildkite.com/stellar/stellargraph-public/builds/2998#annotation-gcn-cora-node-classification-example.ipynb-3203e1e3-77c6-45a5-a1b0-bb2fec15f795)*。*

我们还在Buildkite上做了更多的工作。 [Nbviewer](https://nbviewer.jupyter.org/) 可以渲染任何公共的Jupyter笔记本URL，包括这些工件。我们的CI创建了直接在浏览器中查看它们的链接，对于失败的笔记本， [在构建顶部添加了一个注释](https://github.com/stellargraph/stellargraph/blob/59d269a10f207b6b5e5c2b891de8bd3d5408cb3b/.buildkite/steps/test-single-notebook.sh#L35-L43) ，包含该链接。了解问题只需查看失败的构建并点击其中一个高亮链接即可。

### 一致的演示体验

StellarGraph致力于为每个演示提供一致的体验，因为这样可以更容易实现：

+   StellarGraph的用户可以在不同演示之间切换，而无需了解每个演示的特性

+   StellarGraph的开发者编写和编辑笔记本，因为流程的更多部分有预期的行为，并且没有浪费时间在格式化等问题上

+   自动化工具来帮助我们维护演示，因为输入的笔记本更加结构化。

![图像](../Images/653d5801ad9c42d3a69b48ff41a2df28.png)

*笔记本中的Binder按钮，如在*[*使用GCN的入门节点分类演示*](https://github.com/stellargraph/stellargraph/blob/master/demos/node-classification/gcn/gcn-cora-node-classification-example.ipynb)*中那样，可以在不到一分钟的时间内直接将读者带到*[*一个可执行环境*](https://mybinder.org/v2/gh/stellargraph/stellargraph/master?urlpath=lab/tree/demos/node-classification/gcn/gcn-cora-node-classification-example.ipynb)*。*

这其中的基础部分是 [一个自定义脚本](https://github.com/stellargraph/stellargraph/blob/develop/scripts/format_notebooks.py) ，它使用 [nbconvert](https://github.com/jupyter/nbconvert) 来运行一些笔记本预处理器。这些预处理器执行诸如：

+   [使用](https://github.com/stellargraph/stellargraph/blob/59d269a10f207b6b5e5c2b891de8bd3d5408cb3b/scripts/format_notebooks.py#L97-L124) [black](https://github.com/psf/black) 格式化代码

+   [重新编号单元执行计数](https://github.com/stellargraph/stellargraph/blob/59d269a10f207b6b5e5c2b891de8bd3d5408cb3b/scripts/format_notebooks.py#L68-L77)从1开始，以便进行编辑的人可以多次运行和重新运行笔记本，直到它工作正常，并且发布时笔记本仍然显示“In [1], Out [1], In [2], Out [2], …”

+   [为每个笔记本插入适当的链接](https://github.com/stellargraph/stellargraph/blob/59d269a10f207b6b5e5c2b891de8bd3d5408cb3b/scripts/format_notebooks.py#L127-L181) 到 [Binder](https://mybinder.org/) 和 [Google Colab](https://colab.research.google.com/) 云服务，以便在GitHub上查看演示的人可以迅速切换到执行它们。

这个脚本使开发人员可以通过一个命令直接应用所有格式，从而轻松保持笔记本的一致性。不幸的是，使其变得简单只是故事的一半；需要人们*记住*去做这件事，这意味着它偶尔会被遗忘。

这里的解决方案与运行笔记本时相同：检查CI上的格式。我们的脚本通过一个模式支持这一点，该模式将笔记本重新格式化到一个临时路径，然后 [对比重新格式化的笔记本](https://github.com/stellargraph/stellargraph/blob/59d269a10f207b6b5e5c2b891de8bd3d5408cb3b/scripts/format_notebooks.py#L393-L394) 与原始笔记本：它们应该是相同的。

![图](../Images/93c071d8a1cbbb6416dc95c3b9130061.png)

*当 *[*笔记本格式不正确*](https://github.com/stellargraph/stellargraph/pull/1215)*时，CI构建会被 *[*注释*](https://buildkite.com/stellar/stellargraph-public/builds/2998#annotation-format_notebooks)* 列出这些笔记本以及修复命令。*

如果有差异，脚本会 [添加注释](https://github.com/stellargraph/stellargraph/blob/59d269a10f207b6b5e5c2b891de8bd3d5408cb3b/scripts/format_notebooks.py#L426-L435) 到 [构建](https://buildkite.com/stellar/stellargraph-public/builds/2998#annotation-format_notebooks) 中，建议适当的修复命令。

### 结论

[StellarGraph](https://github.com/stellargraph/stellargraph) 以 [其演示](https://github.com/stellargraph/stellargraph/tree/develop/demos) 为荣，我们依赖自动化来保持它们的质量，即使在快速变化的项目中也能做到这一点，因为我们正在准备1.0版本。我们通过ReviewNB获得了良好的审查体验，并在笔记本无法运行或格式不当时收到警报。所有这些都发生在任何更改落地之前，问题通过Buildkite CI的方便链接和建议修复进行标记。

我们的所有代码都是 [开源](https://github.com/stellargraph/stellargraph) 的，因此我们希望通过共享，其他人可以将数据科学和软件工程的世界结合起来，并看到两者的好处。

使用我们演示的 [基于图卷积网络的节点分类](https://github.com/stellargraph/stellargraph/blob/master/demos/node-classification/gcn/gcn-cora-node-classification-example.ipynb) 开始在StellarGraph库中进行图机器学习。

*StellarGraph 的 CI 工作主要由*[*Tim Pitman*](https://github.com/timpitman)* 完成，*[*胡恩·威尔逊*](https://github.com/huonw)* 也有贡献。格式化脚本主要由*[*Andrew Docherty*](https://github.com/adocherty)* 编写，Tim 和 Huon 有所扩展。*[*Denis Khoshaba*](https://github.com/TheDen)* 负责确保我们的 CI 和基础设施顺利运行。为了让 papermill 在 CI 上表现得更好，Huon *[*贡献了几处调整*](https://github.com/nteract/papermill/pulls?q=is%3Apr+author%3Ahuonw+)*。*

*这项工作得到了 CSIRO 的 Data61 支持，Data61 是澳大利亚领先的数字研究网络。*

**简历： [胡恩·威尔逊](https://www.linkedin.com/in/huon-wilson/)** 是一名具有深厚数学和统计学背景的软件工程师，拥有在编译器等低级系统编程领域的丰富经验，以及 C++、C 等语言的经验，甚至还有 Rust 等更为独特的语言。在更高层次，他在 R 和 Python 的数值编程方面也有经验，掌握了大多数编程语言范式和软件工程的许多其他领域。

[原文](https://medium.com/stellargraph/better-notebooks-through-ci-automatically-testing-documentation-for-graph-machine-learning-5789e277e597)。经授权转载。

**相关：**

+   [图神经网络模型校准以获得可信预测](/2020/03/graph-neural-network-model-calibration-trusted-predictions.html)

+   [可扩展的图机器学习：我们可以攀登的高峰？](/2019/12/scalable-graph-machine-learning.html)

+   [图机器学习与 UX 的相遇：一段未探索的情感故事](/2020/01/graph-machine-learning-ux.html)

* * *

## 我们的前三个课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [谷歌网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速进入网络安全职业生涯。

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [谷歌数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升您的数据分析技能

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [谷歌 IT 支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持您的组织的 IT 需求

* * *

### 更多相关话题

+   [良好的数据科学项目文档的 5 条规则](https://www.kdnuggets.com/2022/12/5-rules-good-data-science-project-documentation.html)

+   [如何使用机器学习自动标记数据](https://www.kdnuggets.com/2022/02/machine-learning-automatically-label-data.html)

+   [假设检验与 A/B 测试](https://www.kdnuggets.com/hypothesis-testing-and-ab-testing)

+   [2022 年十大免费云笔记本](https://www.kdnuggets.com/2022/04/top-5-free-cloud-notebooks-2022.html)

+   [来自 Anaconda 的新动态！数据科学培训和云托管笔记本](https://www.kdnuggets.com/2022/11/anaconda-new-anaconda-data-science-training-cloud-hosted-notebooks.html)

+   [数据科学的7款免费云笔记本](https://www.kdnuggets.com/top-7-free-cloud-notebooks-for-data-science)
