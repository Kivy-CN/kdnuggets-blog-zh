["```py\nvirtualenv my_env --python=python3.8\nsource my_env/bin/activate\n```", "```py\npip install transformers\npip install datasets\npip install faiss-cpu==1.8.0\n#https://pytorch.org/get-started/locally/ to \n#match the pytorch version to your system\npip install torch\n```", "```py\nfrom transformers import RagTokenizer, RagRetriever\nfrom transformers import RagTokenForGeneration\nfrom transformers import RagSequenceForGeneration\n```", "```py\n# in the shell:\nexport HF_DATASETS_CACHE=\"/path/to/data/drive\"\n# ^^ add to your ~/.bashrc file if you want to set the variable\n```", "```py\ntokenizer = RagTokenizer.from_pretrained(\\\n\"facebook/rag-token-nq\")\n\ntoken_retriever = RagRetriever.from_pretrained(\\\n\"facebook/rag-token-nq\", \\\n     index_name=\"compressed\", \\\nuse_dummy_dataset=False)\nsequence_retriever = RagRetriever.from_pretrained(\\\n\"facebook/rag-sequence-nq\", \\\n     index_name=\"compressed\", \\\nuse_dummy_dataset=False)\n\ndummy_retriever = RagRetriever.from_pretrained(\\\n\"facebook/rag-sequence-nq\", \\\n   index_name=\"exact\", \\\nuse_dummy_dataset=True)\n\ntoken_model = RagTokenForGeneration.from_pretrained(\\\n\"facebook/rag-token-nq\", \\\n     retriever=token_retriever)\nseq_model = RagTokenForGeneration.from_pretrained(\\\n\"facebook/rag-sequence-nq\", \\\n     retriever=seq_retriever)\ndummy_model = RagTokenForGeneration.from_pretrained(\\\n\"facebook/rag-sequence-nq\", \\\n   retriever=dummy_retriever)\n```", "```py\nquery = \"what is the name of the oldest tree on Earth?\"\ninput_dict = tokenizer.prepare_seq2seq_batch(\\\nquery, return_tensors=\"pt\")\n\ntoken_generated = token_model.generate(**input_dict)  token_decoded = token_tokenizer.batch_decode(\\\ntoken_generated, skip_special_tokens=True)\n\nseq_generated = seq_model.generate(**input_dict)\nseq_decoded = seq_tokenizer.batch_decode(\\\nseq_generated, skip_special_tokens=True)\n\ndummy_generated = dummy_model.generate(**input_dict)\ndummy_decoded = seq_tokenizer.batch_decode(\\\ndummy_generated, skip_special_tokens=True)\n\nprint(f\"answers to query '{query}': \")\nprint(f\"\\t rag-sequence-nq: {seq_decoded[0]},\"\\\nf\" rag-token-nq: {token_decoded[0]},\"\\\nf\" rag (dummy): {dummy_decoded[0]}\")\n```", "```py\n>> answers to query 'What is the name of the oldest tree on Earth?': Prometheus was the oldest tree discovered until 2012, with its innermost, extant rings exceeding 4862 years of age.\n\n>> rag-sequence-nq:  prometheus, rag-token-nq:  prometheus, rag (dummy):  4862\n```", "```py\nquery = \"what is the name of the oldest tree on Earth?\"\ninputs = tokenizer(query, return_tensors=\"pt\")\ninput_ids = inputs[\"input_ids\"]\n\nquestion_hidden_states = seq_model.question_encoder(input_ids)[0]\n\ndocs_dict = seq_retriever(input_ids.numpy(),\\\nquestion_hidden_states.detach().numpy(),\\\nreturn_tensors=\"pt\")\ndoc_scores = torch.bmm(\\\nquestion_hidden_states.unsqueeze(1),\\\ndocs_dict[\"retrieved_doc_embeds\"]\\\n.float().transpose(1, 2)).squeeze(1)\n\ngenerated = model.generate(\\\ncontext_input_ids=docs_dict[\"context_input_ids\"],\\\ncontext_attention_mask=\\\ndocs_dict[\"context_attention_mask\"],\\\ndoc_scores=doc_scores)\n\ngenerated_string = tokenizer.batch_decode(\\\ngenerated,\\\nskip_special_tokens=True)\n\ncontexts = tokenizer.batch_decode(\\\ndocs_dict[\"context_input_ids\"],\\\nattention_mask=docs_dict[\"context_attention_mask\"],\\\nskip_special_tokens=True)\n\nbest_context = contexts[doc_scores.argmax()]\n```", "```py\nprint(f\" based on the retrieved context\"\\\nf\":\\n\\n\\t {best_context}: \\n\")\n```", "```py\nPrometheus (tree) / In a clonal organism, however, the individual clonal stems are not nearly so old, and no part of the organism is particularly old at any given time. Until 2012, Prometheus was thus the oldest \"non-clonal\" organism yet discovered, with its innermost, extant rings exceeding 4862 years of age. In the 1950s dendrochronologists were making active efforts to find the oldest living tree species in order to use the analysis of the rings for various research purposes, such as the evaluation of former climates, the dating of archaeological ruins, and addressing the basic scientific question of maximum potential lifespan. Bristlecone pines // what is the name of the oldest tree on earth?\n```", "```py\nprint(f\" rag-sequence-nq answers '{query}'\"\\\nf\" with '{generated_string[0]}'\")\n```"]