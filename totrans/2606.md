# Shapash: 使机器学习模型易于理解

> 原文：[https://www.kdnuggets.com/2021/04/shapash-machine-learning-models-understandable.html](https://www.kdnuggets.com/2021/04/shapash-machine-learning-models-understandable.html)

[评论](#comments)

**作者 [Yann Golhen](https://twitter.com/GolhenY)，MAIF，首席数据科学家**。

![](../Images/51fc6f2804c9a06c9bd2adee12ade00b.png)

*[Shapash Web App 演示](https://shapash-demo.ossbymaif.fr/)*

[Shapash](https://github.com/MAIF/shapash) 由 [MAIF](https://www.maif.fr/) 提供，是一个帮助数据科学家理解机器学习模型的 Python 工具包。它使得与非数据专家（如业务分析师、经理和最终用户）分享和讨论模型可解释性变得更加容易。

实际上，Shapash 提供了易于阅读的可视化和一个 [Web 应用](https://shapash-demo.ossbymaif.fr/)。Shapash 使用适当的措辞展示结果（如预处理逆向/后处理）。Shapash 在操作上下文中非常有用，因为它使数据科学家能够从探索到生产阶段使用可解释性：你可以轻松地在生产环境中部署本地可解释性，为每个预测/推荐补充本地可解释性的摘要。

在这篇文章中，我们将介绍 Shapash 的主要功能及其操作方式。我们将通过具体用例来说明该库的实现。

### 上下文要素

模型的可解释性和可说明性是热门话题。关于这些话题有很多文章、出版物和开源贡献。所有这些贡献并未涉及相同的问题和挑战。

大多数数据科学家使用这些技术有很多原因：为了更好地理解他们的模型，检查模型的一致性和公平性，以及进行调试。

然而，这还有更多内容：

> *可理解性对教学目的很重要。可理解的机器学习模型可以与非数据专家（如业务分析师、最终用户等）进行辩论…*

实际上，在我们的数据科学项目中，有两个步骤涉及非专家：

**探索性步骤 & 模型拟合**

在这一步，数据科学家和业务分析师讨论风险，并定义他们将集成到项目中的重要数据。这需要对主题有深入了解，并理解我们建模问题的主要驱动因素。

为此，数据科学家研究全球可解释性、特征重要性以及模型的主要特征所起的作用。他们还可以局部地查看一些个体，特别是离群值。此阶段的 Web 应用很有趣，因为他们需要查看可视化和图形。与业务分析师讨论这些结果有助于挑战方法并验证模型。

**在生产环境中部署模型**

就这样！模型已经验证、部署，并给最终用户提供了预测。局部可解释性可以为他们带来很大价值，前提是能够提供一个良好、有用且易于理解的总结。这对他们来说有两个方面的价值：

+   透明度带来信任：他们会信任模型，如果他们理解模型。

+   人类保持控制：没有模型是 100% 可靠的。当用户能够理解算法的输出时，如果他们认为数据不正确，他们可以推翻算法建议。

Shapash 的开发旨在帮助数据科学家满足这些需求。

![](../Images/fecdf3e40f045d5ad620d22a65d0dab2.png)

### Shapash 的主要特点

+   易于阅读的可视化，适合所有人。

+   一个网页应用程序：要理解模型的工作原理，你需要查看多个图表、特征重要性以及特征对模型的全局贡献。网页应用程序是一个有用的工具。

+   几种方法展示结果，并用适当的措辞（预处理逆转，后处理）。你可以轻松添加数据字典、*category-encoders* 对象或 sklearn *ColumnTransformer* 以获得更明确的输出。

+   轻松保存 *Pickle* 文件和将结果导出为表格的功能。

+   可解释性总结：总结是可配置的，以适应你的需求，并关注局部可解释性中的重点。

+   能够轻松部署到生产环境，并为每个操作应用程序（批处理或 API）完成每个预测/推荐的局部可解释性总结。

+   Shapash 允许多种操作方式：它可以用于轻松访问结果或改进措辞。显示结果所需的参数非常少。但你在清理和记录数据集时做得越多，结果对最终用户就会越清晰。

Shapash 适用于回归、二分类或多分类问题。它与许多模型兼容：*Catboost*、*Xgboost*、*LightGBM*、*Sklearn Ensemble*、*线性模型*、*SVM*。

Shapash 基于通过 Shap（Shapley 值）、Lime 或任何允许计算可汇总局部贡献的技术计算的局部贡献。

### 安装

你可以通过 pip 安装这个包：

[PRE0]

### Shapash 演示

让我们在一个具体的数据集上使用 Shapash。接下来的文章中，我们将展示 Shapash 如何探索模型。

我们将使用来自 [Kaggle](https://www.kaggle.com/c/house-prices-advanced-regression-techniques) 的著名“房价”数据集来拟合回归模型并预测房价！让我们先加载数据集：

[PRE1]

![](../Images/20e1aaad4f5cddcee1e4273d8f4aa92d.png)

编码分类特征：

[PRE2]

训练、测试拆分和模型拟合：

[PRE3]

并预测测试数据：

[PRE4]

### 让我们发现并使用 Shapash SmartExplainer。

*步骤 1 — 导入*

[PRE5]

*步骤 2 — 初始化 SmartExplainer 对象*

[PRE6]

+   features_dict: dict，指定 x pd.DataFrame 中每列名称的含义。

*步骤 3 — 编译*

[PRE7]

编译方法允许使用另一个可选参数：*postprocess.* 它提供了应用新函数的可能性，以便获得更好的措辞（正则表达式、映射字典等）。

现在，我们可以展示结果并理解回归模型是如何工作的！

*步骤 4 — 启动网页应用程序*

[PRE8]

网页应用程序的链接显示在 Jupyter 输出中（访问演示 [这里](https://shapash-demo.ossbymaif.fr/)）。

**这个网页应用程序有四个部分：**

![](../Images/fed8547ee11acd20063b0ea415d750eb.png)

每个图都有助于轻松探索模型。

***特征重要性*****:** 你可以点击每个特征以更新下面的贡献图。

***贡献图*****:** 特征如何影响预测？展示特征每个本地贡献的提琴图或散点图。

***本地图：***

+   本地解释：哪些特征对预测值贡献最大。

+   你可以使用多个按钮/滑块/列表来配置本地可解释性的总结。我们将下面使用*filter*方法描述你可以用来配置总结的不同参数。

+   这个网页应用程序是一个有用的工具，用于与业务分析师讨论如何总结可解释性以满足操作需求。

***选择表格：*** 它允许网页应用程序用户选择：

+   一个子集以集中探索此子集

+   单行显示相关的本地解释

如何使用数据表选择子集？在表格的顶部，即你想用来过滤的列名下方，指定：

+   *=值, >值, <值*

+   *如果你想选择每一行包含特定单词的行，只需输入该单词，无需使用“=”*

这个网页应用程序上有几个选项（右上角按钮）。最重要的可能是样本的大小（默认值：1000）。为了避免延迟，网页应用程序依赖样本来显示结果。使用这个选项可以修改样本大小。

关闭应用程序：

[PRE9]

*步骤 5 — 图表*

所有的图表都可以在 Jupyter notebooks 中查看，下面的段落描述了每个图表的要点。

**特征重要性**

这个参数允许比较子集的特征重要性。这对于检测子集中的特定行为很有用。

[PRE10]

![](../Images/63a1ec40bd82fef446f805462e1b6c03.png)

**贡献图**

贡献图用于回答类似的问题：

特征如何影响我的预测？它是否有积极贡献？该特征的贡献是越来越多还是越来越少？是否存在阈值效应？对于分类变量，每种模式的贡献如何？这个图展示了特征的重要性，以便于解释模型，从而更好地理解特征对模型的影响。

这个图有几个参数。请注意，显示的图表会根据您对分类变量还是连续变量（小提琴图或散点图）以及您所处理的用例类型（回归、分类）而有所不同。

[PRE11]

![](../Images/d361f2b143a435b2e754e9f26f978b40.png)

对连续特征应用的贡献图。

分类案例：泰坦尼克号分类器 — 对分类特征应用的贡献图。

![](../Images/8e8f2b9b10e345aaf31c24e2f09765e6.png)

![](../Images/dc03bafa2582a69592c94f8d65ff3311.png)

**局部图**

您可以使用局部图来进行模型的局部可解释性分析。

*filter()*和*local_plot()*方法允许您测试和选择最佳方式来总结模型所捕捉的信号。您可以在探索阶段使用它。然后，您可以将此总结部署到生产环境中，以便终端用户在几秒钟内理解每个推荐的最具影响力的标准。

我们将发布第二篇文章，解释如何在生产环境中部署局部可解释性。

**结合 filter 和 local_plot 方法**

使用*filter*方法来指定如何总结局部可解释性。您可以配置四个参数来总结您的内容：

+   max_contrib: 显示的标准最大数量

+   threshold: 显示标准所需的贡献的最小值（绝对值）

+   positive: 仅显示正贡献？负贡献？（默认值为 None）

+   features_to_hide: 您不想显示的特征列表

在定义这些参数后，我们可以使用*local_plot()*方法来显示结果，或使用*to_pandas()*方法导出结果。

[PRE12]

![](../Images/d03e113c530d150bab918467be11a2ff.png)

导出到 pandas DataFrame：

[PRE13]

![](../Images/61069feea112c819793560776973a889.png)

**比较图**

使用*compare_plot()*方法，SmartExplainer 对象可以帮助您理解为什么两个或更多个体的预测值不同。最关键的标准会出现在图表的顶部。

[PRE14]

![](../Images/5ebef70c948abff403a8f237c1017e12.png)

我们希望 Shapash 能在建立对 AI 的信任方面发挥作用。感谢所有将提供反馈和建议的人…… Shapash 是开源的！欢迎通过评论此帖子或直接在[GitHub 讨论区](https://github.com/MAIF/shapash/discussions)来贡献您的意见。

[原文](https://pub.towardsai.net/shapash-making-ml-models-understandable-by-everyone-8f96ad469eb3)。经许可转载。

**相关：**

+   [白盒 AI 介绍：可解释性的概念](https://www.kdnuggets.com/2021/03/introduction-white-box-ai-interpretability.html)

+   [深度学习不必是一个黑箱](https://www.kdnuggets.com/2021/02/deep-learning-not-black-box.html)

+   [解释可解释 AI: 两阶段方法](https://www.kdnuggets.com/2020/10/explaining-explainable-ai.html)

* * *

## 我们的前三个课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [谷歌网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速进入网络安全职业的捷径。

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [谷歌数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升您的数据分析能力

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [谷歌 IT 支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持您的组织的 IT

* * *

### 更多相关话题

+   [每个初学者数据科学家应该掌握的 6 个预测模型](https://www.kdnuggets.com/2021/12/6-predictive-models-every-beginner-data-scientist-master.html)

+   [成为优秀数据科学家所需的 5 项关键技能](https://www.kdnuggets.com/2021/12/5-key-skills-needed-become-great-data-scientist.html)

+   [2021 年最佳 ETL 工具](https://www.kdnuggets.com/2021/12/mozart-best-etl-tools-2021.html)

+   [停止学习数据科学以寻找目标，并通过寻找目标来…](https://www.kdnuggets.com/2021/12/stop-learning-data-science-find-purpose.html)

+   [学习数据科学统计的最佳资源](https://www.kdnuggets.com/2021/12/springboard-top-resources-learn-data-science-statistics.html)

+   [成功数据科学家的 5 个特征](https://www.kdnuggets.com/2021/12/5-characteristics-successful-data-scientist.html)
