# 成为 Pandas 大师，掌握 Python 数据操作库

> 原文：[https://www.kdnuggets.com/2019/06/pro-pandas-python-library.html](https://www.kdnuggets.com/2019/06/pro-pandas-python-library.html)

![c](../Images/3d9c022da2d331bb56691a9617b91b90.png) [评论](#comments)

**由 [Julien Kervizic](https://www.linkedin.com/in/julienkervizic/)，GrandVision NV 高级企业数据架构师**

Pandas 库是 Python 中最受欢迎的数据操作库。它通过数据框 API 提供了一种简便的数据操作方式，灵感来自 R 的数据框。

![Figure](../Images/73e3a95f3d1080b63b095ed1c8a7ae81.png)照片由 [Damian Patkowski](https://unsplash.com/@damianpatkowski?utm_source=medium&utm_medium=referral) 供图，来源于 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral)

### 理解 Pandas 库

理解 Pandas 的关键之一是要明白 Pandas 大多数情况下是对一系列其他 Python 库的封装。主要的库包括 Numpy、SQLAlchemy、Matplotlib 和 openpyxl。

数据框的核心内部模型是一系列 numpy 数组，Pandas 函数如现在已弃用的 “as_matrix” 返回的结果就是这种 [内部表示](https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.as_matrix.html)。

Pandas 利用其他库将数据输入和输出到数据框中，例如，通过 read_sql 和 to_sql 函数使用 SQLAlchemy，而 openpyxl 和 xlsx writer 则用于 read_excel 和 to_excel 函数。

Matplotlib 和 Seaborn 用于提供一个简单的接口来绘制数据框中的信息，使用诸如 df.plot() 这样的命令。

### Numpy 的 Pandas——高效的 Pandas

你经常听到的抱怨之一是 Python 速度慢或难以处理大量数据。大多数时候，这是由于编写的代码效率不高。确实，原生 Python 代码通常比编译代码慢，但像 Pandas 这样的库有效地提供了 Python 代码到编译代码的接口。了解如何正确地与之接口，可以让我们充分发挥 Pandas/Python 的优势。

**应用矢量化操作**

Pandas，像其底层库 Numpy 一样，比起执行循环，执行矢量化操作更高效。这些效率源于矢量化操作通过 C 编译代码而非原生 Python 代码来执行，以及矢量化操作能够在整个数据集上进行操作。

apply 接口通过使用 CPython 接口进行循环来提高一些效率：

```py
df.apply(lambda x: x['col_a'] * x['col_b'], axis=1)
```

但大部分性能提升来自于直接使用矢量化操作，无论是在 Pandas 中还是直接调用其内部 Numpy 数组。

![](../Images/3c9be232f2b5ca462463b089f4509c23.png)

正如上图所示，性能差异可能非常显著，处理方式不同（向量化操作 3.53ms 与使用 Apply 循环进行加法 27.8s）。通过直接调用 numpy 的数组和 API 可以获得额外的效率，例如：

![](../Images/e1dd6e05293f2014c3a4a6e11a84edfb.png)

***Swifter:*** Swifter 是一个 Python 库，它使得对数据框进行不同类型的操作的向量化变得容易，它的 API 与 Apply 函数非常相似。

**通过数据类型高效存储数据**

在将数据框加载到内存中时，无论是通过 read_csv、read_excel 还是其他数据框读取函数，SQL 都会进行类型推断，这可能会效率低下。这些 API 允许你显式指定每列的数据类型。这使得在内存中存储数据更加高效。

```py
df.astype({'testColumn': str, 'testCountCol': float})
```

数据类型（dtypes）是 [Numpy](https://docs.scipy.org/doc/numpy/reference/arrays.dtypes.html) 的本地对象，它允许你定义存储特定信息所使用的确切类型和位数。

Numpy 的数据类型 `np.dtype('int32')` 例如表示一个 32 位长的整数。Pandas 默认使用 64 位整数，我们可以通过使用 32 位来节省一半的空间：

![](../Images/46631fef435c478ae884ed86433f6d70.png)

memory_usage() 显示了每一列使用的字节数，由于每列只有一条记录（行），因此每个 int64 列的大小为 8 字节，int32 列为 4 字节。

Pandas 还引入了分类数据类型（categorical dtype），这可以有效利用内存来存储经常出现的值。在下面的例子中，我们可以看到，当将字段 posting_date 转换为分类值时，内存使用量减少了 28 倍。

![](../Images/62ebd44ecf864e7bdcdfee1279cbb88a.png)

在我们的例子中，仅通过更改数据类型，数据框的总体大小就减少了超过 3 倍：

![](../Images/b72d530479acbb713a57679d26728ca8.png)

不仅使用正确的数据类型允许你在内存中处理更大的数据集，而且还使某些计算变得更加高效。在下面的例子中，我们可以看到，使用分类类型使 groupby/sum 操作的速度提高了 3 倍。

![](../Images/f3fefdc673f8c61cb4e5c7bd636b5806.png)

在 Pandas 中，你可以在数据加载（read_）期间定义数据类型，或作为类型转换（astype）进行定义。

***CyberPandas:*** [CyberPandas](https://www.anaconda.com/cyberpandas-extending-pandas-with-richer-types/) 是其中一个不同的库扩展，它通过支持 ipv4 和 ipv6 数据类型并高效存储它们，从而实现了更丰富的数据类型。

**处理大型数据集的方法**

Pandas 允许按块加载数据框，因此可以将数据框作为迭代器处理，并能够处理比可用内存更大的数据框。

![](../Images/cef1c6aae090dae3a12db27756c65cd4.png)

在读取数据源时定义 chunksize 并使用 get_chunk 方法的组合，使 Pandas 能够将数据处理为 [迭代器](https://www.w3schools.com/python/python_iterators.asp)。例如，在上述示例中，数据框每次读取 2 行。这些块可以被迭代：

```py
i = 0
for a in df_iter:
  # do some processing  chunk = df_iter.get_chunk()
  i += 1
  new_chunk = chunk.apply(lambda x: do_something(x), axis=1)
  new_chunk.to_csv("chunk_output_%i.csv" % i )
```

结果可以导出到 csv 文件、进行 pickle 操作、导出到数据库等…

通过分块设置操作符还允许通过 [多进程](https://docs.python.org/2/library/multiprocessing.html)执行某些操作。

***Dask:*** 这是一个建立在 Pandas 之上的框架，设计时考虑了多进程和分布式处理。它利用了内存和磁盘上的 Pandas 数据框集合。

### SQL Alchemy 的 Pandas — 数据库 Pandas

Pandas 还建立在 SQLAlchemy 之上以与数据库接口，因此它能够从各种 SQL 类型的数据库下载数据集以及推送记录。直接使用 SQLAlchemy 接口（而不是 Pandas API）允许我们进行某些 Pandas 本身不支持的操作，如事务或 upserts：

**SQL 事务**

Pandas 还可以利用 SQL 事务，处理提交和回滚。Pedro Capelastegui 在他的一个 [博客文章](https://capelastegui.wordpress.com/2018/05/21/commit-and-rollback-with-pandas-dataframe-to_sql/)中解释了 Pandas 如何通过 SQLAlchemy 上下文管理器利用事务。

```py
with engine.begin() as conn:
  df.to_sql(
    tableName,
    con=conn,
    ...
  )
```

使用 SQL 事务的优势在于，如果数据加载失败，事务会回滚。

**SQL 扩展**

***PandaSQL***

Pandas 有一些 SQL 扩展，如 [pandasql](https://pypi.org/project/pandasql/)，这是一个允许对数据框进行 SQL 查询的库。通过 pandasql，可以像查询数据库表一样直接查询数据框对象。

![](../Images/6be752d989ff587a20fab8e397687efd.png)

***SQL UPSERTs***

Pandas 本身不支持将 upsert 导出到支持此功能的 SQL 数据库。[Pandas 的补丁](https://github.com/ryanbaumann/Pandas-to_sql-upsert) 使这个功能成为可能。

### MatplotLib/Seaborn — 视觉 Pandas

Matplotlib 和 Seaborn 可视化已经在某些数据框 API 中集成，例如通过 .plot 命令。有一个相当全面的文档说明接口的工作原理，可以在 [Pandas 网站](https://pandas.pydata.org/pandas-docs/version/0.22/visualization.html)上查看。

**扩展：** 存在不同的扩展，如 Bokeh 和 plotly，可以在 Jupyter notebooks 中提供交互式可视化，同时也可以扩展 matplotlib 以处理 [3D 图形](https://pythonprogramming.net/3d-graphing-pandas-matplotlib/)。

### 其他扩展

还有许多其他的Pandas扩展，用于处理非核心功能。其中之一是`tqdm`，它为某些操作提供进度条功能，另一个是`pretty Pandas`，它允许格式化数据框并添加汇总信息。

***tqdm***

`tqdm` 是Python中的一个进度条扩展，能够与Pandas交互，它允许用户在使用相关函数（progress_map和progress_apply）时查看Pandas数据框的操作进度：

![](../Images/f0fd3706d7d79e11c99e728aa4dee228.png)

***PrettyPandas***

[PrettyPandas](https://github.com/HHammond/PrettyPandas)是一个库，提供了一种简便的方法来格式化数据框并为其添加表格摘要：

![](../Images/70e929ab46a99eaee395d8067e2f2abf.png)

**简介： [Julien Kervizic](https://www.linkedin.com/in/julienkervizic/)** 是GrandVision NV的高级企业数据架构师。

[原文](https://medium.com/analytics-and-data/become-a-pro-at-pandas-pythons-data-manipulation-library-264351b586b1)。经许可转载。

**相关：**

+   [Pandas DataFrame 索引](/2019/04/pandas-dataframe-indexing.html)

+   [初学者数据可视化与探索使用Pandas](/2018/10/beginner-data-visualization-exploration-using-pandas-beginner.html)

+   [Python数据准备案例文件：基于组的插补](/2017/09/python-data-preparation-case-files-group-based-imputation.html)

* * *

## 我们的前三大课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [谷歌网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速进入网络安全职业生涯。

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [谷歌数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升你的数据分析能力

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [谷歌IT支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持组织的IT需求

* * *

### 更多相关内容

+   [像专业人士一样测试：Python的Mock库逐步指南](https://www.kdnuggets.com/testing-like-a-pro-a-step-by-step-guide-to-pythons-mock-library)

+   [可以帮助你成为专业人士的免费Python资源](https://www.kdnuggets.com/free-python-resources-that-can-help-you-become-a-pro)

+   [用于数据访问、处理和管理的10个Pandas一行代码](https://www.kdnuggets.com/2023/01/pandas-one-liners-data-access-manipulation-management.html)

+   [数据处理的必备Python库](https://www.kdnuggets.com/essential-python-libraries-for-data-manipulation)

+   [8个最佳Python图像处理工具](https://www.kdnuggets.com/2022/11/8-best-python-image-manipulation-tools.html)

+   [Pandas AI：生成性AI Python库](https://www.kdnuggets.com/2023/05/pandas-ai-generative-ai-python-library.html)
