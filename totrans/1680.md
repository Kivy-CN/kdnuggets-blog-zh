# 数据工程入门指南 – 第二部分

> 原文：[https://www.kdnuggets.com/2018/03/beginners-guide-data-engineering-part-2.html/2](https://www.kdnuggets.com/2018/03/beginners-guide-data-engineering-part-2.html/2)

![c](../Images/3d9c022da2d331bb56691a9617b91b90.png) [评论](/2018/03/beginners-guide-data-engineering-part-2.html?page=2#comments)

### Airflow 流水线的结构

![](../Images/b3883f7be24a82be7a7c39fb4e3216e7.png)

现在我们已经了解了事实表、维度表、日期分区的概念以及数据回填的含义，让我们把这些概念具体化，并将它们应用到实际的 Airflow ETL 任务中。

* * *

## 我们的三大课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [谷歌网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速进入网络安全职业的快车道

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [谷歌数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升您的数据分析能力

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [谷歌 IT 支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持您的组织的 IT 工作

* * *

**定义有向无环图 (DAG)**

正如我们在 [早期的文章](https://medium.com/@rchang/a-beginners-guide-to-data-engineering-part-i-4227c5c457d7)中提到的，任何 ETL 任务，其核心都是建立在三个基本构件之上：**E**xtract、**T**ransform 和 **L**oad。尽管在概念上听起来很简单，但实际中的 ETL 任务通常很复杂，由许多 E、T 和 L 任务的组合构成。因此，使用图形来可视化复杂的数据流往往是有用的。在视觉上，图中的一个 *节点* 代表一个任务，而 *箭头* 代表一个任务对另一个任务的依赖。鉴于数据只需在给定任务上计算一次，计算结果会向前传递，因此图是 *有向* 和 *无环* 的。这就是为什么 Airflow 任务通常被称为“DAG”（**D**irected **A**cyclic **G**raphs）的原因。

![](../Images/9c6359d1c3dedca683467b64d23bcb98.png)

[来源](https://medium.com/airbnb-engineering/https-medium-com-jonathan-parks-scaling-erf-23fd17c91166)：Airbnb 实验报告框架 DAG 的截图

Airflow UI 的一个聪明设计是它允许任何用户通过 [图形视图](https://airflow.apache.org/ui.html#graph-view) 来可视化 DAG，使用代码作为配置。数据管道的作者必须定义任务之间依赖关系的结构，以便进行可视化。这种规范通常写在一个叫做 *DAG 定义文件* 的文件中，描述了 Airflow 任务的结构。

**操作符：传感器、操作符和传输**

虽然 DAG 描述了 *如何* 运行数据管道，操作符则描述了 *在* 数据管道中要做 *什么*。通常，操作符有三大类：

+   **Sensors:** 等待特定时间、外部文件或上游数据源

+   **Operators:** 触发某个动作（例如，运行bash命令、执行python函数或执行Hive查询等）

+   **Transfers:** 将数据从一个位置移动到另一个位置

敏锐的读者可能会看到这些操作符如何对应于**E**xtract，

**T**ransform和**L**oad步骤，我们之前讨论过的。

**Sensors** 在经过一定时间后或当来自上游数据源的数据可用时，解除数据流的阻塞。在Airbnb，由于我们大多数ETL作业涉及Hive查询，我们经常使用`[NamedHivePartitionSensors](https://github.com/apache/incubator-airflow/blob/master/airflow/sensors/named_hive_partition_sensor.py)`检查Hive表的最新分区是否可用于下游处理。

**Operators** 触发数据转换，这对应于**T**ransform步骤。由于Airflow是开源的，贡献者可以[扩展](https://github.com/apache/incubator-airflow/tree/master/airflow/operators) `BaseOperator`类以创建自定义操作符。在Airbnb，我们最常用的操作符是`[HiveOperator](https://github.com/apache/incubator-airflow/blob/master/airflow/operators/hive_operator.py#L22)`（用于执行Hive查询），但我们也经常使用`[PythonOperator](https://github.com/apache/incubator-airflow/blob/master/airflow/operators/python_operator.py)`（例如，运行Python脚本）和`[BashOperator](https://github.com/apache/incubator-airflow/blob/master/airflow/operators/bash_operator.py)`（例如，运行bash脚本或甚至一个复杂的Spark作业）。这里的可能性是无穷的！

最后，我们还有特殊的操作符，**Transfers** 数据从一个地方到另一个地方，这通常映射到ETL中的**L**oad步骤。在Airbnb，我们经常使用`[MySqlToHiveTransfer](https://github.com/apache/incubator-airflow/blob/master/airflow/operators/mysql_to_hive.py)`或`[S3ToHiveTransfer](https://github.com/apache/incubator-airflow/blob/master/airflow/operators/s3_to_hive_operator.py)`，但这在很大程度上取决于数据基础设施和数据仓库的位置。

**一个简单的示例**

以下是一个简单示例，演示如何定义DAG定义文件、实例化Airflow DAG，并使用我们上述描述的各种操作符来定义相应的DAG结构。

当DAG被渲染时，我们会看到以下图形视图：

![](../Images/8c6afb760a294b42682b86dae4f3237f.png)

玩具示例DAG的图形视图

### ETL最佳实践指南

![](../Images/2027a30a151a5a2c88b0ff1cdd567049.png)

[图片来源](http://www.omen-azen.com/eat-together-1/)：打造你的技艺需要实践，因此遵循最佳实践是明智的。

像任何工艺一样，编写简洁、可读和可扩展的 Airflow 作业需要实践。在我第一次工作时，ETL 对我来说只是需要完成的一系列单调机械的任务。我没有将其视为一种工艺，也不知道最佳实践。在 Airbnb，我学到了很多最佳实践，并开始欣赏良好的 ETL 及其美妙之处。下面，我列出了良好 ETL 管道应该遵循的一些原则：

+   **划分数据表：**正如我们之前提到的，数据划分在处理历史较长的大型表时特别有用。当使用日期戳进行数据划分时，我们可以利用动态分区来并行化补全数据。

+   **增量加载数据：**这一原则使你的 ETL 更加模块化和可管理，特别是在从事实表构建维度表时。在每次运行中，我们只需要将新交易附加到来自前一个日期分区的维度表，而不是扫描整个事实历史。

+   **强制幂等性：**许多数据科学家依赖于时间点快照进行历史分析。这意味着基础源表在时间推移过程中不应该是可变的，否则我们将得到不同的答案。管道应该构建成相同的查询在相同的业务逻辑和时间范围内返回相同的结果。这个特性被称为幂等性。

+   **参数化工作流：**就像模板大大简化了 HTML 页面的组织一样，Jinja 可以与 SQL 配合使用。如前所述，Jinja 模板的一种常见用法是将补全逻辑融入到典型的 Hive 查询中。[Stitch Fix](https://www.google.com/search?q=stitchfix+jinja&oq=stitchfix+jinja&aqs=chrome..69i57j69i59.3030j0j1&sourceid=chrome&ie=UTF-8)有一篇很好的文章总结了他们如何将这种技术应用于 ETL。

+   **尽早且频繁地进行数据检查：**在处理数据时，将数据写入一个暂存表中，检查数据质量，然后再将暂存表与最终生产表交换是很有用的。在 Airbnb，我们称之为*stage-check-exchange*范式。在这个三步范式中的检查是重要的防御机制——它们可以是简单的检查，比如记录总数是否大于0，或者是复杂的异常检测系统，检查未见过的类别或异常值。

stage-check-exchange 操作的框架（即数据管道的“单元测试”）

+   **构建有用的警报和监控系统：**由于 ETL 作业经常需要很长时间才能完成，因此添加警报和监控是很有用的，这样我们就不需要不断关注 DAG 的进度。不同的公司以许多创造性的方法监控 DAG——在 Airbnb，我们定期使用 EmailOperators 发送作业未能达到 SLA 的警报邮件。其他团队使用警报来标记实验的不平衡。还有一个[有趣的例子](https://www.slideshare.net/cloudera/building-robust-pipelines-with-airflow-wrangle-conference-2017)来自 Zymergen，他们使用 SlackOperator 报告模型性能指标，如 R 平方。

这些原则的灵感来源于与经验丰富的数据工程师的交流、我自己构建 Airflow DAG 的经历以及 Gerard Toonstra 的[ETL 最佳实践与 Airflow](https://gtoonstra.github.io/etl-with-airflow/principles.html)的读物。对于感兴趣的读者，我强烈推荐 Maxime 的以下讲座：

[来源](https://www.youtube.com/watch?v=dgaoqOZlvEA)：Airflow 的原创作者 Maxime 讨论 ETL 最佳实践

### 第二部分回顾

在这一系列的第二篇文章中，我们详细讨论了星型模式和数据建模。我们了解了事实表和维度表的区别，并看到了使用日期戳作为分区键的优势，特别是在回填时。此外，我们解剖了 Airflow 作业的结构，并阐明了 Airflow 中各种操作符的不同。我们还强调了构建 ETL 的最佳实践，并展示了 Airflow 作业在与 Jinja 和 SlackOperators 结合使用时的灵活性。可能性是无穷无尽的！

在系列的最后一篇文章中，我将讨论一些高级数据工程模式——特别是如何从构建管道转向构建框架。我将再次使用我们在 Airbnb 使用的一些示例框架作为激励案例。

如果你觉得这篇文章有用，请访问[**第一部分**](https://medium.com/@rchang/a-beginners-guide-to-data-engineering-part-i-4227c5c457d7)并关注 **第三部分**。

*我想感谢*[*Jason Goodman*](https://medium.com/@jasonkgoodman)* 和 Michael Musson 给我的宝贵反馈*

**简介：[Robert Chang](https://www.linkedin.com/in/robert-chang-877b1720/)** 是 Airbnb 的数据科学家，专注于机器学习、机器学习基础设施和房东增长。在 Airbnb 之前，他曾是 Twitter 的数据科学家，并拥有斯坦福大学的统计学学位和加州大学伯克利分校的运筹学学位。

[原文](https://towardsdatascience.com/a-beginners-guide-to-data-engineering-part-ii-47c4e7cbda71)。经授权转载。

**相关：**

+   [数据工程初学者指南——第一部分](/2018/01/beginners-guide-data-engineering-1.html)

+   [新手和初级数据科学家的建议](/2017/11/chang-advice-new-junior-data-scientists.html)

+   [如何构建数据科学管道](/2017/07/build-data-science-pipeline.html)

### 了解更多相关主题

+   [初学者数据工程指南](https://www.kdnuggets.com/2023/07/beginner-guide-data-engineering.html)

+   [初学者数据科学中的异常检测技术指南](https://www.kdnuggets.com/2023/05/beginner-guide-anomaly-detection-techniques-data-science.html)

+   [数据科学简介：初学者指南](https://www.kdnuggets.com/2023/07/introduction-data-science-beginner-guide.html)

+   [使用 Pyjanitor 进行数据清洗的初学者指南](https://www.kdnuggets.com/beginners-guide-to-data-cleaning-with-pyjanitor)

+   [初学者端到端机器学习指南](https://www.kdnuggets.com/2021/12/beginner-guide-end-end-machine-learning.html)

+   [必要的机器学习算法：初学者指南](https://www.kdnuggets.com/2021/05/essential-machine-learning-algorithms-beginners.html)
