# 远程数据科学：如何将 R 和 Python 执行发送到 SQL Server 从 Jupyter Notebooks

> 原文：[https://www.kdnuggets.com/2018/07/r-python-execution-sql-server-jupyter.html](https://www.kdnuggets.com/2018/07/r-python-execution-sql-server-jupyter.html)

![c](../Images/3d9c022da2d331bb56691a9617b91b90.png) [评论](#comments)

**由 [Kyle Weller](https://www.linkedin.com/in/ai-is-the-future/)**

![SQL Server 中的 R 和 Python](../Images/cf5ff7d619b8bcc49c2e7183cf96d9b2.png)

### **介绍**

你知道吗？你可以在 SQL Server 中从 Jupyter Notebooks 或任何 IDE 远程执行 R 和 Python 代码？ [机器学习服务](https://aka.ms/SQLMLOverview) 在 SQL Server 中消除了数据迁移的需求。你可以在 Jupyter Notebooks、RStudio、PyCharm、VSCode、Visual Studio 等环境中工作，然后将函数执行发送到 SQL Server，将智能带到数据所在的位置，而无需通过网络传输大型和敏感的数据或在 ML 训练中丢失准确性。

本教程将向你展示如何将 Python 代码从 Jupyter notebooks 发送到 SQL Server 中执行的示例。相同的原则也适用于 R 和任何其他 IDE。如果你更喜欢通过视频学习，本教程也已在 YouTube 上发布：

![微软云](../Images/60ebebfdb8a421779f5c0c9d33354ff3.png)

### **环境设置前提条件**

1.  **在 SQL Server 上安装 ML Services**

为了让 R 或 Python 在 SQL 中执行，你首先需要安装和配置机器学习服务功能。请参见这个 [操作指南](https://aka.ms/SetupMLServices)。

1.  **通过微软的 Python 客户端安装 RevoscalePy**

要将 Python 执行发送到 SQL，你需要使用微软的 RevoscalePy 包。要获取 RevoscalePy，请下载并安装微软的 ML Services Python 客户端。 [文档页面](https://docs.microsoft.com/en-us/machine-learning-server/install/python-libraries-interpreter) 或 [直接下载链接](https://aka.ms/mls93-py) （适用于 Windows）。

下载后，以管理员身份打开 powershell 并导航到下载文件夹。使用以下命令开始安装（可以自定义安装文件夹）：

```py
.\Install-PyForMLS.ps1 -InstallFolder "C:\Program Files\MicrosoftPythonClient"

```

请耐心等待，因为安装可能需要一些时间。安装完成后，导航到你安装的新路径。我们创建一个空文件夹并打开 Jupyter Notebooks：

```py
mkdir JupyterNotebooks; cd JupyterNotebooks; ..\Scripts\jupyter-notebook

```

创建一个使用 Python 3 解释器的新笔记本：

![Python 3 笔记本](../Images/278231a10d909a743eff4e148e7ba193.png)

为了测试一切是否设置正确，在第一个单元中导入 revoscalepy 并执行。如果没有错误消息，则可以继续进行下一步。

![导入 revoscalepy](../Images/ca6dd77d9b37907e0928e6ff275dce07.png)

### **数据库设置（仅适用于本教程）**

对于本教程的其余部分，如果你不想逐行复制代码，可以克隆 [这个来自 Github 的 Jupyter Notebook](https://aka.ms/RemoteExecJupyter)。这个数据库设置是一次性的步骤，以确保你拥有与本教程相同的数据。你不需要执行这些设置步骤来使用你自己的数据。

1.  **创建一个数据库**

修改你的服务器连接字符串，并使用 pyodbc 创建一个新的数据库。

```py
import pyodbc
# creating a new db to load Iris sample in
new_db_name = "MLRemoteExec"
connection_string = "Driver=SQL Server;Server=localhost\
MSSQLSERVER2017;Database={0};Trusted_Connection=Yes;"

cnxn = pyodbc.connect(connection_string.format("master"), autocommit=True) 

cnxn.cursor().execute("IF EXISTS(SELECT * FROM sys.databases WHERE
[name] = '{0}') DROP DATABASE {0}".format(new_db_name)) 

cnxn.cursor().execute("CREATE DATABASE " + new_db_name)

cnxn.close()

print("Database created") 

```

1.  **从 SkLearn 导入 Iris 样本**

Iris 是一个流行的初学者数据科学教程数据集。它默认包含在 sklearn 包中。

```py
from sklearn import datasets import pandas as pd
# SkLearn has the Iris sample dataset built in to the package
iris = datasets.load_iris()
df = pd.DataFrame(iris.data, columns=iris.feature_names)

```

1.  **使用 RecoscalePy API 创建表格并加载 Iris 数据**

*(你也可以使用 pyodbc、sqlalchemy 或其他包来实现这个功能)*

```py
from revoscalepy import RxSqlServerData, rx_data_step
# Example of using RX APIs to load data into SQL table
# You can also do this with pyodbc
table_ref = RxSqlServerData(connection_string=
connection_string.format(new_db_name), table="Iris")
rx_data_step(input_data = df, output_file = table_ref, overwrite = True) 
print("New Table Created: Iris")
print("Sklearn Iris sample loaded into Iris table")

```

### **定义一个函数以发送到 SQL Server**

编写你想要在 SQL 中执行的任何 Python 代码。在这个例子中，我们正在创建一个 iris 数据集的散点矩阵，并只将 .png 的字节流返回到 Jupyter Notebooks 以便在客户端渲染。

```py

def send_this_func_to_sql()
from revoscalepy import RxSqlServerData, rx_data_step
from pandas.tools.plotting import scatter_matrix
import matplotlib.pyplot as plt
import io
# remember the scope of the variables in this func are 
within our SQL Server Python Runtime

connection_string = "Driver=SQL Server;Server=localhost\MSSQLSERVER2017;
Database=MLRemoteExec;Trusted_Connection=Yes;"

# specify a query and load into pandas dataframe df
sql_query = RxSqlServerData(connection_string=connection_string, 
sql_query = "select * from Iris")

df = rx_import(sql_query)
scatter_matrix(df)

# return bytestream of image created by scatter_matrix
buf = io.BytesIO()
plt.save fig(buf, format="png")
buf.seek(0)
return buf.getvalue()

```

**将执行发送到 SQL**

现在我们已经完成了设置，看看发送远程执行有多么简单！首先，导入 revoscalepy。创建一个 sql_compute_context，然后使用 RxExec 无缝地将任何函数的执行发送到 SQL Server。不需要从 SQL 转移原始数据到 Jupyter Notebook。所有计算都在数据库内完成，只有图像文件被返回以供显示。

```py

from IPython import display
import matplotlib.pyplot as plt
from revoscalepy import RxInSqlServer, rx_exec
# create a remote compute context with connection to SQL Server

sql_compute_context = 
RxInSqlServer(connection_string=connection_string.format(new_db_name))

# use rx_exec to send the function execution to SQL Server

image = rx_exec(send_this_func_to_sql, 
compute_context=sql_compute_context)[0]

# only an image was returned to my jupyter client. 
#All data remained secure and was manipulated in my db.

display.Image(data=image)

```

尽管这个例子对于 Iris 数据集来说很简单，但可以想象你现在解锁了额外的规模、性能和安全功能。你可以使用任何最新的开源 R/Python 包在 SQL Server 中处理大量数据来构建深度学习和 AI 应用程序。我们还提供了微软的 [前沿](https://cloudblogs.microsoft.com/sqlserver/2016/10/11/1000000-predictions-per-second/)、高性能算法，包含在 [RevoScaleR](https://docs.microsoft.com/en-us/machine-learning-server/r-reference/revoscaler/revoscaler) 和 [RevoScalePy](https://docs.microsoft.com/en-us/sql/advanced-analytics/python/what-is-revoscalepy?view=sql-server-2017) API 中。将这些与开源世界的最新创新结合使用，可以为你的应用程序带来无与伦比的选择、性能和规模。

### **了解更多**

查看 [SQL 机器学习服务文档](https://aka.ms/SQLMLDocs) 以了解如何轻松部署你的 R/Python 代码，并通过 SQL 存储过程使其在 ETL 过程中或任何应用程序中可访问。训练并存储机器学习模型于数据库中，将智能带到数据所在的地方。

基本的 R 和 Python 执行在 SQL Server 中: [https://aka.ms/BasicMLServicesExecution](https://aka.ms/BasicMLServicesExecution)

在 SQL Server 中设置机器学习服务: [https://aka.ms/SetupMLServices](https://aka.ms/SetupMLServices)

GitHub 上的端到端教程解决方案: [https://microsoft.github.io/sql-ml-tutorials/](https://microsoft.github.io/sql-ml-tutorials/)

其他 YouTube 教程：

如何安装SQL Server机器学习服务: [https://aka.ms/InstallMLServices](https://aka.ms/InstallMLServices) 如何启用SQL Server机器学习服务: [https://aka.ms/EnableMLServices](https://aka.ms/EnableMLServices) SQL中R和Python执行的基础: [https://aka.ms/ExecuteMLServices](https://aka.ms/ExecuteMLServices)

**简介**: [凯尔·韦勒](https://www.linkedin.com/in/ai-is-the-future/)是微软Azure机器学习团队的项目经理。在几家初创公司担任软件开发者后，他加入了微软，曾在Office和Bing工作，负责构建可扩展的数据仪表盘、平台和API解决方案。他曾在Cortana数据与分析团队工作，推动测量策略，研究用户行为模式，标准化KPI，并识别产品的增长机会。他现在专注于Azure机器学习产品，将智能带到数据所在的地方。这包括SQL Server的新机器学习服务，允许在SQL中执行R + Python。

**相关:**

+   [Jupyter Notebook初学者教程](https://www.kdnuggets.com/2018/05/jupyter-notebook-beginners-tutorial.html)

+   [SQL备忘单](https://www.kdnuggets.com/2018/07/sql-cheat-sheet.html)

+   [Python中的遗传算法实现](https://www.kdnuggets.com/2018/07/genetic-algorithm-implementation-python.html)

* * *

## 我们的前三个课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [Google网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速进入网络安全职业生涯。

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [Google数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升你的数据分析技能

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [Google IT支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持你所在组织的IT

* * *

### 更多相关话题

+   [Kubernetes中的高可用SQL Server Docker容器](https://www.kdnuggets.com/2022/04/high-availability-sql-server-docker-containers-kubernetes.html)

+   [SQL执行顺序的基本指南](https://www.kdnuggets.com/the-essential-guide-to-sql-execution-order)

+   [KDnuggets™ 新闻 22:n01, 1月5日: 追踪和可视化的3种工具…](https://www.kdnuggets.com/2022/n01.html)

+   [追踪和可视化Python代码执行的3种工具](https://www.kdnuggets.com/2021/12/3-tools-track-visualize-execution-python-code.html)

+   [数据科学中的远程工作: 利与弊](https://www.kdnuggets.com/remote-work-in-data-science-pros-and-cons)

+   [如何找到最佳的数据科学远程工作](https://www.kdnuggets.com/2022/12/find-best-data-science-remote-jobs.html)
