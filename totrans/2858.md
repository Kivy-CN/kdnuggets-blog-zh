# 测试你的机器学习管道

> 原文：[https://www.kdnuggets.com/2019/11/testing-machine-learning-pipelines.html](https://www.kdnuggets.com/2019/11/testing-machine-learning-pipelines.html)

[评论](#comments)

**由 [Kristina Young](https://www.linkedin.com/in/kristina-georgieva/)，高级数据科学家**

在数据产品方面，很多时候存在一种误解，即这些产品无法通过自动化测试。虽然由于其实验性和随机性，有些部分的管道无法进行*传统*测试，但大部分管道是可以进行的。此外，更不可预测的算法可以通过专业的验证过程进行测试。

让我们看看传统的测试方法论以及如何将这些方法应用到我们的数据/机器学习管道中。

### 测试金字塔

你的标准简化测试金字塔看起来是这样的：

![测试金字塔](../Images/c91452a8dddea3d572e7c48be6b02998.png)

这个金字塔表示了你为应用程序编写的各种测试类型。我们从大量的单元测试开始，这些测试在与其他功能隔离的情况下测试单个功能。接着我们编写集成测试，以检查将孤立的组件组合在一起是否按预期工作。最后，我们编写 UI 或验收测试，以检查从用户的角度来看应用程序是否按预期工作。

在数据产品方面，金字塔模型也差不多。我们有或多或少相同的层级。

![测试金字塔.png](../Images/73bc12f0b893c1efe5ad944fee1ddaa8.png)

请注意，UI 测试仍然会在产品中进行，但这篇博客文章重点关注与数据管道最相关的测试。

让我们更详细地了解这些在机器学习中的含义，并借助一些科幻作家的帮助。

### 单元测试

*“这是一个将你的思想与宇宙对比并查看是否匹配的系统。” — 艾萨克·阿西莫夫。*

数据管道中的大部分代码涉及数据清洗过程。用于数据清洗的每个函数都有明确的目标。例如，假设我们为模型选择的一个特征是前一天和当前一天之间值的变化。我们的代码可能看起来像这样：

[PRE0]

在这里，我们知道对于给定的输入我们期望得到某个输出，因此，我们可以用以下代码进行测试：

[PRE1]

对于每一部分独立的功能，你需要编写单元测试，确保数据转换过程的每一部分对数据产生预期的效果。对于每一项功能，你还应考虑不同的场景（是否存在 if 语句？那么所有条件分支都应进行测试）。这些测试将作为你持续集成（CI）管道的一部分，在每次提交时运行。

除了检查代码是否按照预期工作，单元测试在调试问题时也提供了帮助。通过添加一个能够重现新发现的错误的测试，我们可以确保在认为错误已修复时确实已经修复，并且可以确保这个错误不会再发生。

最后，这些测试不仅检查代码是否按预期工作，还帮助我们记录在创建功能时的预期。

### 集成测试

*因为“无云之眼更好，无论它看到什么。” —— 弗兰克·赫伯特*。

这些测试旨在确定独立开发的模块在结合后是否按预期工作。在数据管道中，这些测试可以检查：

+   数据清理过程会生成适合模型的数据集

+   模型训练可以处理提供给它的数据并输出结果（确保代码可以在未来重构）

所以如果我们取上面的单元测试函数，并添加以下两个函数：

[PRE2]

然后我们可以测试在*clean_data*中结合这些函数是否会得到预期的结果，代码如下：

[PRE3]

现在假设我们做的下一步是将上述数据输入到逻辑回归模型中。

[PRE4]

虽然我们不知道期望值，但我们可以确保始终得到相同的值。测试这种集成对我们来说很有用，以确保：

+   数据可以被模型处理（每个输入都有标签，数据类型被所选模型接受等）

+   我们能够在未来重构代码而不会破坏端到端的功能。

通过为随机生成器提供相同的种子，我们可以确保结果始终相同。所有主要库都允许你设置种子（Tensorflow 有点特殊，因为它要求你通过 numpy 设置种子，所以请记住这一点）。测试可能如下：

[PRE5]

这类测试不会像单元测试那样多，但它们仍然会成为你的CI管道的一部分。你将使用这些测试来检查组件的端到端功能，因此会测试更多主要场景。

### 机器学习验证

*为什么？“展示知道错误问题答案的完美无用。” —— 乌苏拉·K·勒古恩。*

现在我们已经测试了代码，还需要测试机器学习组件是否解决了我们尝试解决的问题。当我们谈论产品开发时，机器学习模型的原始结果（无论基于统计方法的准确性如何）几乎从来不是最终的期望输出。这些结果通常会与其他业务规则结合，然后才会被用户或其他应用程序使用。因此，我们需要验证模型是否解决了用户问题，而不仅仅是准确性/F1分数/其他统计测量是否足够高。

这如何帮助我们？

+   它确保模型实际上有助于产品解决当前问题

    +   例如，一个将蛇咬伤分类为致命或非致命的模型，如果20%的错误导致患者未能获得所需治疗，这个模型就不是一个好的模型。

+   这确保了模型产生的值在行业中是合理的

    +   例如，一个预测价格变化准确率为70%的模型，如果最终显示给用户的价格在该行业/市场中太低或太高，则不是一个好的模型。

+   这提供了对所做决策的额外文档层次，帮助后来加入团队的工程师理解。

+   这提供了对产品中机器学习组件的可见性，以客户、产品经理和工程师都能理解的共同语言呈现。

这种验证应定期运行（通过CI管道或定时任务），其结果应向组织公开。这确保了数据科学组件的进展对组织是可见的，并确保由于更改或陈旧数据引起的问题能及早发现。

### 结论

*毕竟，“魔法只是我们尚未理解的科学。” 阿瑟·克拉克。*

机器学习组件可以通过各种方式进行测试，为我们带来以下优势：

+   结果是采取数据驱动的方法，以确保代码按预期执行

+   确保我们可以重构和清理代码而不破坏产品功能

+   记录功能、决策和先前的错误

+   提供对产品中机器学习组件进度和状态的可见性

所以不要害怕，如果你具备编写代码的技能，你也具备编写测试的技能，并获得上述所有优势????。

再见，谢谢你们的所有测试！

**个人简介：[Kristina Young](https://www.linkedin.com/in/kristina-georgieva/)** 是BCG数字风险投资的高级数据科学家。她曾在SoundCloud担任后台和数据工程师，负责推荐团队。她的以往经验包括顾问和研究员。她曾在各种技术领域担任后端、Web和移动开发人员。

[原文](https://intothedepthsofdataengineering.wordpress.com/2019/07/18/testing-your-machine-learning-ml-pipelines/)。已获许可转载。

**相关：**

+   [5步指南：使用d6tflow实现可扩展深度学习管道](/2019/09/5-step-guide-scalable-deep-learning-pipelines-d6tflow.html)

+   [我如何提高机器学习技能](/2019/11/better-machine-learning.html)

+   [数据管道、Luigi、Airflow：你需要知道的一切](/2019/03/data-pipelines-luigi-airflow-everything-need-know.html)

* * *

## 我们的前三大课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [谷歌网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速入门网络安全职业生涯。

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [Google 数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升你的数据分析技能

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [Google IT 支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持你所在的组织进行 IT

* * *

### 了解更多此主题

+   [假设检验和 A/B 测试](https://www.kdnuggets.com/hypothesis-testing-and-ab-testing)

+   [使用 Scikit-learn Pipelines 精简你的机器学习工作流](https://www.kdnuggets.com/streamline-your-machine-learning-workflow-with-scikit-learn-pipelines)

+   [有效的机器学习测试](https://www.kdnuggets.com/2022/01/effective-testing-machine-learning.html)

+   [机器学习中训练数据与测试数据的区别](https://www.kdnuggets.com/2022/08/difference-training-testing-data-machine-learning.html)

+   [使用 DeepChecks 进行机器学习测试的初学者指南](https://www.kdnuggets.com/beginners-guide-to-machine-learning-testing-with-deepchecks)

+   [使用 HuggingFace Pipelines 和 Streamlit 回答问题](https://www.kdnuggets.com/2021/10/simple-question-answering-web-app-hugging-face-pipelines.html)
