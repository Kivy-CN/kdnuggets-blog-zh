# 使用 PyCaret 预测客户流失（正确的方法）

> 原文：[https://www.kdnuggets.com/2021/07/pycaret-predict-customer-churn-right-way.html](https://www.kdnuggets.com/2021/07/pycaret-predict-customer-churn-right-way.html)

[评论](#comments)

**由 [Moez Ali](https://www.linkedin.com/in/profile-moez/)，PyCaret 的创始人兼作者**

![](../Images/d30c89e197e08c3f1818262c2757be9f.png)

预测客户流失（正确的方法）使用 PyCaret — 作者提供的图像

### **介绍**

客户保留是订阅制商业模式公司主要的 KPI 之一。特别是在 SaaS 市场，竞争非常激烈，客户可以自由选择众多供应商。一次不好的体验，客户可能会转向竞争对手，导致客户流失。

### **什么是客户流失？**

客户流失是指在特定时间范围内停止使用公司产品或服务的客户百分比。计算流失率的一种方法是将给定时间间隔内失去的客户数量除以该时间段开始时的活跃客户数量。例如，如果你有1000名客户，并在上个月失去了50名，那么你的月流失率是5%。

预测客户流失是一个具有挑战性但极其重要的商业问题，尤其是在客户获取成本（CAC）较高的行业，如技术、电信、金融等。能够预测某个客户处于高流失风险中，并且还有时间采取措施，这为公司代表了一个巨大的额外潜在收入来源。

### 客户流失机器学习模型在实际中的应用是什么？

客户流失预测模型的主要目标是通过主动与高风险流失的客户互动来留住他们。例如：提供礼品券或任何促销定价，并将他们锁定额外一年或两年，以延长他们对公司的终身价值。

这里有两个主要概念需要理解：

+   我们希望客户流失预测模型能够提前预测流失（比如提前一个月、三个月或甚至六个月——这取决于具体用例）。这意味着你必须非常小心截止日期，即不应在机器学习模型中使用截止日期后的任何信息作为特征，否则将会出现数据泄漏。截止日期之前的时间段称为**事件**。

+   通常，对于客户流失预测，你需要花点时间创建一个***目标列***，它通常不会以你想要的形式提供。例如，你希望预测客户是否会在下一个季度内流失，因此你将遍历所有截止日期时的活跃客户，检查他们是否在下个季度离开公司（1 表示是，0 表示否）。在这种情况下，季度称为**绩效窗口**。

![](../Images/58ffbc62902aceb2f52993e2c40f8b7f.png)

如何创建客户流失数据集 — 作者提供的图像

### 客户流失模型工作流程

现在你已经了解了数据的来源和流失目标的创建（这是问题中最具挑战性的部分之一），让我们讨论一下这个机器学习模型将如何在业务中使用。请从左到右阅读下图：

+   模型会基于客户流失历史进行训练（X特征的事件周期和目标变量的性能窗口）。

+   每个月，将活跃的客户基础传递给**机器学习预测模型**以返回每个客户的流失概率（在商业术语中，有时称为流失评分）。

+   列表将按从高到低的概率值（或他们所说的评分）排序，客户保留团队将开始与客户接触以阻止流失，通常通过提供某种促销或礼品卡来锁定更多年份。

+   流失概率非常低的客户（或者模型预测无流失的客户）是满意的客户。对此不采取任何措施。

![](../Images/e91b9c8c3e68ddee366a72d0af70af4f.png)

客户流失模型工作流程 — 作者提供的图像

### 让我们开始实际的例子

在本节中，我将展示机器学习模型训练与选择、超参数调整、分析和结果解释的完整端到端工作流程。我还会讨论你可以优化的指标以及为什么像AUC、准确率、召回率这样的传统指标可能不适用于客户流失模型。我将使用[PyCaret](https://www.pycaret.org/)——一个开源的低代码机器学习库来进行这个实验。这个教程假设你对PyCaret有基本的了解。

### PyCaret

[PyCaret](https://www.pycaret.org/)是一个开源的低代码机器学习库和端到端模型管理工具，构建于Python中，用于自动化机器学习工作流程。PyCaret以其易用性、简洁性以及快速高效地构建和部署端到端机器学习管道而闻名。要了解更多关于PyCaret的信息，可以查看他们的[GitHub](https://www.github.com/pycaret/pycaret)。

![](../Images/88a030e919f0d8cb248448f7778563ae.png)

PyCaret的特点 — 作者提供的图像

### 安装PyCaret

```py
**# install pycaret** pip install pycaret
```

### 数据集

在本教程中，我使用了来自Kaggle的[电信客户流失](https://www.kaggle.com/blastchar/telco-customer-churn)数据集。数据集已经包含我们可以直接使用的目标列。你可以直接从这个[GitHub](https://raw.githubusercontent.com/srees1988/predict-churn-py/main/customer_churn_data.csv)链接读取这个数据集。 (*向srees1988致敬*)

```py
**# import libraries**
import pandas as pd
import numpy as np**# read csv data** data **=** pd.read_csv('[https://raw.githubusercontent.com/srees1988/predict-churn-py/main/customer_churn_data.csv'](https://raw.githubusercontent.com/srees1988/predict-churn-py/main/customer_churn_data.csv'))
```

![](../Images/dcad3db3c93e570415cddfa1ec0a45cc.png)

示例数据集 — 作者提供的图像

### **探索性数据分析**

```py
**# check data types** data.dtypes
```

![](../Images/84590e750b1347784d7884990412f1ea.png)

数据类型 — 作者提供的图像

请注意，`TotalCharges`的数据类型是`object`而不是`float64`。经过调查，我发现该列中有一些空格，这导致Python将数据类型强制为`object`。为了解决这个问题，我们需要在更改数据类型之前去除空格。

```py
**# replace blanks with np.nan**
data['TotalCharges'] = data['TotalCharges'].replace(' ', np.nan)**# convert to float64**
data['TotalCharges'] = data['TotalCharges'].astype('float64')
```

从直观上看，合同类型、客户的停留时间（tenure）以及定价计划在客户流失或保留方面都是非常重要的信息。让我们来探索它们之间的关系：

[https://gist.github.com/moezali1/2624c9a5eaf78d9a7ffa1b97195a4812](https://gist.github.com/moezali1/2624c9a5eaf78d9a7ffa1b97195a4812)

![](../Images/35598cb787fa11a5b752f1514c3b91d5.png)

根据停留时间、费用和合同类型的客户流失（图片由作者提供）

请注意，大多数流失情况发生在“月度合同”中。这是有道理的。此外，我还注意到，随着停留时间的增加以及总费用的增加，高停留时间和低费用的客户流失的可能性低于高停留时间和高费用的客户。

**缺失值**

```py
**# check missing values** data.isnull().sum()
```

![](../Images/8670ba57f1d45a72ccadc28e8f0ead3b.png)

缺失值——图片由作者提供

请注意，由于我们用`np.nan`替换了空值，现在`TotalCharges`中有11行缺失值。没问题——我将让PyCaret自动填补这些缺失值。

### **数据准备**

在PyCaret的所有模块中，`setup`是任何机器学习实验中的第一个也是唯一的强制步骤。这个函数处理所有训练模型前所需的数据准备工作。除了执行一些基本的默认处理任务外，PyCaret还提供了丰富的预处理功能。要了解PyCaret中所有的预处理功能，你可以查看这个[链接](https://pycaret.org/preprocessing/)。

```py
**# init setup**
from pycaret.classification import *
s = setup(data, target = 'Churn', ignore_features = ['customerID'])
```

![](../Images/7ec559818d4479530de12c4be1716312.png)

pycaret.classification中的setup函数——图片由作者提供

每当你在PyCaret中初始化`setup`函数时，它会对数据集进行概况分析，并推断所有输入特征的数据类型。在这个例子中，除了`tenure`、`MonthlyCharges`和`TotalCharges`，其他所有都是类别型的，这些推断是正确的，你现在可以按回车键继续。如果数据类型推断不正确（这有时会发生），你可以使用`numeric_feature`和`categorical_feature`来覆盖数据类型。

同样，请注意我在`setup`函数中传递了`ignore_features = ['customerID']`，以便在训练模型时忽略该特征。这样做的好处是，PyCaret不会从数据集中删除该列，而只是忽略它用于模型训练。因此，当你在最后生成预测时，不需要担心自己重新合并ID。

![](../Images/da45ec42dc9fe41871cbce475be5690a.png)

输出来自于设置——为显示而截断——图片由作者提供

### 模型训练与选择

数据准备完成后，让我们通过使用`compare_models`功能开始训练过程。该功能训练模型库中所有可用的算法，并使用交叉验证评估多个性能指标。

```py
**# compare all models**
best_model = compare_models(sort='AUC')
```

![](../Images/3ffd6b7d55c7694c9d8d22e2843723fc.png)

来自compare_models的输出 — 作者提供的图像

基于**AUC**的最佳模型是`Gradient Boosting Classifier`。使用10折交叉验证，AUC为0.8472。

```py
**# print best_model parameters**
print(best_model)
```

![](../Images/2001af02cbfa5355dcdcb8dc95550223.png)

最佳模型参数 — 作者提供的图像

### **超参数调整**

你可以使用PyCaret中的`tune_model`功能自动调整模型的超参数。

```py
**# tune best model**
tuned_best_model = tune_model(best_model)
```

![](../Images/de76e0c6f1e6a453d570dc188335ffe6.png)

tune_model结果 — 作者提供的图像

注意到AUC从`0.8472`略微增加到`0.8478`。

### 模型分析

```py
**# AUC Plot**
plot_model(tuned_best_model, plot = 'auc')
```

![](../Images/a1b55482711e184c8da6e153b87d4e3a.png)

AUC图 — 作者提供的图像

```py
**# Feature Importance Plot**
plot_model(tuned_gbc, plot = 'feature')
```

![](../Images/418830a4ce44d421caa99a4ee4b3a2c5.png)

特征重要性图 — 作者提供的图像

```py
**# Confusion Matrix**
plot_model(tuned_best_model, plot = 'confusion_matrix')
```

![](../Images/8b2c00c3aa421704fb991125b3bde26b.png)

混淆矩阵梯度提升分类器 — 作者提供的图像

这个混淆矩阵基于测试集，包括我们数据的30%（2,113行）。我们有309个***真正例***（15%）——这些客户的生命周期价值可以延长。如果我们没有预测到这些客户，则没有干预的机会。

我们还发现有138个（7%）***假正例***，我们将因此损失金钱，因为对这些客户提供的促销将只是额外的成本。

1,388个（66%）是真正例（优质客户），278个（13%）是***假负例***（这是一个错失的机会）。

到目前为止，我们已经训练了多个模型，以选择AUC最高的最佳模型，然后调整最佳模型的超参数，以在AUC方面挤出更多的性能。然而，最佳的AUC并不一定转化为对业务最有利的模型。

在流失模型中，***真正例***的奖励通常与***假正例***的成本差异很大。让我们使用以下假设：

+   将向所有被识别为流失的客户（真正例+假正例）提供$1,000的优惠券；

+   如果我们能够减少客户流失，我们将获得$5,000的客户生命周期价值。

根据这些假设和上面的混淆矩阵，我们可以计算该模型的$影响：

![](../Images/ef9c858bba6c8930acccefbeb34240d3.png)

$ 在2,113名客户中的模型影响 — 作者提供的图像

这是一个不错的模型，但问题是它不是一个商业智能模型。与没有模型相比，它的表现相当不错，但我们如何训练和选择一个最大化商业价值的模型呢？为了实现这一点，我们必须使用商业指标而非AUC或准确率等传统指标来训练、选择和优化模型。

### **???? 在PyCaret中添加自定义指标**

由于 PyCaret，使用 `add_metric` 函数实现这一点变得极其简单。

```py
**# create a custom function** def calculate_profit(y, y_pred):
    tp = np.where((y_pred==1) & (y==1), (5000-1000), 0)
    fp = np.where((y_pred==1) & (y==0), -1000, 0)
    return np.sum([tp,fp])**# add metric to PyCaret** add_metric('profit', 'Profit', calculate_profit)
```

现在让我们运行 `compare_models`，看看奇迹。

```py
**# compare all models**
best_model = compare_models(sort='Profit')
```

![](../Images/db2b1d5d27db3676634fd789e74b149a.png)

compare_models 的输出 — 作者提供的图片

注意，这次新增了一个 `Profit` 列，令人惊讶的是，尽管 Naive Bayes 在 `AUC` 指标上表现不佳，但在利润方面却是最佳模型。让我们来看看原因：

```py
**# confusion matrix**
plot_model(best_model, plot = 'confusion_matrix')
```

![](../Images/375110ebf9a7ffe1ca221e3956d70796.png)

Naive Bayes 的混淆矩阵 — 作者提供的图片

客户总数仍然相同（测试集中的 2,113 位客户），改变的是模型在假阳性和假阴性上的错误情况。让我们用相同的假设（如上所述）为其赋予一些 $ 价值：

![](../Images/8116232fdd30c0d1b81d53c37c5009be.png)

$ 模型对 2,113 位客户的影响 — 作者提供的图片

> ***哇！*** 我们仅通过一个 AUC 指标比最佳模型低 2% 的模型，就将利润提高了约 $400,000。这是怎么发生的呢？首先，AUC 或任何其他现成的分类指标（*准确率、召回率、精确度、F1、Kappa 等*）并不是商业智能指标，因此没有考虑风险和回报。添加自定义指标并将其用于模型选择或优化是一个很好的想法，也是正确的做法。

我希望你能欣赏 PyCaret 的简洁性和易用性。通过仅几行代码，我们就能够训练多个模型并选择对业务最重要的那个。我是一名常规博主，主要撰写关于 PyCaret 及其在实际应用中的用例的文章。如果你想自动接收通知，可以关注我的 [Medium](https://medium.com/@moez-62905)、[LinkedIn](https://www.linkedin.com/in/profile-moez/) 和 [Twitter](https://twitter.com/moezpycaretorg1)。

![](../Images/e22de83ee64026c62225c29c299ff790.png)

PyCaret — 作者提供的图片

![](../Images/e41c1178fc485896497b06e71de91329.png)

PyCaret — 作者提供的图片

使用这个轻量级的 Python 工作流自动化库，你可以实现无限的可能。如果你觉得有用，请不要忘记在我们的 GitHub 仓库上给我们 ⭐️。

要了解更多关于 PyCaret 的信息，请关注我们的 [LinkedIn](https://www.linkedin.com/company/pycaret/) 和 [Youtube](https://www.youtube.com/channel/UCxA1YTYJ9BEeo50lxyI_B3g)。

加入我们的 Slack 频道。邀请链接 [在这里](https://join.slack.com/t/pycaret/shared_invite/zt-p7aaexnl-EqdTfZ9U~mF0CwNcltffHg)。

### 重要链接

[Documentation](https://pycaret.readthedocs.io/en/latest/installation.html)

[Blog](https://medium.com/@moez_62905)

[GitHub](https://www.github.com/pycaret/pycaret)

[StackOverflow](https://stackoverflow.com/questions/tagged/pycaret)

[安装 PyCaret](https://pycaret.readthedocs.io/en/latest/installation.html) [Notebook 教程](https://pycaret.readthedocs.io/en/latest/tutorials.html) [为 PyCaret 做贡献](https://pycaret.readthedocs.io/en/latest/contribute.html)

### 更多 PyCaret 相关教程：

[**在 Alteryx 中使用 PyCaret 进行机器学习**](https://towardsdatascience.com/machine-learning-in-alteryx-with-pycaret-fafd52e2d4a)

一份循序渐进的教程，教你如何在 Alteryx Designer 中使用 PyCaret 训练和部署机器学习模型

[**在 KNIME 中使用 PyCaret 进行机器学习**](https://towardsdatascience.com/machine-learning-in-knime-with-pycaret-420346e133e2)

一份关于如何在 KNIME 中使用 PyCaret 训练和部署端到端机器学习管道的循序渐进指南

[**使用 PyCaret 和 MLflow 简化 MLOps**](https://towardsdatascience.com/easy-mlops-with-pycaret-mlflow-7fbcbf1e38c6)

一份适合初学者的循序渐进教程，教你如何在机器学习实验中使用 PyCaret 集成 MLOps

[**使用 PyCaret 编写和训练自定义机器学习模型**](https://towardsdatascience.com/write-and-train-your-own-custom-machine-learning-models-using-pycaret-8fa76237374e)

[**使用 PyCaret 构建并使用 FastAPI 部署**](https://towardsdatascience.com/build-with-pycaret-deploy-with-fastapi-333c710dc786)

一份循序渐进、适合初学者的教程，教你如何使用 PyCaret 构建端到端的机器学习管道和……

[**使用 PyCaret 进行时间序列异常检测**](https://towardsdatascience.com/time-series-anomaly-detection-with-pycaret-706a6e2b2427)

一份使用 PyCaret 对时间序列数据进行无监督异常检测的循序渐进教程

[**用 PyCaret 和 Gradio 超充你的机器学习实验**](https://towardsdatascience.com/supercharge-your-machine-learning-experiments-with-pycaret-and-gradio-5932c61f80d9)

一份循序渐进的教程，快速开发和互动机器学习管道

[**使用 PyCaret 进行多时间序列预测**](https://towardsdatascience.com/multiple-time-series-forecasting-with-pycaret-bc0a779a22fe)

一份关于使用 PyCaret 预测多个时间序列的循序渐进教程

**简介：[Moez Ali](https://www.linkedin.com/in/profile-moez/)** 是数据科学家，也是 PyCaret 的创始人兼作者。

[原文](https://towardsdatascience.com/predict-customer-churn-the-right-way-using-pycaret-8ba6541608ac)。已获得转载许可。

**相关：**

+   [PyCaret 101：初学者入门](/2021/06/pycaret-101-introduction-beginners.html)

+   [你不知道的 5 件关于 PyCaret 的事](/2020/07/5-things-pycaret.html)

+   [客户流失预测：全球表现研究](/2020/05/customer-churn-prediction-global-performance-study.html)

* * *

## 我们的三大课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [Google 网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速进入网络安全职业生涯。

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [Google 数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升你的数据分析技能

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [Google IT 支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持您的组织的 IT

* * *

### 更多相关主题

+   [学习现代预测技术以帮助预测未来业务…](https://www.kdnuggets.com/2022/12/sphere-learn-modern-forecasting-techniques-help-predict-future-business-outcomes.html)

+   [如何使用 Python 和机器学习预测足球比赛赢家](https://www.kdnuggets.com/2023/01/python-machine-learning-predict-football-match-winners.html)

+   [使用 PyCaret 的二分类介绍](https://www.kdnuggets.com/2021/12/introduction-binary-classification-pycaret.html)

+   [使用 PyCaret 的 Python 聚类介绍](https://www.kdnuggets.com/2021/12/introduction-clustering-python-pycaret.html)

+   [宣布 PyCaret 3.0：开源、低代码的 Python 机器学习](https://www.kdnuggets.com/2023/03/announcing-pycaret-30-opensource-lowcode-machine-learning-python.html)

+   [PyCaret 入门指南](https://www.kdnuggets.com/2022/11/getting-started-pycaret.html)
