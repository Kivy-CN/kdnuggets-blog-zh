# H2O 机器学习框架

> 原文：[https://www.kdnuggets.com/2020/01/h2o-framework-machine-learning.html](https://www.kdnuggets.com/2020/01/h2o-framework-machine-learning.html)

[评论](#comments)

**由 [ActiveWizards](https://activewizards.com/) 提供**

![图](../Images/afeb834ecb031a7a68e910ad9f98000b.png)

* * *

## 我们的前三个课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [Google 网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速进入网络安全职业。

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [Google 数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升你的数据分析技能

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [Google IT 支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持你的组织的 IT

* * *

H2O 是一个可扩展且快速的开源机器学习平台。我们将应用它来执行分类任务。我们使用的数据集是[银行营销数据集](https://archive.ics.uci.edu/ml/datasets/Bank+Marketing)。在这里，我们需要训练一个模型，该模型能够根据客户的个人特征、营销活动特征和当前宏观经济条件来预测银行客户是否会开设定期存款。

在模型创建过程中，我们探讨了 H2O 工具包中的各种核心组件和功能。你应该了解，虽然本文涵盖了一些 H2O 的基本概念，但如果你需要更详细的信息，应该访问 H2O 网站并阅读[文档](http://docs.h2o.ai/h2o/latest-stable/h2o-docs/index.html)。

*注意：有关安装说明，请访问[官方网站](https://www.h2o.ai/download/)。*

### 准备工作

我们首先需要导入所需的库：

[PRE0]

首先，你应该启动 H2O。你可以运行方法`h2o.init()`来初始化 H2O。可以为`h2o.init()`方法提供许多不同的参数，以根据你的需求设置 H2O。因此，你可以在这里更改一些 H2O 的全局设置。然而，在大多数情况下，只需调用该方法而不带任何参数，就像我们下面所做的那样。

[PRE1]

![](../Images/cd4be79d1f7fee58cdb0ed356521f72f.png)

你可以看到，这个方法的输出包含了一些关于你的 H2O 集群的元信息。

下一步是导入我们将要处理的数据集。这是一个 .csv 文件，H2O 有一个函数`upload_file()`，可以将数据集加载到内存中。值得一提的是，H2O 可以处理多种数据源（本地和远程）并支持不同的文件格式。

[PRE2]

要查看数据集，你可以简单地输入其名称并运行单元格。默认情况下显示前 10 行。

![](../Images/b7a8b49bc6ab217d3f769359b501727b.png)

从这个变量的类型来看，我们可以看到类型是 `h2o.frame.H2OFrame`。因此，这不是一个 pandas 对象，而是 H2O 自有的对象。

![](../Images/6d60ecff9f4cf56d1f81d00b4f6d083a.png)

不过，你可以以熟悉的方式索引和切片这个 H2OFrame：

[PRE3]

![](../Images/821c67ca1f753d5460f0ea9be20728f5.png)

你可以通过访问 `.shape` 属性来检查 H2OFrame 的形状。同时，可以通过 `.describe()` 方法生成一些有用的信息（列的类型、最小值、平均值、最大值、标准差、零的数量、缺失值）。

![](../Images/75137e03c97f4807f652857a10b472d3.png)

![](../Images/8378bbc9dbe6e90fd837bdb8ff38ed0d.png)

如我们所见，我们的数据集没有缺失数据。我们有20列不同的类别、整数和实数特征，以及1个目标列（y）。目标变量是二元的，如果客户想要订阅定期存款，则值为"yes"，否则为"no"。

在下一个单元中，我们将列名提取到变量 `x` 中。然后，我们从这个列表中移除目标列（y）的名称。同时，我们将目标变量的名称写入变量 `y`。

[PRE4]

![](../Images/6bbaee011874624cda56298e1a009cab.png)

### 第一个模型

现在我们来训练某个模型。首先，我们需要将数据集拆分为训练集和测试集。H2O 允许通过使用 `split_frame()` 函数来完成这一点。如果你只在列表中传递一个元素作为第一个参数（或参数 `ratios`），这个元素定义了训练数据集的比例。其余部分是测试集。如果传递两个元素，第一个表示训练集，第二个表示测试集，其余部分是验证集。这里我们希望将70%的样本作为训练集，30%作为测试集。我们还固定了随机状态以获得可重复的结果。

[PRE5]

起初，我们希望使用随机森林模型来分类数据点。`H2ORandomForestEstimator` 可以在模块 `h2o.estimators` 中找到。

[PRE6]

然后，我们创建了一个估计器的实例。这里可以指定许多不同的参数。我们通过将200分配给 `ntrees` 参数来设置树的数量为200。在此之后，我们在估计器实例上调用 `train` 方法。我们应将特征列的名称传递给变量 `x`，将目标列的名称传递给变量 `y`。同时，我们指定训练和验证样本。运行这个单元后，我们可以看到下面的进度条，反映了训练过程的状态。

[PRE7]

![](../Images/d4221b67818e69b4c0253b60c85d4df8.png)

可以通过查看估计器的实例来访问模型的详细信息：

![](../Images/da9f73dd80542cc1d47566a4f55dd7bd.png)

这里提供了大量有趣和有用的信息。你可以注意到两块信息。第一块是关于训练集的，第二块是关于测试集的。这里有不同的模型性能指标（MSE、RMSE、LogLoss、AUC、Gini 等）。混淆矩阵是一个非常有趣的错误分析指标。H2O 允许查看训练集和测试集上的混淆矩阵。混淆矩阵中还显示了错误的总比例以及每个标签的错误比例。

有趣的表格是关于在各自错误下的最大指标。在二分类中，模型返回实例属于正类的概率。然后，这个概率应与某个阈值进行比较，以决定这是正类还是负类。H2O 在这个表格中展示了不同指标的最大值，并指定了实现这些最大指标时使用的阈值。例如，在我们的案例中，我们可以通过选择阈值 0.985 来实现测试集上的完美精度。测试集上的最大准确率是 0.911，当你选择 0.5294 作为阈值时可以实现。最高的 F1 分数对应于阈值 0.331。

在实施你的模型时，你可以选择最适合你需求的阈值。此外，你可以尝试一些更高级的操作，比如通过结合训练集和测试集上不同指标的最大值报告的阈值来选择阈值。

这里还有一个有趣的表格是关于特征重要性的表格。最有信息量的列是 scaled_importance 和 percentage。你可以看到 duration 特征在这个任务和数据集中具有最大的预测能力。这个特征意味着与客户的电话通话时长。除了 duration 之外，其他前五个重要特征是宏观经济指标 euribor3m 和 nr.employed，以及客户的 age 和 job。

现在我们想手动计算测试集上的准确率。

在下一个单元格中我们进行预测。你可以看到方法 predict() 返回一个数据框，第一个列包含答案（是或否），接下来的两列包含 no 和 yes 的概率。

[PRE8]

![](../Images/4357413d752756b8eb73390605a7c009.png)

在下一个单元格中我们计算预测与实际答案相等的情况数量，然后计算均值，这将是预测的准确率。我们可以看到准确率是 0.9041 或约 90.4%。如果你返回并查看混淆矩阵，你会发现，如果你从 1 中减去测试集的总错误（0.0958），你会得到 ~0.9041，这就是我们手动找到的准确率。

[PRE9]

![图](../Images/ba37d12562111f8985e4af419c517db6.png)

### 其他算法

H2O 提供了几种不同的模型进行训练。让我们尝试一些。

我们首先要使用神经网络训练的算法。要使用此模型，我们需要从h2o.estimators.deeplearning模块导入H2ODeepLearningEstimator。然后，我们需要创建该估计器的实例。与之前的随机森林示例一样，在这里你可以传递许多不同的参数来控制模型和训练过程。重要的是设置神经网络的架构。在参数hidden中，我们传递一个包含隐藏层中神经元数量的列表。因此，这个参数控制隐藏层的数量和这些层中的神经元数量。我们设置了3个隐藏层，分别有100、10和4个神经元。此外，我们将激活函数设置为Tanh。

[PRE10]

![](../Images/d902243700bdc8c9e46dec56ab6ff936.png)

我们可以看到，准确率略低于随机森林。也许我们可以通过微调模型的参数来获得更好的性能。

在接下来的几个单元格中，我们将训练线性模型。Binomial family 表示我们要进行逻辑回归分类。 lambda_search 允许搜索最佳正则化参数lambda。

[PRE11]

![](../Images/d4221b67818e69b4c0253b60c85d4df8.png)

[PRE12]

![](../Images/da593c6b719ece668800c0f6dfbf5833.png)

我们在这里使用的最后一个模型是梯度提升算法。使用默认参数，它可以在所有其他算法中提供最佳结果。

[PRE13]

![](../Images/bc15d9f11812e35ff1f6cd98da7d692e.png)

[PRE14]

![](../Images/45f3299ab86d4d6bd15ae6a24ad4e130.png)

值得一提的是H2O平台中的XGBoost集成。XGBoost是实现梯度提升思想的最强大的算法之一。你可以单独安装它，但在H2O中使用XGBoost也非常方便。在下面的单元格中，你可以看到如何创建H2OXGBoostEstimator的实例以及如何训练它。你应该了解，XGBoost使用许多参数，且通常对这些参数的变化非常敏感。

[PRE15]

![](../Images/ecabdaaf851178c1fe03cbf3bc6f77ae.png)

H2O中还有其他几个模型可用。如果你想了解更多，应该查看文档。

### H2O中的交叉验证

交叉验证是机器学习中使用的核心技术之一。基本思想是将数据集分成几个部分（折叠），然后在除了一个折叠之外的所有折叠上训练模型，这个折叠将稍后用于测试。在这之后，当前的迭代完成，下一次迭代开始。在下一次迭代中，测试折叠被包括在训练样本中。相反，来自上一次训练集的某个折叠用于测试。

例如，我们将数据集拆分为3个折叠。在第一次迭代中，我们使用第1和第2折叠进行训练，第3折叠进行测试。在第二次迭代中，第1和第3折叠用于训练，第2折叠用于测试。在第三次迭代中，第1折叠用于测试，第2和第3折叠用于训练。

交叉验证允许以更准确和可靠的方式估计模型的性能。

在H2O中，进行交叉验证很简单。如果模型支持，创建模型实例时可以传递一个可选参数`nfolds`。你应该使用这个参数指定交叉验证的折叠数。

H2O构建了`nfolds` + 1个模型。额外的模型是在所有可用数据上训练的。这是你将得到的训练结果的主要模型。

让我们训练随机森林并进行3折交叉验证。注意，我们没有传递验证（测试）集，而是整个数据集。

[PRE16]

![](../Images/1cdb8bb77d6c41acf495080b9a0e5133.png)

如果你查看上面的单元格输出，你会注意到一些差异。

第一点是模型报告的是交叉验证数据，而不是验证数据。

第二点是有一个包含交叉验证指标汇总的表格。在这里你可以看到许多不同的指标，它们的值以每个折叠作为测试折叠的形式出现，这些值的均值以及每个指标的标准差。例如，对于第一个折叠，我们得到准确率为0.9006，对于第二个 - 0.904，对于第三个 - 0.903。这些值的均值为0.9025，标准差为0.001。你应该明白，不仅要有“好”的指标值，还要有低的标准差。这意味着你的模型在数据集中的不同样本上表现良好。但是，交叉验证结果的解释实际上不是本文的目标，所以让我们进入下一章！

### 使用`GridSearch`进行模型调优

通常，你需要尝试许多不同的参数及其组合，以找到能产生最佳模型性能的组合。手动完成这些工作是困难且有时很乏味的。网格搜索可以自动化这一过程。你需要做的就是指定要尝试的超参数集并运行`GridSearch`实例。系统将尝试所有可能的参数组合（对每个组合训练和测试模型）。让我们看看这个工具如何在H2O中使用。

首先，你需要导入`GridSearch`对象的实例：

[PRE17]

现在你需要指定所有可能尝试的参数。我们将寻找适合之前构建的XGBoost模型的最佳参数组合。参数被放置在一个python字典中，其中键是参数的名称，值是这些参数的可能值的列表。

[PRE18]

下一步是创建`GridSearch`实例。你需要传递一个模型、网格的ID以及包含超参数的字典。

[PRE19]

最终，你可以运行网格搜索。注意，我们设置了较高的学习率，因为网格搜索是一个非常耗时的过程。随着超参数数量的增加，训练的模型数量迅速增长。因此，考虑到这只是一个学习示例，我们不想测试太多的超参数。

[PRE20]

我们可以使用GridSearch实例的get_grid()方法来获取网格搜索的结果。我们希望按准确度指标降序排序结果。

[PRE21]

![](../Images/ad09d86283a57be704316b58f8195782.png)

你可以看到，最高的准确度是通过使用1.0列样本率、0.4样本率、200棵树和单棵树的最大深度为3的组合获得的。

### AutoML

H2O提供了进行自动化机器学习的功能。这个过程非常简单，面向那些对机器学习了解不多的用户。AutoML将通过不同的模型和参数进行迭代，以寻找最佳结果。虽然需要指定几个参数，但在大多数情况下，你只需设置最大运行时间（以秒为单位）或最大模型数量。你可以把AutoML看作是类似于GridSearch的东西，但它是针对模型而不是参数的。

[PRE22]

我们可以通过检查autoML实例的.leaderboard属性来查看所有尝试过的模型及其相应的性能。具有0.94 AUC指标的GBM模型似乎是这里的最佳模型。

[PRE23]

![](../Images/607ae3b06bfee8055a1eb1882cbc3ff6.png)

看看最佳模型：

![](../Images/a246e130d9b584af3068ce8c2429b2fa.png)

你可以直接从autoML实例中对测试集进行预测。

[PRE24]

### 结论

这篇文章只是对H2O功能的简要介绍。这是一个出色的机器学习平台，可以使工程师在某些领域的机器学习工作变得更简单。它是一个不断发展的框架。我们认为，它不能单独使用。相反，与H2O一起使用的其他工具可以使机器学习过程更快、更方便。

在本文中，我们介绍了H2O中的一些基本数据操作，查看了H2O提供的几种机器学习模型，学习了如何进行交叉验证和网格搜索，并熟悉了H2O中的自动化机器学习。

你应该了解H2O有一些功能超出了本文的范围。所以，如果你有兴趣了解更多，请阅读官方文档。

**[ActiveWizards](https://activewizards.com/)** 是一个专注于数据项目（大数据、数据科学、机器学习、数据可视化）的数据科学家和工程师团队。核心专长包括数据科学（研究、机器学习算法、可视化和工程）、数据可视化（d3.js、Tableau等）、大数据工程（Hadoop、Spark、Kafka、Cassandra、HBase、MongoDB等）以及数据密集型Web应用程序开发（RESTful APIs、Flask、Django、Meteor）。

[原文](https://activewizards.com/blog/h2o-framework-for-machine-learning/)。经许可转载。

**相关：**

+   [自动化机器学习：团队如何在AutoML项目中协作？](/2020/01/teams-work-together-automl-project.html)

+   [自动化机器学习项目实施复杂性](/2019/11/automl-implementation-complexities.html)

+   [顶级6个Python NLP库的比较](/2018/07/comparison-top-6-python-nlp-libraries.html)

### 更多相关内容

+   [AI/ML模型的风险管理框架](https://www.kdnuggets.com/2022/03/risk-management-framework-aiml-models.html)

+   [Django框架中的社交用户认证](https://www.kdnuggets.com/2023/01/social-user-authentication-django-framework.html)

+   [适用于所有用途的唯一提示框架](https://www.kdnuggets.com/the-only-prompting-framework-for-every-use)

+   [每个机器学习工程师都应具备的5种机器学习技能…](https://www.kdnuggets.com/2023/03/5-machine-learning-skills-every-machine-learning-engineer-know-2023.html)

+   [KDnuggets新闻，12月14日：3门免费机器学习课程…](https://www.kdnuggets.com/2022/n48.html)

+   [学习数据科学、机器学习和深度学习的坚实计划](https://www.kdnuggets.com/2023/01/mwiti-solid-plan-learning-data-science-machine-learning-deep-learning.html)
