# 如何在Airflow上构建DAG工厂

> 原文：[https://www.kdnuggets.com/2021/03/build-dag-factory-airflow.html](https://www.kdnuggets.com/2021/03/build-dag-factory-airflow.html)

[评论](#comments)

**由 [Axel Furlan](https://www.linkedin.com/in/axelfurlan/)，数据工程师**

![](../Images/a9f359d219ec76580f36b27ce2a8d4ae.png)

图片由[Chris Ried](https://unsplash.com/@cdr6934?utm_source=medium&utm_medium=referral)提供，来自[Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)

* * *

## 我们的三大课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [谷歌网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速进入网络安全职业轨道。

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [谷歌数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升你的数据分析技能

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [谷歌IT支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持你所在组织的IT工作

* * *

### 为什么需要DAG工厂？

我们来看一个包含两个任务的相当简单的DAG…

在Airflow中执行两个简单的Python脚本需要这么多模板代码，这是不是很奇怪？无论你写多少个DAG，你肯定会发现自己在许多不同的DAG中几乎写着相同的变量，只是变化微小。

记住，在编码时，通常更好**编写一段代码，以后可以调用，而不是每次都写相同的代码**。这叫做[**DRY**](https://en.wikipedia.org/wiki/Don%27t_repeat_yourself)。

如果你的许多DAG共享类似的值，例如*电子邮件地址*、*开始日期*、*计划间隔*、*重试次数*等等，最好有一段代码来为你填充这些值。这就是我们试图通过工厂类实现的目标。

使用Airflow上的DAG工厂，我们可以**将创建DAG所需的代码行数减少一半**。

### 我们来看以下示例

在这里，我们希望有一个简单的DAG，打印今天的日期，然后打印“hi”。

这就是在Airflow中的样子：

![DAG](../Images/28ce7700d8cfbc5cdf7afda622a439ab.png)

注意我们减少了多少杂乱。我们没有指定使用什么操作符、任务的ID、计划间隔、谁创建了DAG或创建时间。

我们还可以看到我们使用字典指定了任务和依赖关系，并且这最终转化为正确的任务依赖关系????

我们来看一个稍微复杂一点的示例：

在这个DAG中，我指定了两个我希望覆盖默认值的参数。这些是DAG的所有者和重试次数。我还在`get_airflow_dag()`方法中指定了我希望计划为每日执行。

这个 DAG 有 3 个任务。`say_bye()` 和 `print_date()` 都依赖于 `say_hi()`。让我们看看在 Airflow 中这是什么样子的。

![DAG](../Images/9a353147bdd205ed61664413027c2749.png)

现在，让我们看看如何构建 DAG 工厂 ????

### 如何编写代码？

说实话，这非常简单。我们首先创建一个类，包含所有创建 DAG 及其任务所需的方法。

下面是 DAG 工厂的完整代码。

我们将调用的主要方法以获得一个完全可用的 DAG 是 `get_airflow_dag()`。

该方法将接收 2 个必需参数：DAG 的名称和它应该运行的任务。其余参数是可选的，因为我们可以在函数实现中设置默认值。在实现时，可以根据使用情况将任何这些可选参数设置为必需参数，比如将 *cron* (`schedule_interval`) 设置为必需参数，甚至 DAG 的所有者。

`default_args` 参数将是一个字典，包含你可能想要覆盖的任何键值。如果没有指定，将使用默认的 default_args。

在我们的情况下，默认值是：

[PRE0]

其他 3 个参数是描述 DAG 的主要参数。还有更多选项，可以随意指定更多。

`get_airflow_dag()` 将运行 `create_dag()` 以创建 DAG 对象并返回它。`add_tasks_to_dag()` 有点复杂，因为我们希望让用户在不必编写 *Operators* 的情况下，方便地指定任务的依赖关系。

在我们的情况下，我们总是为任务使用 *PythonOperator*，所以假设这是一种标准是合情合理的。

实现旨在简化数据工程师的工作，因此我们避免设置额外的内容，比如任务名称，我们只是默认它与函数名称相同——因此我们使用一些 *reflection* 来确定它。

[PRE1]

该函数首先创建一个辅助字典，以存储任务名称：任务对象的键值对。这是为了只有一组任务对象，并在后续用来设置依赖关系。然后，对于最初提供的任务字典中的每个键，依赖关系会利用辅助字典进行设置。

完成后，DAG 对象就可以返回并由团队使用了 ????。

### 明白了！

文件中有一个小技巧，使 Airflow 能识别我们返回的是一个合适的 DAG。

当 Airflow 启动时，所谓的 DagBag 进程将解析所有文件以寻找 DAG。目前的实现方式是这样的：

+   DagBag 会生成不同的进程，检查 dag 文件夹中的文件。

+   名为 `process_file` 的函数 [在这里](https://airflow.apache.org/docs/apache-airflow/stable/_modules/airflow/models/dagbag.html) 为每个文件运行，以确定是否存在 DAG。

+   代码运行 `might_contain_dag`，它会返回True，取决于文件中是否同时包含“dag”和“airflow”这两个关键字。实现细节见 [这里](https://github.com/apache/airflow/blob/c61f3d45b4a1799e92ead1532d36f232ebc4686e/airflow/utils/file.py#L198)。

这就是为什么函数 `get_airflow_dag` 会这样命名，以确保文件中同时包含这两个关键字，从而使文件能够被正确解析。

这是一个很难找到的东西，我花了很多小时试图弄清楚为什么我的DAG工厂不起作用。关于如何以非传统方式创建DAG的文档不多，因此这是你在做类似工作时必须考虑的一个大问题。

### 结论

这篇简单的文章旨在解释如何通过在Airflow上利用 [工厂模式](https://www.tutorialspoint.com/design_pattern/factory_pattern.htm) 来让数据工程师的生活更轻松。

希望你喜欢！随时点击我的个人资料查看其他有用的Airflow和数据工程文章！????

**个人简介: [Axel Furlan](https://www.linkedin.com/in/axelfurlan/)** 是一位来自阿根廷的数据工程师?????，同时也是一名软件工程学生。Axel起初是数据科学家，然后将软件工程和数据结合在一起，对这个角色的多样性深感着迷。他写作是为了让其他数据工程师的生活更轻松。

[原文](https://towardsdatascience.com/how-to-build-a-dag-factory-on-airflow-9a19ab84084c)。经许可转载。

**相关内容:**

+   [2021年数据科学学习路线图](/2021/02/data-science-learning-roadmap-2021.html)

+   [成为数据工程师需要的9项技能](/2021/03/9-skills-become-data-engineer.html)

+   [用NumPy和Pandas在更大图表上加速机器学习](/2020/05/faster-machine-learning-larger-graphs-numpy-pandas.html)

### 更多相关内容

+   [5种数据编排的Airflow替代方案](https://www.kdnuggets.com/5-airflow-alternatives-for-data-orchestration)

+   [在5分钟内构建一个机器学习网页应用](https://www.kdnuggets.com/2022/03/build-machine-learning-web-app-5-minutes.html)

+   [如何作为初学者构建强大的数据科学作品集](https://www.kdnuggets.com/2021/10/strong-data-science-portfolio-as-beginner.html)

+   [你需要的6种数据科学技术来构建供应链管道](https://www.kdnuggets.com/2022/01/6-data-science-technologies-need-build-supply-chain-pipeline.html)

+   [用Python在5分钟内构建一个网页抓取工具](https://www.kdnuggets.com/2022/02/build-web-scraper-python-5-minutes.html)

+   [天空才是极限：了解JetBlue如何使用Monte Carlo和Snowflake…](https://www.kdnuggets.com/2022/12/monte-carlo-jetblue-snowflake-build-trust-improve-model-accuracy.html)
