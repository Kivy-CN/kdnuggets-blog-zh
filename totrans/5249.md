# 使用SQL进行客户留存分析的指南

> 原文：[https://www.kdnuggets.com/2017/12/guide-customer-retention-analysis-sql.html](https://www.kdnuggets.com/2017/12/guide-customer-retention-analysis-sql.html)

![c](../Images/3d9c022da2d331bb56691a9617b91b90.png) [评论](/2017/12/guide-customer-retention-analysis-sql.html?page=2#comments)

**作者：Luba Belokon，[Statsbot](https://statsbot.co/)**

无论您是在销售杂货、金融服务还是健身会员，成功招募新客户只有在他们再次光顾时才算真正成功。反映这一点的指标称为**留存率**，我们使用的方法是客户留存分析。这是影响收入的关键指标之一。当您的客户留存率低时，您将把所有的业务收入都投入到营销中。

* * *

## 我们的前三个课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [谷歌网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速进入网络安全职业生涯。

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [谷歌数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升您的数据分析技能

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [谷歌IT支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持您组织的IT需求

* * *

同时，如果您能够使用SQL和数据库正确计算，留存率是容易提高的。在这篇文章中，我们将逐步指导您如何进行基本的客户留存分析，如何随着时间的推移建立客户留存，新的客户与现有客户的留存曲线，以及如何在群体中计算留存分析。

![](../Images/4dafe15272d5880e5a4895c828c73092.png)

### **基本客户留存曲线**

客户留存曲线对任何希望了解客户的业务都是至关重要的，并且将大大有助于解释销售数据或营销举措的影响等其他事项。它们是可视化客户与业务之间关键互动的简单方法，也就是说，客户是否会在首次访问后返回——以及以何种速度返回。

构建客户留存曲线的第一步是确定在参考期内访问过您业务的那些客户，我将称之为p1。选择的时间段长度必须合理，并且反映预期的访问频率。

不同类型的业务将期望客户以不同的速度返回：

+   咖啡店可能选择使用每周一次的预期访问频率。

+   超市可能选择较长的时间段，例如2周或一个月。

在以下示例中，我将使用一个月份，并假设我们正在查看2016年1月访问的客户在接下来一年的客户留存情况。

如前所述，第一步是识别最初的客户池：

```py
January_pool AS

(                
                SELECT DISTINCT cust_id

                FROM            dataset

                WHERE           month(transaction_date)=1

                AND             year(transaction_date)=2016)
```

然后，我们查看这些客户随着时间的推移的行为：例如，他们在剩下的年份中每月返回的数量是多少？

```py
SELECT *Year*(transaction_date),
       *Month*(transaction_date),
       count (distinct cust_id) AS number

FROM dataset

WHERE year(transaction_date)=2016

AND cust_id IN january_pool

GROUP BY 1,

         2
```

如你所见，原始的SELECT函数被包含在第二步中。

如果我们在一月有1000个独立客户，我们可以预期我们的结果会是这样的：

![](../Images/9e5c1c04cff6ee179ae47d2e59425704.png)

结果图表将会是这样的：

![](../Images/8e8edcb227c54109061bdea06175072b.png)

数据通过 [Statsbot](https://statsbot.co/solutions/product-analytics?utm_source=blog&utm_medium=article&utm_campaign=retention)可视化

### **客户留存的演变**

上述描述显然只是第一步，因为我们还希望看到客户留存是否有任何趋势，即我们是否变得更好？

所以，我们可能有一个想法是：在一月来的客户中，有多少在二月再次访问？在二月来的客户中，有多少在三月再次访问？以及其他一个月的间隔。

然后，我们需要建立一个迭代模型，这可以通过几个简单的步骤来完成。首先，我们需要创建一个表格，在其中记录每个用户按月份的访问情况，考虑到这些访问可能发生在多个年度，因为我们的业务可能从那时开始。我在这里假设开始日期是2000年，但你可以根据需要进行调整。

```py
Visit_log AS

SELECT cust_id,

       datediff(month, ‘2000–01–01’, transaction_date) AS visit_month

FROM dataset

GROUP BY 1,

         2

ORDER BY 1,

         2
```

这将给我们一个如下所示的视图：

![](../Images/b3facb2b4c2007e2a35a9a0ad14377b5.png)

然后，我们需要重新组织这些信息，以识别每次访问之间的时间间隔。因此，对于每个人和每个月，查看下一次访问的时间。

```py
Time_lapse AS

    SELECT cust_id,

           visit_month lead(visit_month, 1) over (partition BY cust_id ORDER BY cust_id, visit_month)

    FROM visit_log
```

![](../Images/f711558056104b3bd5419449a25b0abb.png)

然后我们需要计算访问之间的时间间隔：

```py
Time_diff_calculated AS

    SELECT cust_id,

           visit_month,

           lead,

           lead — visit_month AS time_diff

    FROM time_lapse
```

![](../Images/3d0161fb4389e0fa881503732e980adf.png)

现在，稍微提醒一下客户留存分析测量的内容：它是返回的客户在x时间间隔后的比例。因此，我们想要做的是将给定月份访问的客户数量与下个月那些返回的数量进行比较。我们还希望定义那些在特定缺席后返回的客户，以及那些根本没有返回的客户。为了做到这一点，我们需要根据客户的访问模式对他们进行分类。

```py
Custs_categorized AS

SELECT cust_id,

       visit_month,

       CASE

             WHEN time_diff=1 THEN ‘retained’,

             WHEN time_diff>1 THEN ‘lagger’,

             WHEN time_diff IS NULL THEN ‘lost’

       END AS cust_type

FROM time_diff_calculated
```

这将使我们在最后一步中，能够统计在给定月份访问的客户数量，以及其中有多少人下个月会再次访问。

```py
SELECT visit_month,

       count(cust_id where cust_type=’retained’)/count(cust_id) AS retention

FROM custs_categorized

GROUP BY 1
```

这让我们按月份得到返回客户的比例。

![](../Images/92c95efb32cb152b198bfe7dbffaace8.png)

数据通过 [Statsbot](https://statsbot.co/solutions/product-analytics?utm_source=blog&utm_medium=article&utm_campaign=retention)可视化

### 了解更多相关话题

+   [如何收集客户情感分析的数据](https://www.kdnuggets.com/2022/12/collect-data-customer-sentiment-analysis.html)

+   [逐步指南：阅读和理解 SQL 查询](https://www.kdnuggets.com/a-step-by-step-guide-to-reading-and-understanding-sql-queries)

+   [拆解 DENSE_RANK()：SQL 爱好者的逐步指南](https://www.kdnuggets.com/breaking-down-denserank-a-step-by-step-guide-for-sql-enthusiasts)

+   [SQL 执行顺序的基本指南](https://www.kdnuggets.com/the-essential-guide-to-sql-execution-order)

+   [SQL 中的数据清理：如何准备混乱的数据进行分析](https://www.kdnuggets.com/data-cleaning-in-sql-how-to-prepare-messy-data-for-analysis)

+   [掌握 SQL、Python、数据清理、数据整理和探索性数据分析的指南合集](https://www.kdnuggets.com/collection-of-guides-on-mastering-sql-python-data-cleaning-data-wrangling-and-exploratory-data-analysis)
