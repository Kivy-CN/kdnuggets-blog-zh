# 如何编写更好的 SQL 查询：终极指南 - 第一部分

> 原文：[https://www.kdnuggets.com/2017/08/write-better-sql-queries-definitive-guide-part-1.html](https://www.kdnuggets.com/2017/08/write-better-sql-queries-definitive-guide-part-1.html)

**由 Karlijn Willems，数据科学记者及[DataCamp](https://www.datacamp.com/) 贡献者**。

结构化查询语言（SQL）是数据科学行业中不可或缺的技能，通常来说，学习这项技能是相对简单的。然而，大多数人忽视了 SQL 不仅仅是编写查询，这只是走向最终目标的第一步。确保查询的性能或其适合你所工作的上下文是另一回事。

* * *

## 我们的前三大课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [谷歌网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速进入网络安全职业生涯。

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [谷歌数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升你的数据分析能力

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [谷歌 IT 支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持你的组织进行 IT 管理

* * *

这就是为什么本 SQL 教程将为你提供一些步骤，让你可以评估你的查询：

+   首先，你将简要了解[学习 SQL 对数据科学工作的重视](https://www.datacamp.com/community/tutorials/sql-tutorial-query#importance)；

+   接下来，你将首先了解更多关于[SQL 查询处理和执行](https://www.datacamp.com/community/tutorials/sql-tutorial-query#execution)，以便你能正确理解编写高质量查询的重要性：更具体地说，你将看到查询被解析、重写、优化并最终评估；

+   记住这一点，你不仅会讨论一些初学者在编写查询时常犯的[查询反模式](https://www.datacamp.com/community/tutorials/sql-tutorial-query#antipattern)，还会了解这些可能错误的替代方案和解决方案；你还将了解[基于集合与过程化方法](https://www.datacamp.com/community/tutorials/sql-tutorial-query#setbased)的查询方法。

+   你还将看到这些反模式源于性能问题，除了“手动”改进 SQL 查询的方法，你还可以通过使用其他工具，以更结构化、深入的方式[分析你的查询](https://www.datacamp.com/community/tutorials/sql-tutorial-query#queryplan)，以查看查询计划；另外，

+   你将简要了解[时间复杂度和大 O 符号](https://www.datacamp.com/community/tutorials/sql-tutorial-query#bigo)，以便在执行查询前了解执行计划的时间复杂度；最后，

+   你将简要获得一些关于如何进一步[优化你的查询](https://www.datacamp.com/community/tutorials/sql-tutorial-query#tune)的建议。

![](../Images/3fec2cbe3c0764a970df9ee5b3657839.png)

你对 SQL 课程感兴趣吗？快来参加 DataCamp 的[数据科学 SQL 入门课程](https://www.datacamp.com/courses/intro-to-sql-for-data-science)吧！

### 我为什么要学习数据科学中的 SQL？

SQL 远未过时：它是数据科学行业中职位描述中最受欢迎的技能之一，无论你是申请数据分析师、数据工程师、数据科学家还是[其他职位](https://www.datacamp.com/community/tutorials/data-science-industry-infographic)。这一点在 2016 年 O'Reilly 数据科学薪资调查中得到了证实，70% 的受访者表示他们在职业中使用 SQL。此外，在这项调查中，SQL 的使用频率远高于 R (57%) 和 Python (54%) 编程语言。

你明白了吧：SQL 是你在数据科学行业找工作时必备的技能。

对于一种在 1970 年代初期开发的语言来说，这算是不赖吧？

但为什么它如此频繁地被使用？为什么尽管它已经存在了这么长时间，它仍然没有过时？

原因有很多：其中一个主要原因是公司大多数数据都存储在关系型数据库管理系统（RDBMS）或关系型数据流管理系统（RDSMS）中，你需要 SQL 来访问这些数据。SQL 是数据的通用语言：它使你能够与几乎任何数据库交互，甚至在本地构建自己的数据库！

如果这还不够，请记住，不同供应商的 SQL 实现有很多不兼容之处，并且不一定遵循标准。因此，了解标准 SQL 是你在（数据科学）行业中找到路途的必要条件。

更重要的是，可以说 SQL 也被新技术所接受，比如 Hive，这是一种类似 SQL 的查询语言接口，用于查询和管理大型数据集，或 Spark SQL，你可以用它来执行 SQL 查询。再一次，你在这些环境中遇到的 SQL 会与标准 SQL 略有不同，但学习曲线会容易得多。

如果你想做个比较，可以把它当作学习线性代数：投入所有精力到这个学科，你就知道你将能够利用它来掌握机器学习！

简而言之，这就是为什么你应该学习这个查询语言的原因：

+   它相对容易学习，即使是完全的新手也能很快掌握。学习曲线非常平缓，你很快就能编写查询。

+   它遵循“学习一次，随处使用”的原则，所以这是你时间的绝佳投资！

+   SQL 是编程语言的一个优秀补充；在某些情况下，编写查询甚至比编写代码更受欢迎，因为它性能更好！

+   …

你还在等什么？ :)

### SQL 处理与查询执行

要提高 SQL 查询的性能，首先必须了解在你按下快捷键运行查询时内部发生了什么。

首先，查询会被解析成一个“解析树”；查询会被分析以确定是否满足语法和语义要求。解析器创建了输入查询的内部表示。然后，这个输出会传递给重写引擎。

然后，优化器的任务是为给定的查询找到最优的执行或查询计划。执行计划精确地定义了每个操作使用的算法以及操作执行的协调方式。

为了确实找到最优的执行计划，优化器会列举所有可能的执行计划，确定每个计划的质量或成本，获取当前数据库状态的信息，然后选择最佳的计划作为最终执行计划。由于查询优化器可能并不完美，数据库用户和管理员有时需要手动检查和调整优化器生成的计划以获得更好的性能。

现在你可能想知道什么是被认为的“良好查询计划”。

如你所读到的，计划的成本质量扮演着重要角色。更具体地说，评估计划所需的磁盘 I/O 次数、计划的 CPU 成本以及数据库客户端观察到的整体响应时间和总执行时间都是至关重要的。这就是时间复杂度概念的作用所在。你将在后文中了解更多内容。

接下来，选择的查询计划会被执行，由系统的执行引擎进行评估，并返回查询结果。

![](../Images/1d9ed9522e2baf1b62b9ec5d87a3dbf0.png)

### 编写 SQL 查询

从前一节中可能没有明确的是，垃圾进，垃圾出（GIGO）原则自然在查询处理和执行中显现：编写查询的人也掌握了 SQL 查询性能的关键。如果优化器收到一个格式不良的查询，它只能做得有限……

这意味着在编写查询时，有一些事情是*你*可以做的。正如你在介绍中看到的，责任是双重的：不仅仅是编写符合某种标准的查询，还需要了解查询中可能潜在的性能问题所在。

理想的起点是思考查询中可能出现问题的“点”。通常来说，有四个子句和关键字是新手容易遇到性能问题的地方：

+   `WHERE` 子句；

+   任何 `INNER JOIN` 或 `LEFT JOIN` 关键字；并且，

+   `HAVING` 子句；

诚然，这种方法简单而天真，但作为初学者，这些子句和语句是很好的指针，可以说，当你刚开始时，这些地方最容易出错，讽刺的是，这些地方也最难发现错误。

然而，你也应该意识到性能是需要上下文来变得有意义的：仅仅说这些子句和关键词不好，并不是你考虑SQL性能时的正确方法。在查询中拥有`WHERE`或`HAVING`子句并不一定意味着它是一个坏查询……

查看下面的部分以了解更多关于反模式和构建查询的替代方法。这些技巧和窍门旨在作为指南。你是否真的需要重写你的查询取决于数据量、数据库以及你需要执行查询的次数等因素。这完全取决于你的查询目标，并且对你要查询的数据库有一些前期了解是至关重要的！

### 1. 只检索你需要的数据

“数据越多越好”的心态并不是你在编写SQL查询时应该遵循的：不仅你可能会因为获取了比实际需要更多的数据而掩盖你的见解，而且你的性能可能会受到影响，因为你的查询提取了过多的数据。

这就是为什么一般来说，注意`SELECT`语句、`DISTINCT`子句和`LIKE`操作符是个好主意。

**`SELECT` 语句**

当你编写查询时，你可以首先检查`SELECT`语句是否尽可能简洁。你的目标是从`SELECT`中移除不必要的列。这样你迫使自己只提取对查询目标有用的数据。

如果你有包含`EXISTS`的相关子查询，你应该尝试在该子查询的`SELECT`语句中使用常量，而不是选择实际列的值。这在你只检查存在性时尤其有用。

**记住**，相关子查询是一个使用外部查询中的值的子查询。并且注意，即使`NULL`在这个上下文中可以作为“常量”使用，但它非常令人困惑！

考虑以下示例，以理解使用常量的意义：

```py
SELECT driverslicensenr, name 
FROM Drivers 
WHERE EXISTS (SELECT '1' FROM Fines 
              WHERE fines.driverslicensenr = drivers.driverslicensenr);
```

**提示**：了解相关子查询并不总是一个好主意是很有用的。你总是可以考虑通过例如用`INNER JOIN`来重写它们，从而去掉相关子查询。

```py
SELECT driverslicensenr, name 
FROM drivers 
INNER JOIN fines ON fines.driverslicensenr = drivers.driverslicensenr;
```

**`DISTINCT` 子句**

`SELECT DISTINCT`语句用于返回仅不同的（不同的）值。如果可以的话，你应该尽量避免使用`DISTINCT`子句；正如你在其他示例中所读到的，执行时间仅会因添加此子句而增加。因此，总是一个好主意考虑你是否真的需要执行这个`DISTINCT`操作以获得你想要的结果。

**`LIKE` 运算符**

当你在查询中使用 `LIKE` 运算符时，如果模式以 `%` 或 `_` 开头，则不会使用索引。这将阻止数据库使用索引（如果存在）。当然，从另一个角度看，也可以争辩说，这种查询可能会检索到过多不一定符合查询目标的记录。

再次强调，你对存储在数据库中的数据的了解可以帮助你制定一个模式，这个模式能够正确过滤所有数据，只找到真正对你的查询有用的行。

### 2\. 限制你的结果

当你无法避免在 `SELECT` 语句中进行筛选时，可以考虑通过其他方式限制结果。这就是 `LIMIT` 子句和数据类型转换派上用场的地方。

**`TOP`、`LIMIT` 和 `ROWNUM` 子句**

你可以在查询中添加 `LIMIT` 或 `TOP` 子句，以设置结果集的最大行数。以下是一些示例：

```py
SELECT TOP 3 * 
FROM Drivers;
```

**注意** 你还可以进一步指定 `PERCENT`，例如，如果你将查询的第一行改为 `SELECT TOP 50 PERCENT *`。

```py
SELECT driverslicensenr, name 
FROM Drivers 
LIMIT 2;
```

此外，你还可以添加 `ROWNUM` 子句，它等同于在查询中使用 `LIMIT`：

```py
SELECT * 
FROM Drivers 
WHERE driverslicensenr = 123456 AND ROWNUM <= 3;
```

### 数据类型转换

你应该始终使用最有效的，即最小的数据类型。使用比实际需要更大的数据类型总是有风险的。

然而，当你在查询中添加数据类型转换时，只会增加执行时间。

另一种选择是尽量避免数据类型转换。还要注意，虽然并不总是可能完全移除或省略数据类型转换，但你应该尽量小心地添加这些转换，并且在运行查询之前测试添加的效果。

### 相关话题

+   [转行数据科学的权威指南](https://www.kdnuggets.com/2022/05/definitive-guide-switching-career-data-science.html)

+   [Python 函数参数：权威指南](https://www.kdnuggets.com/2023/02/python-function-arguments-definitive-guide.html)

+   [解决 MySQL 中幽灵读的权威指南](https://www.kdnuggets.com/2022/06/definitive-guide-solving-phantom-read-mysql.html)

+   [逐步阅读和理解 SQL 查询的指南](https://www.kdnuggets.com/a-step-by-step-guide-to-reading-and-understanding-sql-queries)

+   [如何在本地 Python 中编写 SQL](https://www.kdnuggets.com/2022/02/easy-sql-native-python.html)

+   [KDnuggets 新闻，12 月 7 日：破解十大数据科学神话 • 4…](https://www.kdnuggets.com/2022/n47.html)
