# 构建并部署你的第一个机器学习 web 应用

> 原文：[https://www.kdnuggets.com/2020/05/build-deploy-machine-learning-web-app.html](https://www.kdnuggets.com/2020/05/build-deploy-machine-learning-web-app.html)

[评论](#comments)

**由 [Moez Ali](https://www.linkedin.com/in/profile-moez/)，PyCaret 的创始人和作者**

![图示](../Images/8213893cbe65e0b98f2f494411a5cb55.png)

在我们的[上一篇文章](https://towardsdatascience.com/machine-learning-in-power-bi-using-pycaret-34307f09394a)中，我们展示了如何在 Power BI 中使用[PyCaret](https://www.pycaret.org/)训练和部署机器学习模型。如果你以前没有听说过 PyCaret，请阅读我们的[公告](https://towardsdatascience.com/announcing-pycaret-an-open-source-low-code-machine-learning-library-in-python-4a1f1aad8d46)以快速入门。

在本教程中，我们将使用 PyCaret 开发一个**机器学习管道**，该管道将包括预处理转换和一个回归模型，用于根据人口统计数据和基本的患者健康风险指标（如年龄、BMI、吸烟状态等）预测患者住院费用。

### ???? 在本教程中你将学到什么

+   什么是部署？我们为什么要部署机器学习模型？

+   开发一个机器学习管道并使用 PyCaret 训练模型。

+   使用一个名为 ‘Flask’ 的 Python 框架构建一个简单的 web 应用。

+   在 ‘Heroku’ 上部署一个 web 应用，查看你的模型的实际效果。

### ???? 在本教程中我们将使用哪些工具？

**PyCaret**

[PyCaret](https://www.pycaret.org/) 是一个开源的低代码 Python 机器学习库，用于在生产环境中训练和部署机器学习管道和模型。可以使用 pip 轻松安装 PyCaret。

[PRE0]

**Flask**

[Flask](https://flask.palletsprojects.com/en/1.1.x/) 是一个允许你构建 web 应用的框架。web 应用可以是商业网站、博客、电子商务系统，或者是使用训练模型从实时数据生成预测的应用。如果你没有安装 Flask，你可以使用 pip 来安装。

[PRE1]

**GitHub**

[GitHub](https://www.github.com/) 是一个基于云的服务，用于托管、管理和控制代码。想象一下你在一个大型团队中，多个（有时是数百人）正在进行更改。PyCaret 本身就是一个开源项目的例子，数百名社区开发者不断为源代码做出贡献。如果你以前没有使用过 GitHub，你可以[注册](https://github.com/join)一个免费账户。

**Heroku**

[Heroku](https://www.heroku.com/) 是一个平台即服务（PaaS），它基于管理容器系统，提供集成的数据服务和强大的生态系统来部署网络应用程序。简单来说，这将允许你将应用程序从本地机器迁移到云端，以便任何人都可以通过Web URL访问它。在本教程中，我们选择了Heroku进行部署，因为它在你[注册](https://signup.heroku.com/)新账户时提供了免费的资源小时。

![图像](../Images/d7e260c18d29b72de9c8083c75ff54ef.png)

机器学习工作流程（从训练到PaaS上的部署）

### 为什么要部署机器学习模型？

机器学习模型的部署是将模型在生产环境中提供的过程，其中网络应用程序、企业软件和API可以通过提供新的数据点来使用训练好的模型并生成预测。

通常，机器学习模型的构建是为了预测结果（分类的二值即1或0，[回归](https://www.pycaret.org/regression)的连续值，[聚类](https://www.pycaret.org/clustering)的标签等）。生成预测有两种主要方式：（i）批量预测；（ii）实时预测。在我们的[最后一个教程](https://towardsdatascience.com/machine-learning-in-power-bi-using-pycaret-34307f09394a)中，我们演示了如何在Power BI中部署机器学习模型并进行批量预测。在本教程中，我们将看到如何部署机器学习模型以进行实时预测。

### 业务问题

一家保险公司希望通过更好地预测患者费用来改善现金流预测，使用人口统计数据和住院时的基本健康风险指标。

![图像](../Images/55da7f0ae496ad44230dae57479ebf11.png)

*(*[*数据源*](https://www.kaggle.com/mirichoi0218/insurance#insurance.csv)*)*

### 目标

建立一个网络应用程序，其中输入患者的人口统计和健康信息以预测费用。

### 任务

+   训练和验证模型，并开发一个用于部署的机器学习管道。

+   构建一个基本的HTML前端，包含一个用于独立变量（年龄、性别、BMI、子女、吸烟者、地区）的输入表单。

+   使用Flask框架构建网络应用程序的后端。

+   将网络应用程序部署到Heroku。一旦部署，它将变得公开可用，并可以通过Web URL访问。

### ???? 任务1 — 模型训练和验证

训练和模型验证可以在本地机器或云上的集成开发环境（IDE）或笔记本中进行。在本教程中，我们将使用 PyCaret 在 Jupyter Notebook 中开发机器学习管道并训练回归模型。如果你之前没有使用过 PyCaret， [点击这里](https://towardsdatascience.com/announcing-pycaret-an-open-source-low-code-machine-learning-library-in-python-4a1f1aad8d46) 了解更多关于 PyCaret 的信息，或查看我们网站上的 [入门教程](https://www.pycaret.org/tutorial)。

在本教程中，我们进行了两个实验。第一个实验使用了 PyCaret 中的默认预处理设置（缺失值填补、类别编码等）。第二个实验包含了一些额外的预处理任务，如缩放和归一化、自动特征工程和将连续数据分箱。请查看第二个实验的设置示例：

[PRE2]

![图](../Images/23c9b273943d56697487a97c23d17fc0.png)

两个实验的信息网格比较

神奇的效果只需几行代码。注意在**实验 2**中，转换后的数据集有 62 个训练特征，这些特征来源于原始数据集中的 7 个特征。所有的新特征都是 PyCaret 中转换和自动特征工程的结果。

![图](../Images/4efab6a3013cd24cbd02b82bb1877314.png)

转换后数据集中的列

PyCaret 中模型训练和验证的示例代码：

[PRE3]

![图](../Images/77b5d1d13d4a17347dcdb86135860829.png)

线性回归模型的 10 折交叉验证

注意转换和自动特征工程的影响。R2 值在几乎不费力的情况下提高了 10%。我们可以比较**残差图**，观察线性回归模型在两个实验中的表现，以及转换和特征工程对**异方差性**的影响。

[PRE4]

![图](../Images/3b081a146b5974e560d42e3bfeb4447f.png)

线性回归模型的残差图

机器学习是一个*迭代*的过程。迭代的次数和使用的技术取决于任务的关键性以及预测错误的影响。如果 ICU 中的机器学习模型实时预测病人结果，其严重性和影响远远超过了一个用于预测客户流失的模型。

在本教程中，我们仅进行了两次迭代，第二个实验中的线性回归模型将用于部署。然而，此时模型仍只是笔记本中的一个对象。要将其保存为可以转移并被其他应用程序使用的文件，请运行以下代码：

[PRE5]

当你在PyCaret中保存一个模型时，基于**setup()**函数定义的配置会创建整个转换管道。所有的相互依赖关系都会自动协调。请查看存储在‘deployment_28042020’变量中的管道和模型：

![图示](../Images/9e478a35206a20e549f19d30a9661636.png)

使用PyCaret创建的管道

我们已经完成了第一个任务：训练和选择用于部署的模型。最终的机器学习管道和线性回归模型现在已保存为本地驱动器中的文件，位置由**save_model()**函数定义。（在此示例中：c:/*username*/ins/deployment_28042020.pkl）。

### ???? 任务2 — 构建网页应用程序

现在我们的机器学习管道和模型已准备好，我们将开始构建一个能够连接这些组件并实时生成新数据预测的网页应用程序。这个应用程序有两个部分：

+   前端（使用HTML设计）

+   后端（使用Python中的Flask开发）

### 网页应用程序的前端

一般来说，网页应用程序的前端是使用HTML构建的，这不是本文的重点。我们使用了一个简单的HTML模板和一个CSS样式表来设计一个输入表单。以下是我们网页应用程序前端页面的HTML代码片段。

![图示](../Images/2b54ec5cc7b7325392fccda870773a6d.png)

home.html文件中的代码片段

你不需要成为HTML专家就能构建简单的应用程序。有许多免费的平台提供HTML和CSS模板，并允许通过拖放界面快速构建漂亮的HTML页面。

**CSS样式表**

CSS（也称为层叠样式表）描述了HTML元素在屏幕上的显示方式。这是一种有效控制应用程序布局的方式。样式表包含背景颜色、字体大小和颜色、边距等信息。它们被外部保存为.css文件，并通过包含1行代码链接到HTML。

![图示](../Images/e6172cc6c23d83a4fd3683b3a341b880.png)

home.html文件中的代码片段

### 网页应用程序的后端

网页应用程序的后端是使用Flask框架开发的。对于初学者来说，可以将Flask视为一个库，就像Python中的其他库一样。请参见使用Flask框架编写的Python后端的示例代码片段。

![图示](../Images/feb16c63a07224b37ffa90a4a955a984.png)

app.py文件中的代码片段

如果你记得上面的第1步，我们已经确定了在62个特征上训练的线性回归模型，这些特征是由PyCaret自动生成的。然而，我们的网页应用程序的前端有一个输入表单，只收集六个特征，即年龄、性别、bmi、儿童、吸烟者、地区。

我们如何将新数据点的 6 个特征实时转换为 62 个模型训练时使用的特征？随着模型训练过程中应用的一系列转换，编码变得越来越复杂且耗时。

在 PyCaret 中，所有转换，如类别编码、缩放、缺失值填充、特征工程甚至特征选择，都会在生成预测之前实时自动执行。

> *想象一下，在你可以使用模型进行预测之前，需要编写多少代码来按严格顺序应用所有的转换。实际上，当你想到机器学习时，你应该考虑整个 ML 流程，而不仅仅是模型。*

**测试应用**

在我们将应用程序发布到 Heroku 之前的最后一步是本地测试 Web 应用。打开 Anaconda Prompt 并导航到保存 **‘app.py’** 文件的文件夹。使用以下代码运行 Python 文件：

[PRE6]

![图](../Images/ca5a8bbb6144dfd4c02bc8262e3aff94.png)

执行 app.py 时在 Anaconda Prompt 中的输出

执行后，将 URL 复制到浏览器中，它应该会打开一个托管在本地机器 (127.0.0.1) 上的 Web 应用。尝试输入测试值以查看预测功能是否正常工作。在下面的示例中，预计一个 19 岁的女性吸烟者，没有孩子，位于西南地区的账单为 20,900 美元。

![图](../Images/d5073bc26689c4ed2520b3788f1b4bdc.png)

本地机器上打开的 Web 应用

恭喜！你现在已经构建了你的第一个机器学习应用。现在是时候将这个应用从本地机器转移到云端，以便其他人可以通过 Web URL 使用它。

### ???? 任务 3 — 在 Heroku 上部署 Web 应用

现在模型已经训练好，机器学习管道也准备好了，应用程序也在本地机器上经过测试，我们准备开始在 Heroku 上部署。将应用程序源代码上传到 Heroku 有几种方法。最简单的方法是将 GitHub 代码库链接到你的 Heroku 帐户。

如果你想跟随学习，可以从 GitHub 上 fork 这个 [代码库](https://github.com/pycaret/deployment-heroku)。如果你不知道如何 fork 一个 repo，请 [阅读这个](https://help.github.com/en/github/getting-started-with-github/fork-a-repo) 官方 GitHub 教程。

![图](../Images/b2daa1c271a42ab84e0dcc83c5b4bb87.png)

[https://www.github.com/pycaret/deployment-heroku](https://www.github.com/pycaret/deployment-heroku)

到现在为止，你已经熟悉了上面代码库中的所有文件，除了两个文件，即 **‘requirements.txt’** 和 **‘Procfile’**。

![图](../Images/35693d5786a9d88caa018a90432f0d30.png)

requirements.txt

**requirements.txt** 文件是一个文本文件，包含执行应用程序所需的 Python 包的名称。如果这些包未在应用程序运行的环境中安装，应用程序将会失败。

![图](../Images/17ea811b90d8d3bd37482f7e5a324eec.png)

Procfile

**Procfile** 仅是一行代码，提供给 Web 服务器启动指令，指示在有人登录应用程序时应该首先执行哪个文件。在这个例子中，我们的应用文件名是 ‘**app.py**’，应用名称也是 ‘**app**’。 *(因此是 app:app)*

一旦所有文件都上传到 GitHub 仓库，我们现在准备开始在 Heroku 上进行部署。请按照以下步骤操作：

**步骤 1 — 在 heroku.com 上注册并点击 ‘创建新应用’**

![图示](../Images/aa02c1b6a02bcf867d41f7b46df172b9.png)

Heroku 仪表板

**步骤 2 — 输入应用名称和地区**

![图示](../Images/701e0be8acd243ba464ee5d7a833a8fd.png)

Heroku — 创建新应用

**步骤 3 — 连接到托管代码的 GitHub 仓库**

![图示](../Images/a494b41066c23b3f6fcaab7eb27b91ca.png)

Heroku — 连接到 GitHub

**步骤 4 — 部署分支**

![图示](../Images/3470a80faee1fd99b96f7dcbbb6a69e4.png)

Heroku — 部署分支

**步骤 5 — 等待 5–10 分钟，然后就是 BOOM**

![图示](../Images/5f2d87a6bdbbef8693b83f79722b3d93.png)

Heroku — 成功部署

应用已发布到 URL：[https://pycaret-insurance.herokuapp.com/](https://pycaret-insurance.herokuapp.com/)

![图示](../Images/e1bde245a86a323e2c9dcd6df0112113.png)

[https://pycaret-insurance.herokuapp.com/](https://pycaret-insurance.herokuapp.com/)

在我们结束教程之前，还有最后一件事需要查看。

到目前为止，我们已经构建并部署了一个与我们的机器学习管道配合工作的 Web 应用程序。现在假设你已经有一个企业应用程序，你希望在其中集成模型的预测。你需要的是一个网络服务，你可以通过 API 调用传入数据点并获得预测结果。为此，我们在我们的 **‘app.py’** 文件中创建了 ***predict_api*** 函数。请参见代码片段：

![图示](../Images/9b9346b7d5a4a3870f9877bc5ed6e1f5.png)

app.py 文件中的代码片段（网页应用的后端）

下面是如何使用 requests 库在 Python 中使用这个网络服务：

[PRE7]

![图示](../Images/af12c785bd4cf0f7db433e8b8ce99546.png)

向已发布的网络服务发送请求，以在 Notebook 中生成预测

### 下一教程

在下一个关于部署机器学习管道的教程中，我们将深入探讨如何使用 Docker 容器来部署机器学习管道。我们将演示如何在 Linux 上轻松部署和运行容器化的机器学习应用程序。

关注我们的 [LinkedIn](https://www.linkedin.com/company/pycaret/) 并订阅我们的 [YouTube](https://www.youtube.com/channel/UCxA1YTYJ9BEeo50lxyI_B3g) 频道，以了解更多关于 PyCaret 的信息。

**重要链接**

+   [用户指南 / 文档](https://www.pycaret.org/guide)

+   [GitHub 仓库](https://www.github.com/pycaret/pycaret)

+   [安装 PyCaret](https://www.pycaret.org/install)

+   [Notebook 教程](https://www.pycaret.org/tutorial)

+   [在 PyCaret 中贡献](https://www.pycaret.org/contribute)

**想了解某个特定模块吗？**

自1.0.0版本发布以来，PyCaret提供了以下可用模块。点击下面的链接查看文档和Python中的工作示例。

+   [分类](https://www.pycaret.org/classification)

+   [回归](https://www.pycaret.org/regression)

+   [聚类](https://www.pycaret.org/clustering)

+   [异常检测](https://www.pycaret.org/anomaly-detection)

+   [自然语言处理](https://www.pycaret.org/nlp)

+   [关联规则挖掘](https://www.pycaret.org/association-rules)

**另见：**

PyCaret 入门教程在 Notebook 中：

+   [聚类](https://www.pycaret.org/clu101)

+   [异常检测](https://www.pycaret.org/anom101)

+   [自然语言处理](https://www.pycaret.org/nlp101)

+   [关联规则挖掘](https://www.pycaret.org/arul101)

+   [回归](https://www.pycaret.org/reg101)

+   [分类](https://www.pycaret.org/clf101)

**开发计划中有哪些内容？**

我们正在积极改进 PyCaret。我们未来的发展计划包括一个新的**时间序列预测**模块，与**TensorFlow**的集成，以及 PyCaret 扩展性的重大改进。如果您希望分享您的反馈并帮助我们进一步改进，可以在网站上[填写此表单](https://www.pycaret.org/feedback)或在我们的[GitHub](https://www.github.com/pycaret/)或[LinkedIn](https://www.linkedin.com/company/pycaret/)页面留下评论。

**您想贡献吗？**

PyCaret 是一个开源项目。欢迎大家贡献。如果您希望贡献，请随时处理[开放问题](https://github.com/pycaret/pycaret/issues)。接受包含单元测试的拉取请求，分支为 dev-1.0.1。

如果您喜欢 PyCaret，请在我们的[GitHub 仓库](https://www.github.com/pycaret/pycaret)上给我们⭐️。

Medium : [https://medium.com/@moez_62905/](https://medium.com/@moez_62905/machine-learning-in-power-bi-using-pycaret-34307f09394a)

LinkedIn : [https://www.linkedin.com/in/profile-moez/](https://www.linkedin.com/in/profile-moez/)

Twitter : [https://twitter.com/moezpycaretorg1](https://twitter.com/moezpycaretorg1)

**简介： [Moez Ali](https://www.linkedin.com/in/profile-moez/)** 是一名数据科学家，同时也是 PyCaret 的创始人和作者。

[原文](https://towardsdatascience.com/build-and-deploy-your-first-machine-learning-web-app-e020db344a99)。经许可转载。

**相关：**

+   [宣布 PyCaret 1.0.0](/2020/04/announcing-pycaret.html)

+   [使用 PyCaret 的 Power BI 中的机器学习](/2020/05/machine-learning-power-bi-pycaret.html)

+   [使用 pdpipe 构建 Pandas 流水线](/2019/12/build-pipelines-pandas-pdpipe.html)

* * *

## 我们的三大课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [谷歌网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速进入网络安全职业生涯。

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [谷歌数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升你的数据分析技能

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [谷歌 IT 支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持你的组织 IT

* * *

### 更多相关主题

+   [用 Heroku 部署机器学习网页应用](https://www.kdnuggets.com/2022/04/deploy-machine-learning-web-app-heroku.html)

+   [成为优秀数据科学家所需的5项关键技能](https://www.kdnuggets.com/2021/12/5-key-skills-needed-become-great-data-scientist.html)

+   [每个初学者数据科学家应掌握的6种预测模型](https://www.kdnuggets.com/2021/12/6-predictive-models-every-beginner-data-scientist-master.html)

+   [2021年最佳 ETL 工具](https://www.kdnuggets.com/2021/12/mozart-best-etl-tools-2021.html)

+   [5分钟内构建一个机器学习网页应用](https://www.kdnuggets.com/2022/03/build-machine-learning-web-app-5-minutes.html)

+   [KDnuggets 新闻 2022年3月9日：5分钟内构建一个机器学习网页应用](https://www.kdnuggets.com/2022/n10.html)
