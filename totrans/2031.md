# dbt 数据转换 – 实践教程

> 原文：[https://www.kdnuggets.com/2021/07/dbt-data-transformation-tutorial.html](https://www.kdnuggets.com/2021/07/dbt-data-transformation-tutorial.html)

[评论](#comments)

**由 [Essi Alizadeh](https://www.linkedin.com/in/alizadehesmaeil/) 提供，他是一名工程师和高级数据科学家，处于永久测试阶段**。

![](../Images/570cfd46355d3e26b449a45bfa4b1b3f.png)

* * *

## 我们的前三大课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [Google 网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速进入网络安全职业生涯

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [Google 数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升你的数据分析技能

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [Google IT 支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持你所在组织的 IT

* * *

dbt（数据构建工具）是一个使用 SQL 语句的数据转换工具。它允许你创建复杂的模型，使用变量和宏（即函数），运行测试，生成文档，以及更多功能。

dbt 不进行数据提取或加载，但它在转换已经存在于数据库中的数据方面非常强大 —— dbt 执行 ELT（提取、加载、转换）过程中的 **T** 部分。

在本帖中，你将学习如何：

+   配置 dbt 项目。

+   创建 dbt 模型（SELECT 语句）。

+   使用全局变量和宏构建复杂的 dbt 模型。

+   通过引用其他 dbt 模型来构建复杂模型。

+   运行测试。

+   生成文档。

## 先决条件

### 注册

你可以在 [getdbt.com](https://cloud.getdbt.com/) 注册。免费计划非常适合小型项目和测试。

### 已填充数据的数据库

你可以查看我关于 [如何在 Heroku 上部署 *免费* PostgreSQL 数据库](https://ealizadeh.com/blog/deploy-postgresql-db-heroku) 的文章。该文章提供了逐步的操作指南。你还可以查看 [数据摄取脚本](https://github.com/e-alizadeh/sample_dbt_project/blob/master/data/data_ingestion.py) 和 [GitHub 仓库](https://github.com/e-alizadeh/sample_dbt_project) 中的内容。

根据上述内容，我们在 PostgreSQL 数据库中生成了两个表，这些表将在本帖子中使用。数据库中有两个表，分别命名为 covid_latest 和 population_prosperity。你可以在本帖子相关的 GitHub 仓库中找到摄取脚本。

### dbt CLI 安装

你可以通过访问以下 [dbt 文档页面](https://docs.getdbt.com/dbt-cli/installation/) 来安装 dbt 命令行界面（CLI）。

## dbt 项目的基础

使用 dbt 工具需要了解三件主要事项：

+   dbt 项目

+   数据库连接

+   dbt 命令

### 如何使用 dbt？

dbt 项目是一个包含 *.sql* 和 *.yml* 文件的目录。最低要求的文件包括：

+   一个名为 *dbt_project.yml* 的项目文件：该文件包含 dbt 项目的配置。

+   模型（*.sql* 文件）：dbt 中的模型仅仅是一个包含 **单个** ***select*** **语句** 的 *.sql* 文件。

每个 dbt 项目需要一个 *dbt_project.yml* 文件——这告诉 dbt 一个目录是一个 dbt 项目。它还包含了告诉 dbt 如何操作你的项目的重要信息。

你可以在 [这里](https://docs.getdbt.com/docs/introduction#dbt-projects) 找到有关 dbt 项目的更多信息。

> 一个 **dbt 模型** 基本上是一个 *.sql* 文件，包含一个 **SELECT** 语句。

### dbt 命令

dbt 命令以 *dbt* 开头，并可以通过以下方式之一执行：

+   dbt Cloud（dbt Cloud 仪表板底部的命令部分），

+   dbt CLI

一些命令只能在 dbt CLI 中使用，如 *dbt init*。本帖中我们将使用的 dbt 命令包括

+   *dbt init*（仅在 dbt CLI 中使用）

+   *dbt run*

+   *dbt test*

+   *dbt docs generate*

## dbt 项目设置

### 步骤 1：使用 dbt CLI 初始化一个 dbt 项目（示例文件）

你可以使用 [dbt init](https://docs.getdbt.com/reference/commands/init) 生成示例文件/文件夹。特别是，*dbt init project_name* 将创建以下内容：

+   如果还不存在的话，*~/.dbt/profiles.yml* 文件

+   一个名为 *[project_name]* 的新文件夹

+   开始使用 dbt 所需的目录和示例文件

> **警告**：由于 *dbt init* 会生成一个名为 *project_name* 的目录，为了避免任何冲突，你 *不应有任何同名的现有文件夹*。

![](../Images/d65e97387ef5c3e9288422b2cb3d5ecb.png)

*dbt init <project_name>*

结果是一个包含以下示例文件的目录。

```py
sample_dbt_project
├── README.md
├── analysis
├── data
├── dbt_project.yml
├── macros
├── models
│   └── example
│       ├── my_first_dbt_model.sql
│       ├── my_second_dbt_model.sql
│       └── schema.yml
├── snapshots
└── tests

```

对于这篇文章，我们将只考虑最小文件，并移除多余的内容。

```py
sample_dbt_project
├── README.md
├── dbt_project.yml
└── models
    ├── my_first_dbt_model.sql
    ├── my_second_dbt_model.sql
    └── schema.yml

```

### 步骤 2：设置 Git 仓库

你可以使用在设置过程中指定的现有仓库。你可以通过以下 [文档](https://docs.getdbt.com/docs/dbt-cloud/cloud-configuring-dbt-cloud/cloud-configuring-repositories) 配置这些仓库。

**或者，如果你想创建一个新仓库...**

你可以从创建的目录内部创建一个新的仓库。你可以按以下方式进行：

```py
git init
git add .
git commit -m "first commit"
git remote add origing 
git push -u origin master

```

### 步骤 3：在 dbt Cloud 仪表板上设置新项目

在之前的步骤中，我们创建了一个包含样本模型和配置的 dbt 项目。现在，我们要创建一个新项目，并在 dbt Cloud 仪表板上连接我们的数据库和仓库。

在继续之前，你应该

+   数据库中已有的一些数据，

+   之前步骤生成的文件所在的仓库

你可以按照以下步骤在 dbt Cloud 中设置新项目（请记住，这一步与之前的步骤不同，因为我们仅生成了一些示例文件）。

我们项目的 *dbt_project.yml* 文件如下所示（你可以在 [GitHub 仓库](https://github.com/e-alizadeh/sample_dbt_project.git) 中找到完整版本）。

```py
name: 'my_new_project'
version: '1.0.0'
config-version: 2

vars:
  selected_country: USA
	selected_year: 2019

# This setting configures which "profile" dbt uses for this project.
profile: 'default'

# There are other stuff that are generated automatically when you run `dbt init`

```

*dbt_project.yml*

## dbt 模型和功能

### dbt 模型

让我们创建简单的 dbt 模型，提取表的几个列。

```py
select "iso_code", "total_cases", "new_cases" from covid_latest

```

***covid19_latest_stats** dbt 模型 (models/covid19_latest_stats.sql)*

```py
select "code", "year", "continent", "total_population" from population_prosperity

```

***population** dbt 模型 (models/population.sql)*

> **注意：** dbt 模型名称是 *models* 目录中 sql 文件的文件名。模型名称可能与数据库中的表名称不同。例如，上述 dbt 模型 *population* 是对数据库中 *population_prosperity* 表的 *SELECT* 语句的结果。

### 运行模型

你可以通过执行 *dbt run* 来运行 dbt 项目中的所有模型。下面显示了一个 dbt 运行的示例输出。你可以查看运行所有 dbt 模型的摘要或详细日志。这有助于调试你可能在查询中遇到的任何问题。例如，你可以看到一个抛出 Postgres 错误的失败模型。

![](../Images/5afcff8ce22f5e73cb4b0bc0374d7436.png)

*详细的失败**jinja_and_variable_usage** dbt 模型日志。*

### Jinja 与宏

dbt 使用 [Jinja](https://jinja.palletsprojects.com/) 模板语言，这使得 dbt 项目成为 SQL 的理想编程环境。借助 Jinja，你可以执行 SQL 中通常不可能的转换，比如使用环境变量或宏——抽象的 SQL 片段，类似于大多数编程语言中的函数。每当你看到 *{{ ... }}* 时，你已经在使用 Jinja。有关 Jinja 和其他 Jinja 风格函数的更多信息，你可以查看 [dbt 文档](https://docs.getdbt.com/docs/building-a-dbt-project/jinja-macros/)。

在本文后面，我们将介绍由 dbt 定义的自定义宏。

### 使用变量

**定义一个变量**

你可以在 *dbt_project.yml* 的 *vars* 部分下定义变量。例如，我们定义一个名为 *selected_country* 的变量，默认值为 *USA*，另一个名为 *selected_year* 的变量，默认值为 *2019*。

```py
name: 'my_new_project'
version: '1.0.0'
config-version: 2

vars:
  selected_country: USA
	selected_year: 2019

```

*dbt_project.yml*

**使用变量**

你可以通过 [*var()*](https://docs.getdbt.com/reference/dbt-jinja-functions/var) Jinja 函数 (*{{ var("var_key_name") }}*) 在 dbt 模型中使用变量。

### 宏

在 *dbt_utils* 中有许多有用的转换和宏可以在你的项目中使用。有关所有可用宏的列表，你可以查看他们的 [GitHub repo](https://hub.getdbt.com/dbt-labs/dbt_utils/latest/)。

现在，让我们将 dbt_utils 添加到我们的项目中，并通过以下步骤安装：

1.  将 dbt_utils 宏添加到你的 *packages.yml* 文件中，如下所示：

```py
packages:
  - package: dbt-labs/dbt_utils
    version: 0.6.6

```

*将 **dbt_utils** 包添加到 packages.yml。*

1.  运行 *dbt deps* 以安装包。

![](../Images/2028a0e2a0e1b6af8f7bc1f4f7dde969.png)

*使用 **dbt deps** 安装包。*

### 复杂的 dbt 模型

这些模型（选择）通常是堆叠在一起的。为了构建更复杂的模型，你需要使用 [ref()](https://docs.getdbt.com/reference/dbt-jinja-functions/ref) 宏。*ref()* 是 dbt 中最重要的函数，因为它允许你引用其他模型。例如，你可能会有一个执行多种操作的模型（即 SELECT 查询），而你不想在其他模型中使用它。如果不使用前面介绍的宏，构建复杂模型将会很困难。

**使用 *ref()* 和全局变量的 dbt 模型**

我们可以使用前面定义的两个 dbt 模型构建更复杂的模型。例如，让我们创建一个新的 dbt 模型，该模型根据国家代码连接上述两个表，然后根据选定的国家和年份进行筛选。

```py
select *
from {{ref('population')}} 
inner join {{ref('covid19_latest_stats')}} 
on {{ref('population')}}.code = {{ref('covid19_latest_stats')}}.iso_code 
where code='{{ var("selected_country") }}' AND year='{{ var("selected_year") }}'

```

***jinja_and_variable_usage** dbt 模型 (models/jinja_and_variable_usage.sql)。*

关于上述查询的几点说明：

+   *{{ref('dbt_model_name')}}* 用于引用项目中可用的 dbt 模型。

+   你可以从模型中获取像 *{{ref('dbt_model_name')}}.column_name* 这样的列。

+   你可以通过 *{{var("variable_name")}}* 使用在 *dbt_project.yml* 文件中定义的变量。

上述代码片段通过国家代码连接人口和 covid19_latest_stats 模型的数据，并根据 selected_country=USA 和 selected_year=2019 进行筛选。模型的输出如下所示。

![](../Images/536bc58271b80fed3154adcbe66cc106.png)

*输出的 **jinja_and_variable_usage** dbt 模型结果。*

你还可以通过点击 **compile sql** 按钮查看编译后的 SQL 代码片段。这非常有用，特别是当你想在 dbt 工具之外运行查询时。

![](../Images/e65cf74e2b860e338dcbf5376561fd6d.png)

*编译后的 SQL 代码用于 **jinja_and_variable_usage** dbt 模型。*

**使用 dbt_utils 包和宏的 dbt 模型**

*dbt_utils* 包含了你可以在 dbt 项目中使用的宏（即函数）。所有宏的列表可以在 [dbt_utils 的 GitHub 页面](https://github.com/dbt-labs/dbt-utils/) 上找到。

让我们在 dbt 模型中使用 dbt_utils 的 [pivot()](https://github.com/dbt-labs/dbt-utils/#pivot-source) 和 [get_column_values()](https://github.com/dbt-labs/dbt-utils/#get_column_values-source) 宏，如下所示：

```py
select
  continent,
  {{ dbt_utils.pivot(
      "population.year",
      dbt_utils.get_column_values(ref('population'), "year")
  ) }}
from {{ ref('population') }}
group by continent

```

***using_dbt_utils_macros** dbt 模型 (models/using_dbt_utils_macros.sql)。*

上述 dbt 模型将在 dbt 中编译成以下 SQL 查询。

```py
select
  continent,
    sum(case when population.year = '2015' then 1 else 0 end) as "2015",
		sum(case when population.year = '2017' then 1 else 0 end) as "2017",
		sum(case when population.year = '2017' then 1 else 0 end) as "2016",
		sum(case when population.year = '2017' then 1 else 0 end) as "2018",
		sum(case when population.year = '2017' then 1 else 0 end) as "2019"
from "d15em1n30ihttu"."dbt_ealizadeh"."population"
group by continent
limit 500
/* limit added automatically by dbt cloud */

```

*编译后的 SQL 查询来自 **using_dbt_utils_macros** dbt 模型。*

## 在 dbt 中运行测试

使用 dbt 的另一个好处是能够测试你的数据。开箱即用的 dbt 包含以下通用测试：*unique*、*not_null*、*accepted_values* 和 *relationships*。这些测试在模型上的示例如下所示：

```py
version: 2

models:
    - name: covid19_latest_stats
      description: "A model of latest stats for covid19"
      columns:
          - name: iso_code
            description: "The country code"
            tests:
                - unique
                - not_null

```

*schema.yml (dbt 测试)。*

你可以通过 *dbt test* 运行这些测试。你可以看到下面的输出。

![](../Images/15b74802bbc411868a0a0777cc846927.png)

*在 dbt Cloud 仪表板上运行 dbt 测试的结果。*

有关 dbt 测试的更多信息，请访问 [dbt 文档](https://docs.getdbt.com/docs/building-a-dbt-project/tests)。

## 在 dbt 中生成文档

你可以通过简单地在命令部分运行 *dbt docs generate* 来为你的 dbt 项目生成文档，如下所示。

![](../Images/a58d67a7303b580ee42a5ccf732e536b.png)

*为 dbt 项目生成文档。*

你可以通过点击 **查看文档** 来浏览生成的文档。你可以在下面看到生成文档的概述。

除了 dbt docs generate，dbt docs 还可以提供生成的文档的 Web 服务器。为此，你只需运行 dbt docs serve。有关为你的 dbt 项目生成文档的更多信息，请查看 [这里](https://docs.getdbt.com/docs/building-a-dbt-project/documentation)。

## 其他功能

### 使用 Hooks 和 Operations 进行数据库管理

有些数据库管理任务需要运行额外的 SQL 查询，例如：

+   创建用户定义函数

+   授予表权限

+   以及更多

dbt 有两个接口（hooks 和 operations）来执行这些任务，重要的是，它们都进行了版本控制。这里简要介绍了 hooks 和 operations。有关更多信息，你可以查看 [dbt 文档](https://docs.getdbt.com/docs/building-a-dbt-project/hooks-operations)。

### Hooks

Hooks 只是一些在不同时间执行的 SQL 代码片段。Hooks 在 *dbt_project.yml* 文件中定义。不同的 hooks 包括：

+   *pre-hook*：在构建模型之前执行

+   *post-hook*：在构建模型后执行

+   *on-run-start*：在 dbt 运行开始时执行

+   *on-run-end*：在 dbt 运行结束时执行

### 操作

操作是一种方便的方式来调用宏，而无需运行模型。操作是通过 [dbt run-operation](https://docs.getdbt.com/reference/commands/run-operation) 命令触发的。请注意，与 hooks 不同，你需要显式执行 SQL 语句在 [dbt 操作](https://docs.getdbt.com/docs/building-a-dbt-project/hooks-operations#operations) 中。

## 结论

dbt 是一个很棒的工具，绝对值得尝试，因为它可以简化你的数据 ELT（或 ETL）流程。在这篇文章中，我们学习了如何设置和使用 dbt 进行数据转换。我向你展示了这个工具的不同功能。特别是，我提供了一个逐步的指南，内容包括：

+   配置 dbt 项目

+   创建 dbt 模型（SELECT 语句）

+   使用全局变量和宏构建复杂的 dbt 模型

+   通过引用其他 dbt 模型来构建复杂模型

+   运行测试

+   生成文档

你可以在下面找到包含所有脚本（包括数据摄取脚本）的 [GitHub 仓库](https://github.com/e-alizadeh/sample_dbt_project)。*随意克隆本文的源代码。*

**个人简介：** [Essi Alizadeh](https://ealizadeh.com/) ([@es_alizadeh](https://twitter.com/es_alizadeh)) 是一名工程师和高级数据科学家，始终处于不断进步的状态。他喜欢撰写关于各种技术、统计学、时间序列和机器学习的文章。

**相关：**

+   [介绍dbt，ETL和ELT的颠覆者](https://www.kdnuggets.com/2021/03/dbt-etl-elt-disrupter.html)

+   [前4大数据提取工具](https://www.kdnuggets.com/2021/05/top-4-data-extraction-tools.html)

+   [SQL数据准备，附备忘单！](https://www.kdnuggets.com/2021/05/data-preparation-sql-cheat-sheet.html)

### 更多相关话题

+   [实战强化学习课程第3部分：SARSA](https://www.kdnuggets.com/2022/01/handson-reinforcement-learning-course-part-3-sarsa.html)

+   [实战强化学习课程，第1部分](https://www.kdnuggets.com/2021/12/hands-on-reinforcement-learning-course-part-1.html)

+   [强化学习课程实战，第2部分](https://www.kdnuggets.com/2021/12/hands-on-reinforcement-learning-part-2.html)

+   [大语言模型生成式AI：实战培训](https://www.kdnuggets.com/2023/07/generative-ai-large-language-models-handson-training.html)

+   [有监督学习实战：线性回归](https://www.kdnuggets.com/handson-with-supervised-learning-linear-regression)

+   [无监督学习实战：K均值聚类](https://www.kdnuggets.com/handson-with-unsupervised-learning-kmeans-clustering)
