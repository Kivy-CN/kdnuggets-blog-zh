# 使用 Docker 容器将机器学习管道部署到云端

> 原文：[https://www.kdnuggets.com/2020/06/deploy-machine-learning-pipeline-cloud-docker.html](https://www.kdnuggets.com/2020/06/deploy-machine-learning-pipeline-cloud-docker.html)

[评论](#comments)

**由 [Moez Ali](https://www.linkedin.com/in/profile-moez/) 创始人兼 PyCaret 作者**

![](../Images/5349163e540ab0ae4854ac1f9ff52edd.png)

### **总结**

在我们 [上一篇文章](https://towardsdatascience.com/build-and-deploy-your-first-machine-learning-web-app-e020db344a99) 中，我们演示了如何开发一个机器学习管道并使用 PyCaret 和 Flask 框架在 Python 中将其部署为网络应用。如果你之前没有听说过 PyCaret，请阅读这个 [公告](https://towardsdatascience.com/announcing-pycaret-an-open-source-low-code-machine-learning-library-in-python-4a1f1aad8d46) 以了解更多信息。

在本教程中，我们将使用之前构建和部署的相同机器学习管道和 Flask 应用。这次我们将演示如何使用 [Microsoft Azure Web App Service](https://azure.microsoft.com/en-us/services/app-service/web/) 将机器学习管道作为网络应用部署。

为了在 Microsoft Azure 上部署机器学习管道，我们需要将我们的管道容器化为一个叫做 **“Docker”** 的软件。如果你不知道容器化是什么意思，*没问题* — 本教程正是关于这个的。

### ???? 本教程的学习目标

+   什么是容器？什么是 Docker？我们为什么需要它？

+   在本地计算机上构建一个 Docker 文件并将其发布到 [Azure Container Registry (ACR)](https://azure.microsoft.com/en-us/services/container-registry/)。

+   使用我们上传到 ACR 的容器在 Azure 上部署一个网络服务。

+   观看一个使用训练好的机器学习管道实时预测新数据点的网络应用。

在我们上一篇文章中，我们介绍了模型部署的基本概念及其必要性。如果你想了解更多关于模型部署的内容， [点击这里](https://towardsdatascience.com/build-and-deploy-your-first-machine-learning-web-app-e020db344a99) 阅读我们的上一篇文章。

本教程将涵盖从本地构建容器到将其推送到 Azure Container Registry，然后将我们预训练的机器学习管道和 Flask 应用部署到 Azure Web Services 的整个工作流程。

![图示](../Images/d36fc51994d651c09f77854c9f90fa8f.png)

工作流程：创建镜像 → 在本地构建容器 → 推送到 ACR → 在云端部署应用

### ???? 本教程的工具箱

**PyCaret**

[PyCaret](https://www.pycaret.org/) 是一个开源的低代码 Python 机器学习库，用于训练和部署机器学习管道和模型到生产环境中。PyCaret 可以通过 pip 简单安装。

[PRE0]

**Flask**

[Flask](https://flask.palletsprojects.com/en/1.1.x/) 是一个框架，允许你构建 web 应用程序。一个 web 应用程序可以是商业网站、博客、电子商务系统，或者是一个利用训练模型从实时数据中生成预测的应用。如果你还没有安装 Flask，可以使用 pip 进行安装。

****Docker****

[Docker](https://www.docker.com/) 是一个工具，旨在通过使用容器简化应用程序的创建、部署和运行。容器用于将应用程序及其所有必要组件（如库和其他依赖项）打包在一起，并将其作为一个整体进行交付。如果你以前没有使用 docker，本教程还涵盖了在 Windows 10 上安装 docker 的步骤。

****Microsoft Azure****

[Microsoft Azure](https://azure.microsoft.com/en-ca/overview/what-is-azure/) 是一组云服务，用于在大规模全球网络上构建、管理和部署应用程序。其他常用于部署 ML 管道的云服务有 [Amazon Web Services (AWS)](https://aws.amazon.com/)、[Google Cloud](https://cloud.google.com/)、[IBM Cloud](https://www.ibm.com/cloud) 和 [Alibaba Cloud](https://www.alibabacloud.com/)。我们将在未来的教程中涵盖大部分服务。

如果你以前没有使用 Microsoft Azure，你可以在这里 [注册](https://azure.microsoft.com/en-ca/free/search/?&ef_id=EAIaIQobChMIm8Onqp6i6QIViY7ICh2QVA2jEAAYASAAEgK9FvD_BwE:G:s&OCID=AID2000061_SEM_EAIaIQobChMIm8Onqp6i6QIViY7ICh2QVA2jEAAYASAAEgK9FvD_BwE:G:s&dclid=CK6R8aueoukCFVbJyAoduGYLcQ) 免费账户。首次注册时，你会获得前 30 天的免费信用。你可以利用这些信用来按照本教程构建你自己的 web 应用。

### 什么是容器，为什么我们需要它？

你是否曾遇到过这样的问题：你的 python 代码 (*或任何其他代码*) 在你的计算机上运行正常，但当你的朋友尝试运行完全相同的代码时，它却无法运行？如果你的朋友重复了完全相同的步骤，他们应该得到相同的结果，对吗？一句话回答是 ***环境***。你朋友的 Python 环境与你的不同。

环境包括什么？→ Python (*或你使用的任何其他语言*) 以及构建和测试应用程序所使用的所有库和依赖项的确切版本。

如果我们能以某种方式创建一个可以转移到其他机器（例如：你朋友的计算机或像 Microsoft Azure 这样的云服务提供商）的环境，我们就能在任何地方重现结果。

因此，**容器** 是一种软件类型，它将应用程序及其所有依赖项打包起来，使得应用程序能够在不同的计算环境中可靠地运行。

> “当你想到**容器**时，想想容器。”

![Figure](../Images/cdba43a7a6535b917ba7ad58a0bb936b.png)

[https://www.freepik.com/free-photos-vectors/cargo-ship](https://www.freepik.com/free-photos-vectors/cargo-ship)

这是在数据科学中理解容器的最直观方式。**它们就像船上的集装箱**，目标是将一个集装箱的*内容*与其他集装箱隔离开来，以避免混淆。这正是数据科学中容器的用途。

现在我们理解了容器背后的比喻，让我们看看创建应用程序隔离环境的其他选项。一种简单的替代方案是为每个应用程序配备一台独立的机器。

（1台机器 = 1个应用 = 无冲突 = 一切正常）

使用独立的机器是直接的，但它并不超越使用容器的好处，因为为每个应用程序维护多个机器是昂贵的、难以维护且难以扩展。简而言之，在许多实际场景中，这并不实际。

创建隔离环境的另一种选择是**虚拟机**。这里容器更为优选，因为它们所需资源更少、便于移植且启动速度更快。

![图示](../Images/154947460cf6ccd317e662a3c46f5b36.png)

虚拟机 vs. 容器

你能辨别虚拟机和容器之间的区别吗？使用容器时，你不需要客操作系统。假设在虚拟机上运行10个应用程序。这将需要10个客操作系统，而使用容器则不需要。

### 我了解容器，但Docker是什么？

Docker是一家提供软件（也叫Docker）的公司，该软件允许用户构建、运行和管理容器。虽然Docker的容器最为常见，但还有其他不那么著名的*替代品*，如[LXD](https://linuxcontainers.org/lxd/introduction/)和[LXC](https://linuxcontainers.org/)，也提供容器解决方案。

在本教程中，我们将使用**Docker Desktop for Windows**来创建一个容器，并将其发布到Azure容器注册表。然后，我们将使用该容器部署一个Web应用程序。

![](../Images/1f2d661aa18345bf13d584bc5d593e19.png)

### Docker镜像 vs. Docker容器

Docker镜像和Docker容器之间有什么区别？这是迄今为止最常被问到的问题，所以让我们立即解答。虽然有许多技术定义，但将Docker镜像视为容器创建的模具是直观的。镜像本质上是容器的快照。

如果你希望更技术性的定义，可以这样考虑：Docker镜像在运行时会在Docker引擎上变成容器。

### **打破炒作：**

到了最后，docker只是一个文件，里面包含几行指令，保存在你的项目文件夹中，名字是***“Dockerfile”***。

另一种理解 docker 文件的方法是将它们看作是你在自己厨房里发明的食谱。当你将这些食谱与其他人分享并且他们按照相同的指示操作时，他们能够制作出相同的菜肴。类似地，你可以将你的 docker 文件分享给其他人，他们可以基于该 docker 文件创建镜像并运行容器。

现在你了解了容器、docker 以及我们为什么要使用它们，让我们快速设定业务背景。

### 设定业务背景

一家保险公司希望通过在住院时利用人口统计和基本患者健康风险指标来更好地预测患者费用，从而改善其现金流预测。

![图](../Images/3638fa2bffed356be35c42d85a72bc00.png)

*(*[*数据源*](https://www.kaggle.com/mirichoi0218/insurance#insurance.csv)*)*

### 目标

构建和部署一个 Web 应用程序，其中患者的基本人口统计和健康信息输入到一个基于 Web 的表单中，然后输出预测的费用金额。

### 任务

+   训练和开发一个机器学习管道以供部署。

+   使用 Flask 框架构建一个 Web 应用。它将利用训练好的 ML 管道实时生成对新数据点的预测。

+   创建一个 docker 镜像和容器。

+   将容器发布到 Azure 容器注册表（ACR）。

+   将 Web 应用发布到容器中，通过发布到 ACR。一旦部署，它将变得公开可用，并可以通过 Web URL 进行访问。

由于我们在上一个教程中已经涵盖了前两个任务，我们将快速回顾它们并重点关注上述列表中的剩余任务。如果你有兴趣了解更多关于如何使用 PyCaret 开发机器学习管道以及使用 Flask 框架构建 Web 应用程序的内容，你可以阅读我们的 [最新教程](https://towardsdatascience.com/build-and-deploy-your-first-machine-learning-web-app-e020db344a99)。

### ???? 开发机器学习管道

我们在 Python 中使用 PyCaret 来训练和开发一个机器学习管道，该管道将作为我们 Web 应用的一部分。机器学习管道可以在集成开发环境（IDE）或笔记本中开发。我们使用了一个笔记本来运行以下代码：

当你在 PyCaret 中保存模型时，基于 **setup()** 函数中定义的配置，会创建整个转换管道。所有的相互依赖关系都会自动协调。查看存储在‘deployment_28042020’变量中的管道和模型：

![图](../Images/e083836af4d5fa14164ce9cc5be82f4a.png)

使用 PyCaret 创建的机器学习管道

### ???? 构建 Web 应用程序

本教程不专注于构建 Flask 应用程序。这里只是为了完整性讨论。现在我们的机器学习管道已经准备好，我们需要一个可以连接到训练好的管道以实时生成新数据点预测的 web 应用程序。我们使用 Python 的 Flask 框架创建了这个 web 应用程序。这个应用程序有两个部分：

+   前端（使用 HTML 设计）

+   后端（使用 Flask 开发）

这是我们的 web 应用程序的样子：

![图像](../Images/74d5a86c0b0e35e02a454d152185105a.png)

本地机器上打开的 web 应用程序

如果你想查看这个 web 应用程序的实际效果，[点击这里](https://pycaret-insurance.herokuapp.com/) 打开部署在 Heroku 上的 web 应用程序（*可能需要几分钟时间才能打开*）。

如果你没有跟随步骤，也没关系。你可以简单地从 GitHub 上 fork 这个 [代码库](https://github.com/pycaret/deployment-heroku)。如果你不知道如何 fork 一个仓库，请 [阅读此](https://help.github.com/en/github/getting-started-with-github/fork-a-repo) 官方 GitHub 教程。到目前为止，你的项目文件夹应该是这样的：

![图像](../Images/68dd5ccdf9051f74b93e6be42b09eaef.png)

[https://github.com/pycaret/deployment-heroku](https://github.com/pycaret/deployment-heroku)

现在我们有了一个功能齐全的 web 应用程序，我们可以开始使用 Docker 容器化该应用程序的过程。

### 在 docker 容器中部署 ML 管道的 10 个步骤：

### ???? **步骤 1 — 为 Windows 安装 Docker Desktop**

你可以在 Mac 和 Windows 上使用 Docker Desktop。根据你的操作系统，你可以从 [这个链接](https://docs.docker.com/docker-for-windows/install/) 下载 Docker Desktop。在本教程中，我们将使用 Windows 版的 Docker Desktop。

![图像](../Images/0193062c5b309be0de0c073493e45241.png)

[https://hub.docker.com/editions/community/docker-ce-desktop-windows/](https://hub.docker.com/editions/community/docker-ce-desktop-windows/)

检查安装是否成功的最简单方法是打开命令提示符并输入‘docker’。它应该打印出帮助菜单。

![图像](../Images/bb29701d985ed8948f31b1ee816aa065.png)

命令提示符

### ???? **步骤 2 — 安装 Kitematic**

Kitematic 是一个直观的图形用户界面（GUI），用于在 Windows 或 Mac 上运行 Docker 容器。你可以从 [Docker 的 GitHub 仓库](https://github.com/docker/kitematic/releases) 下载 Kitematic。

![图像](../Images/1693d830cdb6090cb447f35bdc84f9cb.png)

[https://github.com/docker/kitematic/releases](https://github.com/docker/kitematic/releases)

下载完成后，简单地将文件解压到所需的位置。

### ???? 步骤 3 — 创建 Dockerfile

创建 Docker 镜像的第一步是创建一个 Dockerfile。Dockerfile 只是一个包含一系列指令的文件。这个项目的 Dockerfile 如下所示：

Dockerfile 是区分大小写的，必须与其他项目文件一起放在项目文件夹中。Dockerfile 没有扩展名，可以使用任何编辑器创建。我们使用了 [Visual Studio Code](https://code.visualstudio.com/) 来创建它。

### ???? 步骤 4 — 创建 Azure Container Registry

如果你没有 Microsoft Azure 帐户或以前没有使用过，你可以 [注册](https://azure.microsoft.com/en-ca/free/search/?&ef_id=EAIaIQobChMIm8Onqp6i6QIViY7ICh2QVA2jEAAYASAAEgK9FvD_BwE:G:s&OCID=AID2000061_SEM_EAIaIQobChMIm8Onqp6i6QIViY7ICh2QVA2jEAAYASAAEgK9FvD_BwE:G:s&dclid=CK6R8aueoukCFVbJyAoduGYLcQ) 免费。当你第一次注册时，你将获得 30 天的免费信用。你可以利用这些信用在 Azure 上构建和部署 Web 应用。注册后，请按照以下步骤操作：

+   登录 [https://portal.azure.com](https://portal.azure.com/)。

+   点击 Create a Resource。

+   搜索 Container Registry 并点击 Create。

+   选择订阅、资源组和注册表名称（在我们的例子中：**pycaret.azurecr.io** 是我们的注册表名称）

![图](../Images/c3cd0dfaa68dc7cfa09972c543a0f48a.png)

[https://portal.azure.com](https://portal.azure.com/) → 登录 → 创建资源 → 容器注册表

### ???? 步骤 5 — 构建 Docker 镜像

一旦在 Azure 门户中创建了注册表，第一步是使用命令行构建 Docker 镜像。导航到项目文件夹并执行以下代码。

[PRE1]

![图](../Images/ce0bca0cd5356ff48f0f004a225c0804.png)

使用 Anaconda 提示符构建 Docker 镜像

+   **pycaret.azurecr.io** 是你在 Azure 门户上创建资源时获得的注册表名称。

+   **pycaret-insurance** 是镜像的名称，**latest** 是标签。这可以是任何你想要的。

### ???? 步骤 6 — 从 Docker 镜像运行容器

镜像创建完成后，我们将在本地运行容器并测试应用程序，然后再将其推送到 Azure Container Registry。要在本地运行容器，请执行以下代码：

[PRE2]

一旦成功执行该命令，它将返回创建的容器的 ID。

![图](../Images/70aff8bb9e5fa36be04d0b1352c066a1.png)

本地运行 Docker 容器

### ???? 步骤 7 — 在本地机器上测试容器

打开 Kitematic，你应该能够看到一个正在运行的应用程序。

![图](../Images/d42673b1b682d7e0b09991e275f2bdb7.png)

Kitematic — 用于在 Mac 和 Windows 操作系统上管理容器的 GUI

你可以通过在互联网浏览器中访问 localhost:5000 来查看应用程序的运行效果。它应该会打开一个 Web 应用。

![图](../Images/290e31b7ffe644c78001c81cfe1a3aef.png)

在本地容器上运行的应用程序（localhost:5000）

确保完成后，使用 Kitematic 停止应用程序，否则它会继续占用你计算机上的资源。

### ???? 步骤 8 — 认证 Azure 凭据

在你可以将容器上传到 ACR 之前的最后一步是认证本地机器上的 Azure 凭据。请在命令行中执行以下代码：

[PRE3]

系统会提示你输入用户名和密码。用户名是你的注册表名称（在此示例中用户名是“pycaret”）。你可以在你创建的 Azure 容器注册表资源的访问密钥下找到你的密码。

![图](../Images/d0337b320bc86533207850e4e0f29bc4.png)

portal.azure.com → Azure 容器注册表 → 访问密钥

### ???? 第9步— 将容器推送到 Azure 容器注册表

现在你已经对 ACR 进行了身份验证，你可以通过执行以下代码将你创建的容器推送到 ACR：

[PRE4]

根据容器的大小，推送命令可能需要一些时间来将容器转移到云端。

### ???? 第10步— 创建 Azure Web 应用程序并查看你的模型运行情况

要在 Azure 上创建 Web 应用程序，请按照以下步骤操作：

+   登录到 [https://portal.azure.com](https://portal.azure.com/)。

+   点击创建资源。

+   搜索 Web 应用程序并点击创建。

+   将你在（上面的第9步）推送的 ACR 镜像链接到你的应用程序。

![图](../Images/22a2abf6db31a730b356cbd968f18639.png)

portal.azure.com → Web 应用程序 → 创建 → 基本![图](../Images/a1f869ad7af3059d8ff926543ec325c9.png)

portal.azure.com → Web 应用程序 → 创建 → Docker

**砰!! 应用程序现在在 Azure Web Services 上运行。**

![图](../Images/97ea9420283775e2ae0dddedd3685694.png)

https://pycaret-insurance2.azurewebsites.net

**注意：** 在此故事发布时，来自 [https://pycaret-insurance2.azurewebsites.net](https://pycaret-insurance2.azurewebsites.net/) 的应用程序将被删除以限制资源消耗。

[**该教程的 GitHub 存储库链接。**](https://github.com/pycaret/pycaret-deployment-azure)

[**Heroku 部署的 GitHub 存储库链接。**](https://www.github.com/pycaret/deployment-heroku)** *(无 Docker)* **

### 下一教程

在接下来的机器学习管道部署教程中，我们将深入探讨如何使用 Google Cloud 和 Microsoft Azure 上的 Kubernetes 服务来部署机器学习管道。

关注我们的 [LinkedIn](https://www.linkedin.com/company/pycaret/) 并订阅我们的 [YouTube](https://www.youtube.com/channel/UCxA1YTYJ9BEeo50lxyI_B3g) 频道，以了解更多关于 PyCaret 的信息。

### 重要链接

+   [用户指南 / 文档](https://www.pycaret.org/guide)

+   [GitHub 存储库](https://www.github.com/pycaret/pycaret)

+   [安装 PyCaret](https://www.pycaret.org/install)

+   [笔记本教程](https://www.pycaret.org/tutorial)

+   [在 PyCaret 中贡献](https://www.pycaret.org/contribute)

### PyCaret 1.0.1 即将到来！

我们收到了社区的热烈支持和反馈。我们正在积极改进 PyCaret 并为下一版本做准备。**PyCaret 1.0.1 将更大更好**。如果你希望分享你的反馈并帮助我们进一步改进，你可以 [填写此表单](https://www.pycaret.org/feedback) 或在我们的 [GitHub](https://www.github.com/pycaret/) 或 [LinkedIn](https://www.linkedin.com/company/pycaret/) 页面留下评论。

### 想了解特定模块吗？

从首次发布的 1.0.0 版本开始，PyCaret 提供以下模块供使用。点击下面的链接查看文档和 Python 示例。

+   [分类](https://www.pycaret.org/classification)

+   [回归分析](https://www.pycaret.org/regression)

+   [聚类分析](https://www.pycaret.org/clustering)

+   [异常检测](https://www.pycaret.org/anomaly-detection)

+   [自然语言处理](https://www.pycaret.org/nlp)

+   [关联规则挖掘](https://www.pycaret.org/association-rules)

### 另见：

PyCaret 入门教程在 Notebook 中：

+   [聚类分析](https://www.pycaret.org/clu101)

+   [异常检测](https://www.pycaret.org/anom101)

+   [自然语言处理](https://www.pycaret.org/nlp101)

+   [关联规则挖掘](https://www.pycaret.org/arul101)

+   [回归分析](https://www.pycaret.org/reg101)

+   [分类](https://www.pycaret.org/clf101)

### 你想贡献吗？

PyCaret 是一个开源项目。欢迎大家贡献。如果你想贡献，请随时处理[公开问题](https://github.com/pycaret/pycaret/issues)。拉取请求需在 dev-1.0.1 分支上附带单元测试。

如果你喜欢 PyCaret，请在我们的 [GitHub 仓库](https://www.github.com/pycaret/pycaret) 上给我们 ⭐️。

Medium : [https://medium.com/@moez_62905/](https://medium.com/@moez_62905/machine-learning-in-power-bi-using-pycaret-34307f09394a)

LinkedIn : [https://www.linkedin.com/in/profile-moez/](https://www.linkedin.com/in/profile-moez/)

Twitter : [https://twitter.com/moezpycaretorg1](https://twitter.com/moezpycaretorg1)

**简介： [Moez Ali](https://www.linkedin.com/in/profile-moez/)** 是数据科学家，PyCaret 的创始人及作者。

[原文](https://towardsdatascience.com/deploy-machine-learning-pipeline-on-cloud-using-docker-container-bec64458dc01)。已获授权转载。

**相关内容：**

+   [宣布 PyCaret 1.0.0](/2020/04/announcing-pycaret.html)

+   [构建和部署你的第一个机器学习 Web 应用](/2020/05/build-deploy-machine-learning-web-app.html)

+   [在 Power BI 中使用 PyCaret 进行机器学习](/2020/05/machine-learning-power-bi-pycaret.html)

* * *

## 我们的三大课程推荐

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 1\. [Google 网络安全证书](https://www.kdnuggets.com/google-cybersecurity) - 快速进入网络安全职业生涯。

![](../Images/e225c49c3c91745821c8c0368bf04711.png) 2\. [Google 数据分析专业证书](https://www.kdnuggets.com/google-data-analytics) - 提升你的数据分析能力

![](../Images/0244c01ba9267c002ef39d4907e0b8fb.png) 3\. [Google IT 支持专业证书](https://www.kdnuggets.com/google-itsupport) - 支持你的组织的 IT

* * *

### 更多相关内容

+   [2024 年十大云容器管理解决方案](https://www.kdnuggets.com/the-top-8-cloud-container-management-solutions-of-2024)

+   [调查：机器学习项目仍然经常无法部署](https://www.kdnuggets.com/survey-machine-learning-projects-still-routinely-fail-to-deploy)

+   [使用 Heroku 部署机器学习 Web 应用](https://www.kdnuggets.com/2022/04/deploy-machine-learning-web-app-heroku.html)

+   [如何成功部署数据科学项目](https://www.kdnuggets.com/2022/01/successfully-deploy-data-science-projects.html)

+   [了解如何设计和部署负责任的 AI 系统](https://www.kdnuggets.com/2023/10/teradata-design-deploy-responsible-ai-systems-whitepaper)

+   [了解如何设计和部署负责任的 AI 系统](https://www.kdnuggets.com/2023/11/teradata-design-deploy-responsible-ai-systems-whitepaper)
